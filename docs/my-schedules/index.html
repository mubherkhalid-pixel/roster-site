<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>My Schedule</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#f0f4ff;--card:#fff;--text:#0f172a;--muted:#64748b;
      --border:#e5e7eb;--b1:#1e73ff;--b2:#00b3ff;--b3:#2b59ff;--r:14px;
    }
    body{
      font-family:'Segoe UI',system-ui,sans-serif;
      background:radial-gradient(ellipse 120% 40% at 50% 0%,rgba(30,115,255,.15),transparent 60%),
                 linear-gradient(180deg,var(--bg),#fff 70%);
      min-height:100vh;padding:8px;color:var(--text);font-size:14px;
    }
    .wrap{max-width:520px;margin:0 auto;display:flex;flex-direction:column;gap:8px}

    .hero{
      background:linear-gradient(135deg,var(--b3),var(--b2));
      border-radius:var(--r);padding:11px 13px;position:relative;overflow:hidden;
    }
    .hero::before{
      content:"";position:absolute;top:-40px;right:-40px;
      width:130px;height:130px;border-radius:50%;background:rgba(255,255,255,.12);
    }
    .hero-row{position:relative;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .brand{display:flex;align-items:center;gap:9px}
    .logo{
      width:36px;height:36px;border-radius:10px;
      background:rgba(255,255,255,.22);border:1px solid rgba(255,255,255,.25);
      display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;
    }
    .brand-text h1{color:#fff;font-size:15px;font-weight:800;line-height:1.2}
    .brand-text p{color:rgba(255,255,255,.85);font-size:11px;font-weight:600}
    .hero-btns{display:flex;gap:6px;align-items:center}
    .lang-btn,.back-btn{
      background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);
      color:#fff;border-radius:8px;padding:5px 10px;
      font-size:11px;font-weight:700;cursor:pointer;transition:background .2s;white-space:nowrap;
    }
    .lang-btn:hover,.back-btn:hover{background:rgba(255,255,255,.3)}

    .card{
      background:var(--card);border-radius:var(--r);
      box-shadow:0 4px 20px rgba(2,6,23,.07);border:1px solid var(--border);overflow:hidden;
    }
    .search-area{
      padding:10px 12px;background:linear-gradient(180deg,#fff,#fbfcff);
      border-bottom:1px solid var(--border);
    }
    .search-row{display:flex;gap:7px}
    .search-input{
      flex:1;min-width:0;padding:9px 12px;border:1.5px solid var(--border);
      border-radius:10px;font-size:14px;direction:ltr;background:#fff;
      transition:border-color .2s,box-shadow .2s;
    }
    .search-input:focus{outline:none;border-color:rgba(30,115,255,.7);box-shadow:0 0 0 3px rgba(30,115,255,.1)}
    .search-btn{
      padding:9px 14px;background:linear-gradient(135deg,var(--b3),var(--b2));
      color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:800;
      cursor:pointer;transition:transform .2s,box-shadow .2s;white-space:nowrap;
    }
    .search-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(30,115,255,.28)}

    .content{padding:10px}
    .empty-state{text-align:center;padding:30px 16px;color:var(--muted)}
    .empty-icon{font-size:38px;margin-bottom:8px}
    .empty-state h3{font-size:15px;margin-bottom:4px;color:var(--text)}
    .empty-state p{font-size:12px}

    .emp-bar{
      background:linear-gradient(135deg,var(--b3),var(--b2));color:#fff;
      border-radius:10px;padding:9px 11px;margin-bottom:8px;
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      box-shadow:0 4px 14px rgba(30,115,255,.2);
    }
    .emp-info h2{font-size:14px;font-weight:800;line-height:1.3}
    .emp-info p{font-size:11px;opacity:.9;margin-top:2px}
    .month-nav{display:flex;align-items:center;gap:6px;flex-shrink:0}
    .month-nav button{
      width:30px;height:30px;border-radius:50%;
      background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);
      color:#fff;font-size:15px;cursor:pointer;transition:background .2s;
      display:flex;align-items:center;justify-content:center;
    }
    .month-nav button:hover{background:rgba(255,255,255,.3)}
    .month-nav span{font-size:12px;font-weight:800;min-width:86px;text-align:center}

    /* CALENDAR */
    .calendar{
      background:#fff;border-radius:10px;border:1px solid var(--border);
      overflow:hidden;margin-bottom:8px;
    }
    .cal-head{
      display:grid;grid-template-columns:repeat(7,1fr);
      background:#f8fafc;border-bottom:1.5px solid var(--border);
    }
    .cal-head div{padding:7px 2px;text-align:center;font-weight:800;color:#475569;font-size:10px}
    .cal-body{display:grid;grid-template-columns:repeat(7,1fr)}

    .cal-day{
      border:1px solid #f0f0f0;padding:4px 2px;background:#fff;
      min-height:54px;display:flex;flex-direction:column;align-items:center;
    }
    .cal-day.empty{background:#fafafa}
    .cal-day.today{}

    /* coloured top strip per shift â€” no text at all */
    .cal-day.s-morning  {border-top:3px solid #f59e0b}
    .cal-day.s-afternoon{border-top:3px solid #f97316}
    .cal-day.s-night    {border-top:3px solid #7c3aed}
    .cal-day.s-off      {border-top:3px solid #94a3b8}
    .cal-day.s-leave    {border-top:3px solid #22c55e}
    .cal-day.s-training {border-top:3px solid #3b82f6}
    .cal-day.s-standby  {border-top:3px solid #ec4899}
    .cal-day.s-other    {border-top:3px solid #9ca3af}

    .d-num{font-size:12px;font-weight:900;color:#0f172a;margin-bottom:1px;margin-top:1px}
    .d-icon{font-size:16px;line-height:1;margin:2px 0}
    .d-code{font-size:9px;color:var(--muted);font-weight:800;margin-top:2px;background:#f1f5f9;border-radius:4px;padding:1px 4px}

    /* LEGEND */
    .legend{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px}
    .leg-item{display:flex;align-items:center;gap:4px;font-size:10px;font-weight:700;color:var(--muted)}
    .leg-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

    /* STATS */
    .stats{background:#f8fafc;border-radius:10px;border:1px solid var(--border);padding:8px;margin-bottom:8px}
    .stats-title{font-size:10px;font-weight:800;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
    .stats-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
    @media(max-width:380px){.stats-grid{grid-template-columns:repeat(4,1fr)}}
    .stat-box{background:#fff;border:1px solid var(--border);border-radius:7px;padding:6px 4px;text-align:center}
    .stat-lbl{font-size:9px;color:var(--muted);font-weight:700;margin-bottom:3px}
    .stat-val{font-size:17px;font-weight:900;color:var(--text);line-height:1}

    /* ACTIONS */
    .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
    .act-btn{
      padding:8px 6px;border:1.5px solid var(--border);background:#fff;
      border-radius:9px;font-size:11px;font-weight:800;cursor:pointer;transition:all .2s;
      display:flex;align-items:center;justify-content:center;gap:5px;white-space:nowrap;
    }
    .act-btn:hover{border-color:rgba(30,115,255,.5);color:var(--b1);transform:translateY(-1px)}
    .act-primary{background:linear-gradient(135deg,var(--b3),var(--b2));color:#fff;border-color:transparent}
    .act-primary:hover{color:#fff;border-color:transparent;box-shadow:0 6px 18px rgba(30,115,255,.26)}
    .act-ics{background:#f0fdf4;border-color:#86efac;color:#166534}
    .act-ics:hover{background:#dcfce7;border-color:#4ade80;color:#166534;transform:translateY(-1px)}
    .act-img{background:#fdf4ff;border-color:#d8b4fe;color:#7e22ce}
    .act-img:hover{background:#f5e8ff;border-color:#c084fc;color:#7e22ce;transform:translateY(-1px)}

    .loading{text-align:center;padding:30px 16px;color:var(--muted)}
    .spinner{width:32px;height:32px;border:3px solid #e5e7eb;border-top-color:var(--b1);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading p{font-size:12px}

    @media print{
      body{background:#fff;padding:0}
      .hero,.search-area,.actions,.back-btn,.lang-btn{display:none!important}
      .wrap{max-width:100%}
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="hero">
    <div class="hero-row">
      <div class="brand">
        <div class="logo">ğŸ“…</div>
        <div class="brand-text">
          <h1 id="ttl">My Schedule</h1>
          <p id="sub">Enter your Employee ID to view schedule</p>
        </div>
      </div>
      <div class="hero-btns">
        <button class="lang-btn" onclick="toggleLang()">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
        <button class="back-btn" onclick="goBack()">â† Back</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="search-area">
      <form class="search-row" id="searchForm">
        <input type="text" class="search-input" id="empId"
          placeholder="Employee ID (e.g. 12345)" pattern="[0-9]+" required>
        <button type="submit" class="search-btn" id="sbtn">ğŸ“… View</button>
      </form>
    </div>
    <div class="content" id="area">
      <div class="empty-state">
        <div class="empty-icon">ğŸ”</div>
        <h3 id="e1">Search your schedule</h3>
        <p id="e2">Enter your Employee ID above</p>
      </div>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let data=null,month=null,months=[],lang='en';

const COLORS={
  Morning:     {strip:'#f59e0b',icon:'â˜€ï¸'},
  Afternoon:   {strip:'#f97316',icon:'ğŸŒ¤ï¸'},
  Night:       {strip:'#7c3aed',icon:'ğŸŒ™'},
  'Off Day':   {strip:'#94a3b8',icon:'ğŸ›Œ'},
  'Annual Leave':{strip:'#22c55e',icon:'âœˆï¸'},
  'Sick Leave':{strip:'#22c55e',icon:'ğŸ¤’'},
  Training:    {strip:'#3b82f6',icon:'ğŸ“š'},
  Standby:     {strip:'#ec4899',icon:'ğŸ§'},
  Other:       {strip:'#9ca3af',icon:'â“'}
};

const T={
  en:{
    title:'My Schedule',sub:'Enter your Employee ID to view schedule',
    back:'â† Back',langBtn:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
    ph:'Employee ID (e.g. 12345)',sbtn:'ğŸ“… View',
    e1:'Search your schedule',e2:'Enter your Employee ID above',
    loading:'Loading...',notFound:'Employee not found',
    notFoundSub:'ID not in the system. Please check and try again.',
    statsTitle:'STATISTICS',
    workDays:'Work',offDays:'Off',morning:'â˜€ï¸',afternoon:'ğŸŒ¤ï¸',night:'ğŸŒ™',standby:'ğŸ§',leaves:'Leaves',
    pdf:'ğŸ“¥ PDF',img:'ğŸ–¼ï¸ Image',share:'ğŸ”— Share',print:'ğŸ–¨ï¸ Print',ics:'ğŸ“† ICS',
    days:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
    months:['January','February','March','April','May','June',
            'July','August','September','October','November','December'],
    legend:{Morning:'Morning',Afternoon:'Afternoon',Night:'Night',
            'Off Day':'Off','Annual Leave':'Leave','Sick Leave':'Sick',
            Training:'Training',Standby:'Standby',Other:'Other'}
  },
  ar:{
    title:'Ø¬Ø¯ÙˆÙ„ÙŠ',sub:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„',
    back:'Ø±Ø¬ÙˆØ¹ â†',langBtn:'English',
    ph:'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ (Ù…Ø«Ø§Ù„: 12345)',sbtn:'ğŸ“… Ø¹Ø±Ø¶',
    e1:'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¬Ø¯ÙˆÙ„Ùƒ',e2:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø£Ø¹Ù„Ø§Ù‡',
    loading:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...',notFound:'Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù',
    notFoundSub:'Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ØªØ­Ù‚Ù‚ ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.',
    statsTitle:'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',
    workDays:'Ø¹Ù…Ù„',offDays:'Ø¥Ø¬Ø§Ø²Ø©',morning:'â˜€ï¸',afternoon:'ğŸŒ¤ï¸',night:'ğŸŒ™',standby:'ğŸ§',leaves:'Ø³Ù†ÙˆÙŠØ©',
    pdf:'ğŸ“¥ PDF',img:'ğŸ–¼ï¸ ØµÙˆØ±Ø©',share:'ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©',print:'ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©',ics:'ğŸ“† ICS',
    days:['Ø§Ù„Ø£Ø­','Ø§Ù„Ø§Ø«','Ø§Ù„Ø«Ù„','Ø§Ù„Ø£Ø±','Ø§Ù„Ø®Ù…','Ø§Ù„Ø¬Ù…','Ø§Ù„Ø³Ø¨'],
    months:['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ',
            'ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'],
    legend:{Morning:'ØµØ¨Ø§Ø­ÙŠ',Afternoon:'Ù…Ø³Ø§Ø¦ÙŠ',Night:'Ù„ÙŠÙ„ÙŠ',
            'Off Day':'Ø¥Ø¬Ø§Ø²Ø©','Annual Leave':'Ø³Ù†ÙˆÙŠØ©','Sick Leave':'Ù…Ø±Ø¶ÙŠØ©',
            Training:'ØªØ¯Ø±ÙŠØ¨',Standby:'Ø§Ø­ØªÙŠØ§Ø·ÙŠ',Other:'Ø£Ø®Ø±Ù‰'}
  }
};

function t(k){return T[lang][k]}

function applyLangUI(){
  document.documentElement.lang=lang;
  document.documentElement.dir=lang==='ar'?'rtl':'ltr';
  document.getElementById('ttl').textContent=t('title');
  document.getElementById('sub').textContent=t('sub');
  document.querySelector('.back-btn').textContent=t('back');
  document.querySelector('.lang-btn').textContent=t('langBtn');
  document.getElementById('empId').placeholder=t('ph');
  document.getElementById('sbtn').textContent=t('sbtn');
  const e1=document.getElementById('e1'),e2=document.getElementById('e2');
  if(e1) e1.textContent=t('e1');
  if(e2) e2.textContent=t('e2');
  if(data) renderSchedule();
}
function toggleLang(){lang=lang==='en'?'ar':'en';applyLangUI()}

function goBack(){
  const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
  if(document.referrer&&document.referrer.includes(location.host)) history.back();
  else location.href=base;
}

document.getElementById('searchForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const id=document.getElementById('empId').value.trim();
  if(id) await loadSchedule(id);
});

async function loadSchedule(id){
  document.getElementById('area').innerHTML=
    `<div class="loading"><div class="spinner"></div><p>${t('loading')}</p></div>`;
  try{
    const res=await fetch(`../schedules/${id}.json`);
    if(!res.ok) throw new Error();
    data=await res.json();
    months=Object.keys(data.schedules).sort().reverse();
    if(!months.length) throw new Error();
    month=months[0];
    renderSchedule();
  }catch{
    document.getElementById('area').innerHTML=`
      <div class="empty-state">
        <div class="empty-icon">âŒ</div>
        <h3>${t('notFound')}</h3>
        <p>${t('notFoundSub')}</p>
      </div>`;
  }
}

function renderSchedule(){
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const mName=T[lang].months[mo-1];
  const ci=months.indexOf(month);
  const hasNext=ci>0,hasPrev=ci<months.length-1;

  const firstDow=new Date(yr,mo-1,1).getDay();
  const daysInMonth=new Date(yr,mo,0).getDate();
  const stats=calcStats(sched);

  /* Calendar cells: ICON + CODE only â€” zero text labels */
  let cells='',dc=1;
  for(let w=0;w<6;w++){
    for(let d=0;d<7;d++){
      if((w===0&&d<firstDow)||dc>daysInMonth){
        cells+='<div class="cal-day empty"></div>';
      }else{
        const dd=sched.find(s=>s.day===dc);
        const today=isToday(yr,mo,dc);
        if(dd){
          const sc=shiftClass(dd.shift_group);
          const icon=COLORS[dd.shift_group]?.icon||'â“';
          cells+=`<div class="cal-day ${sc}">
            <div class="d-num">${dc}</div>
            <div class="d-icon">${icon}</div>
            ${dd.shift_code?`<div class="d-code">${esc(dd.shift_code)}</div>`:''}
          </div>`;
        }else{
          cells+=`<div class="cal-day"><div class="d-num">${dc}</div></div>`;
        }
        dc++;
      }
    }
    if(dc>daysInMonth) break;
  }

  const dayHdr=T[lang].days.map(d=>`<div>${d}</div>`).join('');

  /* Legend */
  const used=[...new Set(sched.map(s=>s.shift_group))];
  const legHTML=used.map(g=>{
    const c=COLORS[g];if(!c) return '';
    return `<span class="leg-item"><span class="leg-dot" style="background:${c.strip}"></span>${T[lang].legend[g]||g}</span>`;
  }).join('');

  document.getElementById('area').innerHTML=`
    <div class="emp-bar">
      <div class="emp-info">
        <h2>${esc(data.name)}</h2>
        <p>ğŸ“‹ ${esc(data.department)} &nbsp;â€¢&nbsp; ğŸ†” ${esc(data.id)}</p>
      </div>
      <div class="month-nav">
        <button onclick="chMonth(-1)" ${!hasPrev?'disabled style="opacity:.35;cursor:default"':''}>&lt;</button>
        <span>${mName} ${yr}</span>
        <button onclick="chMonth(1)" ${!hasNext?'disabled style="opacity:.35;cursor:default"':''}>&gt;</button>
      </div>
    </div>

    <div class="calendar">
      <div class="cal-head">${dayHdr}</div>
      <div class="cal-body">${cells}</div>
    </div>

    <div class="legend">${legHTML}</div>

    <div class="stats">
      <div class="stats-title">${t('statsTitle')}</div>
      <div class="stats-grid">
        <div class="stat-box"><div class="stat-lbl">${t('workDays')}</div><div class="stat-val">${stats.work}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('offDays')}</div><div class="stat-val">${stats.off}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('morning')}</div><div class="stat-val">${stats.morning}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('afternoon')}</div><div class="stat-val">${stats.afternoon}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('night')}</div><div class="stat-val">${stats.night}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('standby')}</div><div class="stat-val">${stats.standby}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('leaves')}</div><div class="stat-val">${stats.leaves}</div></div>
      </div>
    </div>

    <div class="actions">
      <button class="act-btn act-primary" onclick="dlPDF()">${t('pdf')}</button>
      <button class="act-btn act-ics" onclick="dlICS()">${t('ics')}</button>
      <button class="act-btn act-img" onclick="dlIMG()">${t('img')}</button>
      <button class="act-btn" onclick="shareS()">${t('share')}</button>
      <button class="act-btn" onclick="window.print()">${t('print')}</button>
    </div>
  `;
}

function chMonth(dir){
  const ci=months.indexOf(month),ni=ci-dir;
  if(ni>=0&&ni<months.length){month=months[ni];renderSchedule()}
}

function calcStats(s){
  const r={work:0,off:0,morning:0,afternoon:0,night:0,standby:0,leaves:0};
  s.forEach(d=>{
    if(d.shift_group==='Morning') r.morning++;
    else if(d.shift_group==='Afternoon') r.afternoon++;
    else if(d.shift_group==='Night') r.night++;
    else if(d.shift_group==='Off Day') r.off++;
    else if(d.shift_group==='Standby') r.standby++;
    else if(d.shift_group==='Annual Leave'||d.shift_group==='Sick Leave') r.leaves++;
  });
  r.work=r.morning+r.afternoon+r.night;
  return r;
}

function shiftClass(g){
  return{Morning:'s-morning',Afternoon:'s-afternoon',Night:'s-night',
         'Off Day':'s-off','Annual Leave':'s-leave','Sick Leave':'s-leave',
         Training:'s-training',Standby:'s-standby',Other:'s-other'}[g]||'s-other';
}
function isToday(y,m,d){
  const n=new Date();
  return n.getFullYear()===y&&n.getMonth()+1===m&&n.getDate()===d;
}
function esc(s){
  return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* â”€â”€ IMAGE DOWNLOAD â”€â”€ */
async function dlIMG(){
  const calEl=document.querySelector('.calendar');
  const empBar=document.querySelector('.emp-bar');
  const statsEl=document.querySelector('.stats');
  const legendEl=document.querySelector('.legend');

  if(!calEl){alert('No calendar to capture.');return}

  // Build a clean snapshot container
  const wrap=document.createElement('div');
  wrap.style.cssText=`
    position:fixed;left:-9999px;top:0;
    background:#fff;padding:16px;border-radius:16px;
    font-family:'Segoe UI',system-ui,sans-serif;
    width:${calEl.offsetWidth+32}px;
  `;

  // Clone elements into snapshot
  const cloneEmp=empBar?empBar.cloneNode(true):null;
  const cloneCal=calEl.cloneNode(true);
  const cloneLeg=legendEl?legendEl.cloneNode(true):null;
  const cloneSt=statsEl?statsEl.cloneNode(true):null;

  if(cloneEmp){cloneEmp.style.marginBottom='10px';wrap.appendChild(cloneEmp);}
  wrap.appendChild(cloneCal);
  if(cloneLeg){cloneLeg.style.marginTop='8px';wrap.appendChild(cloneLeg);}
  if(cloneSt){cloneSt.style.marginTop='8px';wrap.appendChild(cloneSt);}

  document.body.appendChild(wrap);

  try{
    const canvas=await html2canvas(wrap,{
      scale:3,
      useCORS:true,
      backgroundColor:'#ffffff',
      logging:false
    });
    const link=document.createElement('a');
    link.download=`schedule-${data.id}-${month}.png`;
    link.href=canvas.toDataURL('image/png');
    link.click();
  }catch(e){
    alert('Image capture failed: '+e.message);
  }finally{
    document.body.removeChild(wrap);
  }
}

/* â”€â”€ ICS â”€â”€ */
function dlICS(){
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const pad=n=>String(n).padStart(2,'0');
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//MySchedule//EN','CALSCALE:GREGORIAN'];
  sched.forEach(d=>{
    const dt=`${yr}${pad(mo)}${pad(d.day)}`;
    const dtNext=new Date(yr,mo-1,d.day+1);
    const dtE=`${dtNext.getFullYear()}${pad(dtNext.getMonth()+1)}${pad(dtNext.getDate())}`;
    const sum=d.shift_code||d.shift_group;
    lines.push('BEGIN:VEVENT',
      `DTSTART;VALUE=DATE:${dt}`,
      `DTEND;VALUE=DATE:${dtE}`,
      `SUMMARY:${sum}`,
      `UID:${dt}-${data.id}-${d.day}@myschedule`,
      'END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  const blob=new Blob([lines.join('\r\n')],{type:'text/calendar'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`schedule-${data.id}-${month}.ics`;
  a.click();URL.revokeObjectURL(a.href);
}

/* â”€â”€ PDF â”€â”€ Premium A4 Editorial Design â”€â”€ */
function dlPDF(){
  if(!window.jspdf){alert('PDF library loading, please try again.');return}
  const {jsPDF}=window.jspdf;

  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210, H=297, ML=7, MR=7;
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const mName=T.en.months[mo-1];
  const stats=calcStats(sched);

  // â”€â”€ Shift colour system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SC={
    Morning:        {fg:[200, 90,  0], bg:[255,243,224]},
    Afternoon:      {fg:[180, 45,  5], bg:[255,235,218]},
    Night:          {fg:[ 20, 55,190], bg:[224,230,255]},
    'Off Day':      {fg:[ 85, 95,115], bg:[238,240,245]},
    'Annual Leave': {fg:[ 10,125, 60], bg:[218,248,230]},
    'Sick Leave':   {fg:[ 10,125, 60], bg:[218,248,230]},
    Training:       {fg:[ 10, 85,190], bg:[218,238,255]},
    Standby:        {fg:[148, 10,110], bg:[250,218,242]},
    Other:          {fg:[ 90,100,115], bg:[240,241,246]}
  };
  const FALLBACK={
    'Off Day':'OFF','Annual Leave':'LV','Sick Leave':'SL',
    Training:'TR',Standby:'ST',Other:'â€”'
  };
  const LNAMES={
    Morning:'Morning',Afternoon:'Afternoon',Night:'Night',
    'Off Day':'Day Off','Annual Leave':'Leave','Sick Leave':'Sick',
    Training:'Training',Standby:'Standby',Other:'Other'
  };

  const NAVY =[15,25,70];
  const WHITE=[255,255,255];
  const RULE =[195,202,215];
  const EMPTY=[244,245,249];
  const INK  =[18,24,44];
  const DIM  =[105,115,132];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FIXED LAYOUT â€” calculate all Y positions upfront
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const HDR_H   = 30;   // header
  const CAL_HDR = 9;    // day-names row
  const STATS_H = 42;   // stats section (cards + legend)
  const FOOT_H  = 10;   // footer
  const GAP1    = 3;    // gap headerâ†’calendar
  const GAP2    = 4;    // gap calendarâ†’stats

  const CAL_TOP  = HDR_H + GAP1;                         // calendar starts here
  const STATS_TOP= H - FOOT_H - GAP2 - STATS_H;         // stats FIXED to bottom
  const CAL_BOT  = STATS_TOP - GAP2;                     // calendar ends here
  const CAL_BODY = CAL_BOT - CAL_TOP - CAL_HDR;         // usable cell area

  // Count calendar rows
  const firstDow    = new Date(yr,mo-1,1).getDay();
  const dim         = new Date(yr,mo,0).getDate();
  const now         = new Date();
  const thisMo      = now.getFullYear()===yr && now.getMonth()+1===mo;
  let nRows=0;
  {let d2=1;
   for(let w=0;w<6;w++){
     let any=false;
     for(let d=0;d<7;d++) if(!((w===0&&d<firstDow)||d2>dim)){any=true;d2++;}
     if(any) nRows++;
     if(d2>dim) break;
   }
  }
  const CH = Math.floor(CAL_BODY / nRows);   // cell height
  const CW = (W-ML-MR)/7;                    // cell width

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  1. HEADER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  doc.setFillColor(...NAVY);
  doc.rect(0,0,W,HDR_H,'F');

  doc.setTextColor(...WHITE);
  doc.setFontSize(17);doc.setFont(undefined,'bold');
  doc.text(String(data.name), ML, 13);

  doc.setFontSize(8.5);doc.setFont(undefined,'normal');
  doc.setTextColor(165,188,235);
  doc.text(`${data.department}   Â·   ID: ${data.id}`, ML, 21);

  // Month pill right
  doc.setFillColor(...WHITE);
  doc.roundedRect(W-MR-55, 9, 55, 14, 3, 3, 'F');
  doc.setTextColor(...NAVY);
  doc.setFontSize(10.5);doc.setFont(undefined,'bold');
  doc.text(`${mName}  ${yr}`, W-MR-27.5, 18, {align:'center'});

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  2. CALENDAR  (fixed between CAL_TOP and STATS_TOP)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Day-name header
  doc.setFillColor(...NAVY);
  doc.rect(ML, CAL_TOP, W-ML-MR, CAL_HDR, 'F');
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach((d,i)=>{
    doc.setTextColor(...WHITE);
    doc.setFontSize(8.5);doc.setFont(undefined,'bold');
    doc.text(d, ML+i*CW+CW/2, CAL_TOP+6.3, {align:'center'});
  });

  let dc=1, row=0;
  doc.setLineWidth(0.22);

  for(let w=0;w<6;w++){
    for(let d=0;d<7;d++){
      const cx = ML+d*CW;
      const cy = CAL_TOP+CAL_HDR+row*CH;
      const isEmpty=(w===0&&d<firstDow)||dc>dim;

      if(isEmpty){
        doc.setFillColor(...EMPTY);
        doc.setDrawColor(...RULE);
        doc.rect(cx,cy,CW,CH,'FD');
        continue;
      }

      const dd     = sched.find(s=>s.day===dc);
      const isToday= thisMo && now.getDate()===dc;
      const sh     = dd ? (SC[dd.shift_group]||SC.Other) : null;

      // Cell background â€” tinted
      doc.setFillColor(...(sh ? sh.bg : WHITE));
      doc.setDrawColor(...RULE);
      doc.rect(cx,cy,CW,CH,'FD');

      // Today highlight removed â€” clean export

      // â”€â”€ Day number â€” huge, semi-transparent watermark style â”€
      // Blend shift colour into a big ghost number: draw it in
      // the bg colour darkened slightly so it reads as a large
      // transparent numeral sitting behind the code text.
      const numStr = String(dc);

      // Pick ghost colour: lighter blend of shift fg with cell bg
      let ghostR, ghostG, ghostB;
      if(sh){
        // Mix fg 30% over bg â†’ a muted, semi-visible tint
        ghostR = Math.round(sh.bg[0]*0.55 + sh.fg[0]*0.45);
        ghostG = Math.round(sh.bg[1]*0.55 + sh.fg[1]*0.45);
        ghostB = Math.round(sh.bg[2]*0.55 + sh.fg[2]*0.45);
      } else {
        ghostR=210; ghostG=215; ghostB=225;
      }



      // LARGE ghost number â€” anchored top-left of cell
      const ghostSize = Math.round(CH * 0.72);  // ~72% of cell height
      doc.setTextColor(ghostR, ghostG, ghostB);
      doc.setFontSize(ghostSize > 38 ? 38 : ghostSize < 22 ? 22 : ghostSize);
      doc.setFont(undefined,'bold');
      // Position: slight inset from top-left, baseline a bit down
      doc.text(numStr, cx + 2.5, cy + ghostSize * 0.72, {align:'left'});



      doc.setDrawColor(...RULE);

      // Shift code â€” centred, very big, strong colour
      if(dd){
        const code=dd.shift_code||(FALLBACK[dd.shift_group]||'');
        if(code){
          const fs = CH>=36 ? 20 : CH>=28 ? 18 : 15;
          doc.setTextColor(...sh.fg);
          doc.setFontSize(fs);
          doc.setFont(undefined,'bold');
          doc.text(code, cx+CW/2, cy+CH*0.67, {align:'center'});
        }
      }
      dc++;
    }
    if(dc>dim) break;
    row++;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  3. STATISTICS  (fixed at STATS_TOP â€” never overlaps cal)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // separator line
  doc.setDrawColor(...RULE);
  doc.setLineWidth(0.3);
  doc.line(ML, STATS_TOP, W-MR, STATS_TOP);

  // Section title
  doc.setTextColor(...NAVY);
  doc.setFontSize(8);doc.setFont(undefined,'bold');
  doc.text('STATISTICS', ML, STATS_TOP+5);

  // 7 stat cards
  const SL=[
    {l:'Work Days', v:stats.work,      c:NAVY},
    {l:'Day Off',   v:stats.off,       c:[85,95,115]},
    {l:'Morning',   v:stats.morning,   c:[200,90,0]},
    {l:'Afternoon', v:stats.afternoon, c:[180,45,5]},
    {l:'Night',     v:stats.night,     c:[20,55,190]},
    {l:'Standby',   v:stats.standby,   c:[148,10,110]},
    {l:'Leaves',    v:stats.leaves,    c:[10,125,60]}
  ];
  const nSt=SL.length, SGAP=2;
  const sW=(W-ML-MR-(nSt-1)*SGAP)/nSt;
  const CARD_Y=STATS_TOP+7;
  const CARD_H=22;

  SL.forEach(({l,v,c},i)=>{
    const sx=ML+i*(sW+SGAP);
    doc.setFillColor(247,248,253);
    doc.setDrawColor(...RULE);
    doc.setLineWidth(0.2);
    doc.roundedRect(sx,CARD_Y,sW,CARD_H,2,2,'FD');
    // colour top bar
    doc.setFillColor(...c);
    doc.roundedRect(sx,CARD_Y,sW,3,1,1,'F');
    // number â€” coloured, large
    doc.setTextColor(...c);
    doc.setFontSize(18);doc.setFont(undefined,'bold');
    doc.text(String(v), sx+sW/2, CARD_Y+15, {align:'center'});
    // label
    doc.setTextColor(...DIM);
    doc.setFontSize(5.8);doc.setFont(undefined,'bold');
    doc.text(l, sx+sW/2, CARD_Y+20.5, {align:'center'});
  });

  // Legend â€” shift colour chips
  const LY=CARD_Y+CARD_H+3;
  const used=[...new Set(sched.map(s=>s.shift_group))];
  const lStep=(W-ML-MR)/used.length;
  used.forEach((g,i)=>{
    const sh2=SC[g]||SC.Other;
    const lx=ML+i*lStep;
    // coloured chip
    doc.setFillColor(...sh2.bg);
    doc.setDrawColor(...sh2.fg);
    doc.setLineWidth(0.5);
    doc.roundedRect(lx, LY, lStep-2, 6, 1.5, 1.5, 'FD');
    doc.setTextColor(...sh2.fg);
    doc.setFontSize(6.5);doc.setFont(undefined,'bold');
    doc.text(LNAMES[g]||g, lx+(lStep-2)/2, LY+4.1, {align:'center'});
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  4. FOOTER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  doc.setDrawColor(...RULE);
  doc.setLineWidth(0.25);
  doc.line(ML,H-6,W-MR,H-6);
  doc.setTextColor(...DIM);
  doc.setFontSize(7);doc.setFont(undefined,'normal');
  doc.text('My Schedule', ML, H-2.5);
  doc.text(`${mName} ${yr}  Â·  ${data.id}`, W-MR, H-2.5, {align:'right'});

  doc.save(`schedule-${data.id}-${month}.pdf`);
}

/* â”€â”€ SHARE â”€â”€ */
function shareS(){
  const id=data.id;
  const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
  const url=`${location.origin}${base}my-schedule/?emp=${encodeURIComponent(id)}`;
  if(navigator.share) navigator.share({title:'My Schedule',text:`Schedule: ${data.name}`,url});
  else{navigator.clipboard.writeText(url);alert('Link copied!');}
}

const p=new URLSearchParams(location.search).get('emp');
if(p){document.getElementById('empId').value=p;loadSchedule(p);}
</script>
</body>
</html>
