<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>My Schedule</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* â”€â”€ RESET â”€â”€ */
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    :root{
      --bg:#0d1117;
      --surface:#161b22;
      --surface2:#1c2330;
      --surface3:#21262d;
      --border:rgba(255,255,255,.08);
      --border2:rgba(255,255,255,.12);
      --ink:#e6edf3;
      --muted:#8b949e;
      --dim:#484f58;
      --accent:#58a6ff;
      --accent2:#3fb950;
      --amber:#d29922;
      --orange:#db6d28;
      --purple:#bc8cff;
      --pink:#ff7b72;
      --cyan:#39d353;
      --r:12px;
      --r-lg:18px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
    }
    body.light{
      --bg:#f5f7fa;
      --surface:#ffffff;
      --surface2:#f0f2f5;
      --surface3:#e8ebf0;
      --border:rgba(0,0,0,.08);
      --border2:rgba(0,0,0,.13);
      --ink:#1a1f2e;
      --muted:#6b7280;
      --dim:#9ca3af;
      --accent:#1d6fd4;
    }

    html{background:var(--bg); color:var(--ink); font-size:15px; scroll-behavior:smooth}
    body{
      font-family:'Sora', system-ui, -apple-system, sans-serif;
      background:var(--bg);
      min-height:100dvh;
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
      transition:background .2s, color .2s;
    }
    body.ar{direction:rtl}
    a{color:var(--accent);text-decoration:none}
    button,input,select{font-family:inherit;font-size:inherit}
    button{cursor:pointer}

    /* â”€â”€ TOPBAR â”€â”€ */
    .topbar{
      position:sticky;top:0;z-index:100;
      padding-top:var(--safe-top);
      background:rgba(13,17,23,.92);
      backdrop-filter:blur(20px) saturate(180%);
      -webkit-backdrop-filter:blur(20px) saturate(180%);
      border-bottom:1px solid var(--border);
      transition:background .2s;
    }
    body.light .topbar{background:rgba(245,247,250,.92)}
    .topbar-inner{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 16px;
      gap:12px;
      max-width:700px;margin:0 auto;
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand-icon{
      width:38px;height:38px;border-radius:10px;
      background:linear-gradient(135deg,#1f6feb,#388bfd);
      display:grid;place-items:center;
      font-size:18px;
      flex:0 0 auto;
      box-shadow:0 0 0 1px rgba(56,139,253,.3),0 4px 12px rgba(31,111,235,.4);
    }
    .brand-info{min-width:0}
    .brand-name{font-size:14px;font-weight:700;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand-sub{font-size:11px;color:var(--muted);font-weight:500;white-space:nowrap}
    .top-btns{display:flex;gap:6px;flex:0 0 auto}
    .ghost-btn{
      height:34px;padding:0 12px;
      border:1px solid var(--border2);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      border-radius:8px;
      font-size:12px;font-weight:600;
      transition:all .15s;
      white-space:nowrap;
    }
    .ghost-btn:hover{background:rgba(255,255,255,.1);color:var(--ink);border-color:rgba(255,255,255,.2)}
    body.light .ghost-btn:hover{background:rgba(0,0,0,.07);border-color:rgba(0,0,0,.18)}
    .ghost-btn:active{transform:scale(.97)}
    .theme-btn{width:34px;padding:0;font-size:15px;}

    /* â”€â”€ SEARCH SECTION â”€â”€ */
    .search-section{
      padding:14px 16px 0;
      max-width:700px;margin:0 auto;
    }
    .search-hero{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r-lg);
      padding:12px;
      position:relative;
    }
    .tips-pill{
      width:36px;height:36px;
      border:1px solid var(--border2);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      border-radius:10px;
      font-size:16px;
      display:grid;place-items:center;
      flex:0 0 auto;
      transition:all .15s;
    }
    .tips-pill:hover{background:rgba(255,255,255,.1);color:var(--ink)}

    .search-form{display:flex;gap:8px;align-items:center}
    .search-input{
      width:130px;
      flex:0 0 130px;
      background:var(--surface3);
      border:1px solid var(--border2);
      color:var(--ink);
      border-radius:10px;
      padding:9px 12px;
      font-size:14px;
      font-weight:500;
      outline:none;
      transition:border-color .15s,box-shadow .15s;
    }
    .search-input::placeholder{color:var(--dim);font-size:13px}
    .search-input:focus{
      border-color:rgba(56,139,253,.6);
      box-shadow:0 0 0 3px rgba(56,139,253,.15);
    }
    .search-btn{
      height:36px;padding:0 16px;
      background:linear-gradient(135deg,#1f6feb,#388bfd);
      border:none;
      color:#fff;
      border-radius:10px;
      font-size:13px;font-weight:700;
      white-space:nowrap;
      transition:filter .15s,transform .1s;
      box-shadow:0 4px 14px rgba(31,111,235,.35);
      flex:0 0 auto;
    }
    .search-btn:hover{filter:brightness(1.1)}
    .search-btn:active{transform:scale(.97)}

    /* Month Navigator */
    .month-nav{
      display:none;
      align-items:center;
      gap:8px;
      margin-top:14px;
      padding-top:14px;
      border-top:1px solid var(--border);
    }
    .month-nav.visible{display:flex}
    .mnav-btn{
      width:36px;height:36px;
      background:var(--surface3);
      border:1px solid var(--border2);
      color:var(--muted);
      border-radius:8px;
      display:grid;place-items:center;
      font-size:16px;
      flex:0 0 auto;
      transition:all .15s;
    }
    .mnav-btn:hover:not(:disabled){background:rgba(255,255,255,.1);color:var(--ink)}
    .mnav-btn:disabled{opacity:.3;cursor:not-allowed}
    .mnav-select{
      flex:1;
      background:var(--surface3);
      border:1px solid var(--border2);
      color:var(--ink);
      border-radius:8px;
      padding:8px 12px;
      font-size:13px;font-weight:600;
      outline:none;
      appearance:none;
      text-align:center;
      cursor:pointer;
    }
    .mnav-label{font-size:11px;color:var(--muted);font-weight:600;white-space:nowrap;font-family:'DM Mono',monospace}

    /* â”€â”€ MAIN CONTENT â”€â”€ */
    .main{padding:12px 16px calc(24px + var(--safe-bot));max-width:700px;margin:0 auto}
    .stack{display:flex;flex-direction:column;gap:10px}

    /* â”€â”€ EMPLOYEE BANNER â”€â”€ */
    .emp-banner{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:10px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .emp-left{display:flex;align-items:center;gap:10px;min-width:0}
    .emp-avatar{
      width:38px;height:38px;border-radius:10px;
      background:linear-gradient(135deg,#1f6feb,#58a6ff);
      display:grid;place-items:center;
      color:#fff;font-weight:800;font-size:13px;
      flex:0 0 auto;
    }
    .emp-name{font-size:14px;font-weight:700;color:var(--ink);line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .emp-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:3px}
    .emp-tag{
      display:inline-flex;align-items:center;gap:4px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:5px;
      padding:2px 6px;
      font-size:10px;color:var(--muted);font-weight:500;
      font-family:'DM Mono',monospace;
    }
    .change-btn{
      width:32px;height:32px;
      background:transparent;
      border:1px solid var(--border2);
      color:var(--muted);
      border-radius:8px;
      font-size:15px;
      display:grid;place-items:center;
      flex:0 0 auto;
      transition:all .15s;
    }
    .change-btn:hover{background:rgba(255,255,255,.07);color:var(--ink)}

    /* â”€â”€ STATS ROW â”€â”€ */
    .stats-row{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:8px;
    }
    @media(max-width:380px){.stats-row{grid-template-columns:repeat(2,1fr)}}
    .stat-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:12px 10px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .stat-card::after{
      content:'';
      position:absolute;top:0;left:0;right:0;height:2px;
      border-radius:99px;
    }
    .stat-card.c-blue::after{background:linear-gradient(90deg,#1f6feb,#58a6ff)}
    .stat-card.c-gray::after{background:linear-gradient(90deg,#484f58,#8b949e)}
    .stat-card.c-amber::after{background:linear-gradient(90deg,#b45309,#d29922)}
    .stat-card.c-orange::after{background:linear-gradient(90deg,#c2410c,#db6d28)}
    .stat-card.c-purple::after{background:linear-gradient(90deg,#7c3aed,#bc8cff)}
    .stat-card.c-pink::after{background:linear-gradient(90deg,#be185d,#ff7b72)}
    .stat-card.c-green::after{background:linear-gradient(90deg,#15803d,#3fb950)}
    .stat-ico{font-size:16px;margin-bottom:4px;display:block}
    .stat-val{font-size:22px;font-weight:800;color:var(--ink);font-family:'DM Mono',monospace;line-height:1}
    .stat-lbl{font-size:10px;color:var(--muted);font-weight:600;margin-top:4px;line-height:1.2}

    /* â”€â”€ CALENDAR â”€â”€ */
    .cal-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r-lg);
      overflow:hidden;
    }
    .cal-head{
      display:grid;grid-template-columns:repeat(7,1fr);
      background:var(--surface2);
      border-bottom:1px solid var(--border);
    }
    .cal-head div{
      padding:9px 2px;
      text-align:center;
      font-size:10px;font-weight:700;
      color:var(--muted);
      letter-spacing:.3px;
      text-transform:uppercase;
    }
    .cal-body{
      display:grid;
      grid-template-columns:repeat(7,1fr);
    }
    .day{
      background:var(--surface);
      min-height:64px;
      padding:6px 4px;
      display:flex;flex-direction:column;justify-content:space-between;
      position:relative;
      transition:background .1s;
      cursor:default;
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
    }
    .day:nth-child(7n){border-right:none}
    @media(max-width:380px){.day{min-height:52px;padding:4px 3px}}
    .day.empty{background:rgba(13,17,23,.6);cursor:default}
    .day-top{display:flex;align-items:center;justify-content:space-between;width:100%}
    .dnum{font-size:11px;font-weight:700;color:var(--muted);font-family:'DM Mono',monospace}
    .day:not(.empty) .dnum{color:var(--ink)}
    .day-ico{font-size:13px;line-height:1}
    .day-tag{
      margin-top:3px;
      font-size:9px;font-weight:700;
      border-radius:4px;
      padding:2px 4px;
      border:1px solid transparent;
      text-align:center;
      letter-spacing:.15px;
      line-height:1.2;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
      max-width:100%;
    }
    /* Today */
    .day.today{background:rgba(31,111,235,.1)!important}
    .day.today .dnum{color:var(--accent)!important;font-weight:800}
    .day.today::before{
      content:'';
      position:absolute;top:0;left:0;right:0;height:2px;
      background:linear-gradient(90deg,#1f6feb,#58a6ff);
    }
    /* Shift backgrounds */
    .s-morning{background:#1a140a}
    .s-afternoon{background:#1a0f07}
    .s-night{background:#110d1f}
    .s-off{background:#0f1117}
    .s-leave{background:#0a1410}
    .s-training{background:#0a1020}
    .s-standby{background:#1a0d14}
    .s-other{background:#111318}
    /* Light mode shift backgrounds */
    body.light .s-morning{background:#fffbf0}
    body.light .s-afternoon{background:#fff7f0}
    body.light .s-night{background:#f5f3ff}
    body.light .s-off{background:#f8fafc}
    body.light .s-leave{background:#f0fdf4}
    body.light .s-training{background:#eff6ff}
    body.light .s-standby{background:#fdf2f8}
    body.light .s-other{background:#f9fafb}
    body.light .day{background:var(--surface)}
    body.light .day.empty{background:rgba(245,247,250,.7)}
    /* Tags */
    .s-morning .day-tag{color:#d29922;background:rgba(210,153,34,.1);border-color:rgba(210,153,34,.2)}
    .s-afternoon .day-tag{color:#db6d28;background:rgba(219,109,40,.1);border-color:rgba(219,109,40,.2)}
    .s-night .day-tag{color:#bc8cff;background:rgba(188,140,255,.1);border-color:rgba(188,140,255,.2)}
    .s-off .day-tag{color:#8b949e;background:rgba(139,148,158,.1);border-color:rgba(139,148,158,.2)}
    .s-leave .day-tag{color:#3fb950;background:rgba(63,185,80,.1);border-color:rgba(63,185,80,.2)}
    .s-training .day-tag{color:#58a6ff;background:rgba(88,166,255,.1);border-color:rgba(88,166,255,.2)}
    .s-standby .day-tag{color:#ff7b72;background:rgba(255,123,114,.1);border-color:rgba(255,123,114,.2)}
    .s-other .day-tag{color:#8b949e;background:rgba(139,148,158,.1);border-color:rgba(139,148,158,.2)}

    /* â”€â”€ LEGEND â”€â”€ */
    .legend-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r-lg);
      padding:14px;
    }
    .section-label{
      font-size:10px;font-weight:700;
      color:var(--dim);letter-spacing:.8px;text-transform:uppercase;
      margin-bottom:10px;
    }
    .legend-grid{display:flex;flex-wrap:wrap;gap:6px}
    .leg-item{
      display:inline-flex;align-items:center;gap:6px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:6px;
      padding:5px 9px;
      font-size:11px;color:var(--muted);font-weight:500;
    }
    .l-dot{width:8px;height:8px;border-radius:3px;flex:0 0 auto}

    /* â”€â”€ ACTIONS â”€â”€ */
    .actions-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r-lg);
      padding:14px;
    }
    .actions-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .action-btn{
      display:flex;align-items:center;gap:10px;
      background:var(--surface3);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px 14px;
      color:var(--muted);
      font-size:13px;font-weight:600;
      transition:all .15s;
      text-align:left;
    }
    .action-btn:hover{background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.15);color:var(--ink)}
    .action-btn:active{transform:scale(.98)}
    .action-btn.primary{
      background:linear-gradient(135deg,rgba(31,111,235,.2),rgba(56,139,253,.1));
      border-color:rgba(56,139,253,.3);
      color:var(--accent);
      grid-column:span 2;
    }
    .action-btn.primary:hover{background:linear-gradient(135deg,rgba(31,111,235,.3),rgba(56,139,253,.2));border-color:rgba(56,139,253,.5)}
    .action-ico{font-size:18px;flex:0 0 auto}

    /* â”€â”€ STATE VIEWS â”€â”€ */
    .state-view{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r-lg);
      padding:48px 24px;
      text-align:center;
    }
    .state-emoji{font-size:42px;display:block;margin-bottom:12px}
    .state-title{font-size:18px;font-weight:700;color:var(--ink);margin-bottom:6px}
    .state-desc{font-size:13px;color:var(--muted);line-height:1.65;max-width:38ch;margin:0 auto}
    .spin{
      width:36px;height:36px;
      border:2.5px solid var(--border2);
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin:0 auto 14px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* â”€â”€ MODAL â”€â”€ */
    .modal{
      position:fixed;inset:0;z-index:999;
      display:none;align-items:flex-end;justify-content:center;
      padding:0;
    }
    @media(min-width:600px){.modal{align-items:center;padding:20px}}
    .modal.open{display:flex}
    .modal-backdrop{
      position:absolute;inset:0;
      background:rgba(0,0,0,.7);
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
    }
    .modal-sheet{
      position:relative;z-index:1;
      width:100%;max-width:540px;
      background:var(--surface);
      border:1px solid var(--border2);
      border-radius:24px 24px 0 0;
      overflow:hidden;
      animation:slideUp .25s cubic-bezier(.22,1,.36,1);
    }
    @media(min-width:600px){.modal-sheet{border-radius:20px;max-width:560px}}
    @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-handle{width:40px;height:4px;background:var(--dim);border-radius:2px;margin:14px auto 0;opacity:.5}
    .modal-head{
      padding:18px 22px 16px;
      border-bottom:1px solid var(--border);
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }
    .modal-title{font-size:18px;font-weight:700;color:var(--ink)}
    .modal-sub{font-size:13px;color:var(--muted);margin-top:4px;line-height:1.5}
    .modal-close{
      width:36px;height:36px;border-radius:10px;
      background:rgba(255,255,255,.06);border:1px solid var(--border);
      color:var(--muted);font-size:16px;
      display:grid;place-items:center;flex:0 0 auto;
      transition:all .15s;
    }
    .modal-close:hover{background:rgba(255,255,255,.12);color:var(--ink)}
    .modal-body{padding:18px 22px}
    .modal-intro{
      background:rgba(88,166,255,.05);
      border:1px solid rgba(88,166,255,.15);
      border-radius:12px;
      padding:14px 16px;
      margin-bottom:14px;
    }
    .modal-intro-title{font-size:14px;font-weight:700;color:var(--ink);margin-bottom:5px}
    .modal-intro-desc{font-size:13px;color:var(--muted);line-height:1.65}
    .tip{
      display:flex;align-items:flex-start;gap:12px;
      padding:14px;border:1px solid var(--border);
      border-radius:12px;background:rgba(255,255,255,.02);
    }
    .tip+.tip{margin-top:10px}
    .tip-ico{font-size:20px;flex:0 0 auto;margin-top:1px}
    .tip-text{font-size:13px;color:var(--muted);line-height:1.65;font-weight:500}
    .modal-foot{padding:16px 22px calc(16px + var(--safe-bot));display:flex;justify-content:flex-end}
    .ok-btn{
      height:40px;padding:0 20px;
      background:linear-gradient(135deg,#1f6feb,#388bfd);
      border:none;color:#fff;
      border-radius:10px;
      font-size:13px;font-weight:700;
      transition:filter .15s;
    }
    .ok-btn:hover{filter:brightness(1.1)}

    /* â”€â”€ TOAST â”€â”€ */
    .toast-container{
      position:fixed;
      bottom:calc(16px + var(--safe-bot));
      left:16px;right:16px;
      z-index:9999;
      display:flex;justify-content:center;
      pointer-events:none;
    }
    .toast-card{
      pointer-events:auto;
      width:min(560px,100%);
      background:var(--surface2);
      border:1px solid var(--border2);
      border-radius:16px;
      padding:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      animation:slideUp .2s cubic-bezier(.22,1,.36,1);
    }
    .toast-row{display:flex;align-items:flex-start;gap:10px}
    .toast-ico{
      width:38px;height:38px;border-radius:10px;
      background:rgba(88,166,255,.1);border:1px solid rgba(88,166,255,.2);
      display:grid;place-items:center;font-size:16px;flex:0 0 auto;
    }
    .toast-text p{font-size:12.5px;color:var(--muted);line-height:1.55;font-weight:500}
    .toast-text strong{color:var(--ink)}
    .toast-btns{display:flex;gap:8px;margin-top:10px}
    .tbtn{
      flex:1;height:36px;
      border-radius:8px;font-size:12px;font-weight:700;
      border:1px solid var(--border2);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      transition:all .12s;
    }
    .tbtn:hover{background:rgba(255,255,255,.1);color:var(--ink)}
    .tbtn.primary{
      background:linear-gradient(135deg,#1f6feb,#388bfd);
      border:none;color:#fff;
    }
    .tbtn.primary:hover{filter:brightness(1.1)}

    /* â”€â”€ PRINT â”€â”€ */
    @media print{
      .topbar,.search-section,.toast-container,.modal,.actions-card,.legend-card{display:none!important}
      body{background:#fff;color:#000}
    }
  </style>
</head>
<body>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-icon">ğŸ“…</div>
        <div class="brand-info">
          <div class="brand-name" id="ttl">My Schedule</div>
          <div class="brand-sub" id="sub">Enter your Employee ID</div>
        </div>
      </div>
      <div class="top-btns">
        <button class="ghost-btn theme-btn" onclick="toggleTheme()" id="themeBtn" aria-label="Toggle theme">ğŸŒ™</button>
        <button class="ghost-btn" onclick="toggleLang()" id="langBtn">English</button>
        <button class="ghost-btn" onclick="goBack()" id="backBtn">Ø±Ø¬ÙˆØ¹ â†’</button>
      </div>
    </div>
  </header>

  <!-- SEARCH SECTION -->
  <section class="search-section">
    <div class="search-hero">
      <form id="searchForm">
        <div class="search-form">
          <input class="search-input" id="empId" inputmode="numeric" autocomplete="off"
                 placeholder="e.g. 12345" pattern="[0-9]+" required/>
          <button class="search-btn" type="submit" id="sbtn">ğŸ“… View</button>
          <button class="tips-pill" type="button" onclick="openTips()" id="tipsBtn" aria-label="Tips">â”</button>
        </div>
      </form>

      <div class="month-nav" id="monthNav">
        <button class="mnav-btn" id="mPrev" onclick="chMonth(-1)" aria-label="Prev">â€¹</button>
        <select class="mnav-select" id="mSel" onchange="jumpMonth(this.value)"></select>
        <button class="mnav-btn" id="mNext" onclick="chMonth(1)" aria-label="Next">â€º</button>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <main class="main">
    <div id="area" class="stack">
      <div class="state-view">
        <span class="state-emoji">ğŸ“†</span>
        <div class="state-title" id="e1">Search your schedule</div>
        <div class="state-desc" id="e2">Enter your Employee ID above to view your monthly roster.</div>
      </div>
    </div>
  </main>

  <!-- TOAST -->
  <div class="toast-container" id="toastMount" style="display:none"></div>

  <!-- TIPS MODAL -->
  <div class="modal" id="tipsModal" role="dialog" aria-modal="true">
    <div class="modal-backdrop" onclick="closeTips()"></div>
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-head">
        <div>
          <div class="modal-title" id="tipsTitleModal">Help & Tips</div>
          <div class="modal-sub" id="tipsSub">Quick help for using the roster.</div>
        </div>
        <button class="modal-close" onclick="closeTips()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="modal-intro">
          <div class="modal-intro-title" id="miTitle">Your roster in one view</div>
          <div class="modal-intro-desc" id="miDesc">Enter your Employee ID to view the month, then export it as PDF / Image or add it to your calendar.</div>
        </div>
        <div class="tip">
          <div class="tip-ico">ğŸ’¾</div>
          <div class="tip-text" id="tip1">Save your Employee ID once â€” it will load automatically next time.</div>
        </div>
        <div class="tip">
          <div class="tip-ico">ğŸ–¼ï¸</div>
          <div class="tip-text" id="tip2">Image export produces a clean card with header, calendar, legend, and stats.</div>
        </div>
        <div class="tip">
          <div class="tip-ico">ğŸ“†</div>
          <div class="tip-text" id="tip3">Use ICS export to add shifts to Apple/Google/Outlook calendars.</div>
        </div>
      </div>
      <div class="modal-foot">
        <button class="ok-btn" onclick="closeTips()" id="tipsOk">Got it</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    let data=null, month=null, months=[], lang='ar', theme='dark';

    const COLORS={
      Morning:       {icon:'â˜€ï¸', dot:'#d29922'},
      Afternoon:     {icon:'ğŸŒ¤ï¸', dot:'#db6d28'},
      Night:         {icon:'ğŸŒ™', dot:'#bc8cff'},
      'Off Day':     {icon:'ğŸ–ï¸', dot:'#8b949e'},
      'Annual Leave':{icon:'âœˆï¸', dot:'#3fb950'},
      'Sick Leave':  {icon:'ğŸ¤’', dot:'#3fb950'},
      Training:      {icon:'ğŸ“š', dot:'#58a6ff'},
      Standby:       {icon:'ğŸ§', dot:'#ff7b72'},
      Other:         {icon:'â“', dot:'#8b949e'}
    };

    const STAT_META=[
      {k:'work',     icon:'ğŸ’¼', c:'c-blue',   label_en:'Work Days',  label_ar:'Ø£ÙŠØ§Ù… Ø¹Ù…Ù„'},
      {k:'off',      icon:'ğŸ›Œ', c:'c-gray',   label_en:'Days Off',   label_ar:'Ø£ÙŠØ§Ù… Ø±Ø§Ø­Ø©'},
      {k:'morning',  icon:'â˜€ï¸', c:'c-amber',  label_en:'Morning',    label_ar:'ØµØ¨Ø§Ø­ÙŠ'},
      {k:'afternoon',icon:'ğŸŒ¤ï¸', c:'c-orange', label_en:'Afternoon',  label_ar:'Ù…Ø³Ø§Ø¦ÙŠ'},
      {k:'night',    icon:'ğŸŒ™', c:'c-purple', label_en:'Night',      label_ar:'Ù„ÙŠÙ„ÙŠ'},
      {k:'standby',  icon:'ğŸ§', c:'c-pink',   label_en:'Standby',    label_ar:'Ø§Ø­ØªÙŠØ§Ø·ÙŠ'},
      {k:'leaves',   icon:'âœˆï¸', c:'c-green',  label_en:'Leaves',     label_ar:'Ø¥Ø¬Ø§Ø²Ø§Øª'},
    ];

    const T={
      en:{
        title:'My Schedule',sub:'Enter your Employee ID',
        heroTitle:'Your roster in one view',
        heroDesc:'Enter your Employee ID to view the month, export as PDF, Image, or add to your calendar.',
        tipsTitle:'Help & Tips',tipsSub:'Quick help for using the roster.',
        langBtn:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',back:'â† Back',ph:'e.g. 12345',sbtn:'ğŸ“… View',tipsBtn:'â” Tips',
        loading:'Loadingâ€¦',notFound:'Employee not found',
        notFoundSub:'ID not in the system. Please check and try again.',
        e1:'Search your schedule',e2:'Enter your Employee ID above to view your monthly roster.',
        statsTitle:'Statistics',legendTitle:'Legend',actionsTitle:'Downloads',
        pdf:'Download PDF',img:'Download Image',ics:'Export ICS',share:'Share Link',print:'Print',
        changeId:'Change ID',setAsMyId:'Set as My ID',dept:'Dept',id:'ID',
        days:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
        months:['January','February','March','April','May','June','July','August','September','October','November','December'],
        legend:{Morning:'Morning',Afternoon:'Afternoon',Night:'Night','Off Day':'Day Off','Annual Leave':'Annual Leave','Sick Leave':'Sick Leave',Training:'Training',Standby:'Standby',Other:'Other'},
        saveTitle:'Save your ID?',saveSub:'Open your schedule faster next time.',saveYes:'âœ… Save',saveNo:'Not now'
      },
      ar:{
        title:'Ø¬Ø¯ÙˆÙ„ÙŠ',sub:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ',
        heroTitle:'Ø¬Ø¯ÙˆÙ„Ùƒ ÙÙŠ Ø¹Ø±Ø¶ ÙˆØ§Ø­Ø¯',
        heroDesc:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø±ØŒ Ø«Ù… Ø­Ù…Ù‘Ù„ PDF/ØµÙˆØ±Ø© Ø£Ùˆ Ø£Ø¶ÙÙ‡ Ù„Ù„ØªÙ‚ÙˆÙŠÙ….',
        tipsTitle:'Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆÙ†ØµØ§Ø¦Ø­',tipsSub:'Ù…Ø³Ø§Ø¹Ø¯Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„.',
        langBtn:'English',back:'Ø±Ø¬ÙˆØ¹ â†’',ph:'Ù…Ø«Ø§Ù„: 12345',sbtn:'ğŸ“… Ø¹Ø±Ø¶',tipsBtn:'â” Ù†ØµØ§Ø¦Ø­',
        loading:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦',notFound:'Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù',
        notFoundSub:'Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ØªØ­Ù‚Ù‚ ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.',
        e1:'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¬Ø¯ÙˆÙ„Ùƒ',e2:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¹Ø±Ø¶ Ù…Ù†Ø§ÙˆØ¨Ø§ØªÙƒ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©.',
        statsTitle:'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',legendTitle:'Ø§Ù„Ø¯Ù„ÙŠÙ„',actionsTitle:'Ø§Ù„ØªØ­Ù…ÙŠÙ„',
        pdf:'ØªØ­Ù…ÙŠÙ„ PDF',img:'ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©',ics:'ØªØµØ¯ÙŠØ± ICS',share:'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ø§Ø¨Ø·',print:'Ø·Ø¨Ø§Ø¹Ø©',
        changeId:'ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù…',setAsMyId:'Ø§Ø­ÙØ¸ ÙƒØ±Ù‚Ù…ÙŠ',dept:'Ø§Ù„Ù‚Ø³Ù…',id:'Ø§Ù„Ø±Ù‚Ù…',
        days:['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'],
        months:['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'],
        legend:{Morning:'ØµØ¨Ø§Ø­ÙŠ',Afternoon:'Ù…Ø³Ø§Ø¦ÙŠ',Night:'Ù„ÙŠÙ„ÙŠ','Off Day':'Ø¥Ø¬Ø§Ø²Ø©','Annual Leave':'Ø³Ù†ÙˆÙŠØ©','Sick Leave':'Ù…Ø±Ø¶ÙŠØ©',Training:'ØªØ¯Ø±ÙŠØ¨',Standby:'Ø§Ø­ØªÙŠØ§Ø·ÙŠ',Other:'Ø£Ø®Ø±Ù‰'},
        saveTitle:'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù…ØŸ',saveSub:'Ù„ÙØªØ­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.',saveYes:'âœ… Ø§Ø­ÙØ¸',saveNo:'Ù„ÙŠØ³ Ø§Ù„Ø¢Ù†'
      }
    };

    function t(k){ return T[lang][k]; }
    function esc(s){ return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function applyLangUI(){
      document.documentElement.lang=lang;
      document.documentElement.dir=lang==='ar'?'rtl':'ltr';
      document.body.classList.toggle('ar',lang==='ar');
      document.getElementById('ttl').textContent=t('title');
      document.getElementById('sub').textContent=t('sub');
      document.getElementById('langBtn').textContent=t('langBtn');
      document.getElementById('backBtn').textContent=t('back');
      document.getElementById('empId').placeholder=t('ph');
      document.getElementById('sbtn').textContent=t('sbtn');
      const e1=document.getElementById('e1'),e2=document.getElementById('e2');
      if(e1)e1.textContent=t('e1');
      if(e2)e2.textContent=t('e2');
      document.getElementById('tipsTitleModal').textContent=t('tipsTitle');
      document.getElementById('tipsSub').textContent=t('tipsSub');
      document.getElementById('miTitle').textContent=t('heroTitle');
      document.getElementById('miDesc').textContent=t('heroDesc');
      document.getElementById('tip1').textContent=(lang==='ar'?'Ø§Ø­ÙØ¸ Ø±Ù‚Ù…Ùƒ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© â€” ÙˆØ³ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.':'Save your Employee ID once â€” it will load automatically next time.');
      document.getElementById('tip2').textContent=(lang==='ar'?'Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© ÙŠÙ†ØªØ¬ Ø¨Ø·Ø§Ù‚Ø© Ù…Ø±ØªØ¨Ø© (Ø±Ø£Ø³ + ØªÙ‚ÙˆÙŠÙ… + Ø¯Ù„ÙŠÙ„ + Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª).':'Image export produces a clean card with header, calendar, legend, and stats.');
      document.getElementById('tip3').textContent=(lang==='ar'?'Ø§Ø³ØªØ®Ø¯Ù… ØªØµØ¯ÙŠØ± ICS Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª Ø¥Ù„Ù‰ ØªÙ‚ÙˆÙŠÙ… Apple/Google/Outlook.':'Use ICS export to add shifts to Apple/Google/Outlook calendars.');
      document.getElementById('tipsOk').textContent='OK';
      if(data) renderSchedule();
    }

    function toggleTheme(){
      theme=(theme==='dark'?'light':'dark');
      document.body.classList.toggle('light', theme==='light');
      document.getElementById('themeBtn').textContent=(theme==='dark'?'ğŸŒ™':'â˜€ï¸');
    }
    function toggleLang(){ lang=(lang==='en'?'ar':'en'); applyLangUI(); }

    function goBack(){
      const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
      if(document.referrer&&document.referrer.includes(location.host)) history.back();
      else location.href=base;
    }

    function openTips(){ document.getElementById('tipsModal').classList.add('open'); }
    function closeTips(){ document.getElementById('tipsModal').classList.remove('open'); }
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeTips(); });

    document.getElementById('searchForm').addEventListener('submit',async(e)=>{
      e.preventDefault();
      const id=document.getElementById('empId').value.trim();
      if(id) await loadSchedule(id);
    });

    async function loadSchedule(id){
      document.getElementById('area').innerHTML=`
        <div class="state-view">
          <div class="spin"></div>
          <div class="state-title">${t('loading')}</div>
          <div class="state-desc">${lang==='ar'?'Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø§Øªâ€¦':'Please wait a momentâ€¦'}</div>
        </div>`;
      try{
        const res=await fetch(`../schedules/${id}.json`);
        if(!res.ok) throw new Error('not found');
        data=await res.json();
        months=Object.keys(data.schedules||{}).sort();
        if(!months.length) throw new Error('empty');
        const savedId=localStorage.getItem('savedEmpId');
        if(!savedId) showSaveToast(id,data.name);
        const now=new Date();
        const cur=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
        month=months.includes(cur)?cur:months[months.length-1];
        renderSchedule();
      }catch(err){
        document.getElementById('area').innerHTML=`
          <div class="state-view">
            <span class="state-emoji">âŒ</span>
            <div class="state-title">${t('notFound')}</div>
            <div class="state-desc">${t('notFoundSub')}</div>
          </div>`;
      }
    }

    function showSaveToast(id,name){
      const mount=document.getElementById('toastMount');
      const first=(name?name.split(' ')[0]:id);
      mount.style.display='flex';
      mount.innerHTML=`
        <div class="toast-card">
          <div class="toast-row">
            <div class="toast-ico">ğŸ’¾</div>
            <div class="toast-text">
              <p><strong>${t('saveTitle')}</strong><br>
              ${lang==='ar'?'Ù‡Ù„ Ø£Ù†Øª ':'Are you '}<strong>${esc(first)}</strong>? ${t('saveSub')}</p>
            </div>
          </div>
          <div class="toast-btns">
            <button class="tbtn primary" onclick="confirmSave('${id}')">${t('saveYes')}</button>
            <button class="tbtn" onclick="dismissToast()">${t('saveNo')}</button>
          </div>
        </div>`;
      setTimeout(()=>dismissToast(),10000);
    }
    function confirmSave(id){ localStorage.setItem('savedEmpId',id); dismissToast(); if(data) renderSchedule(); }
    function dismissToast(){ const m=document.getElementById('toastMount'); m.innerHTML=''; m.style.display='none'; }
    function changeMyId(){ if(confirm(lang==='ar'?'Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ØŸ':'Change your saved Employee ID?')){ localStorage.removeItem('savedEmpId'); if(data) renderSchedule(); } }
    function setAsMyId(){ if(data&&data.id){ localStorage.setItem('savedEmpId',data.id); if(data) renderSchedule(); } }

    function calcStats(s){
      const r={work:0,off:0,morning:0,afternoon:0,night:0,standby:0,leaves:0};
      s.forEach(d=>{
        if(d.shift_group==='Morning') r.morning++;
        else if(d.shift_group==='Afternoon') r.afternoon++;
        else if(d.shift_group==='Night') r.night++;
        else if(d.shift_group==='Off Day') r.off++;
        else if(d.shift_group==='Standby') r.standby++;
        else if(d.shift_group==='Annual Leave'||d.shift_group==='Sick Leave') r.leaves++;
      });
      r.work=r.morning+r.afternoon+r.night;
      return r;
    }

    function shiftClass(g){
      return {Morning:'s-morning',Afternoon:'s-afternoon',Night:'s-night','Off Day':'s-off','Annual Leave':'s-leave','Sick Leave':'s-leave',Training:'s-training',Standby:'s-standby',Other:'s-other'}[g]||'s-other';
    }

    function chMonth(dir){ const ci=months.indexOf(month),ni=ci+dir; if(ni>=0&&ni<months.length){month=months[ni];renderSchedule();} }
    function jumpMonth(val){ if(months.includes(val)){month=val;renderSchedule();} }

    function renderSchedule(){
      const sched=data.schedules[month]||[];
      const [yr,mo]=month.split('-').map(Number);
      const ci=months.indexOf(month);
      const hasPrev=ci>0,hasNext=ci<months.length-1;
      const firstDow=new Date(yr,mo-1,1).getDay();
      const dim=new Date(yr,mo,0).getDate();
      const now=new Date();

      // Month nav
      const nav=document.getElementById('monthNav');
      nav.classList.add('visible');
      const sel=document.getElementById('mSel');
      sel.innerHTML=months.map(m=>{
        const p=m.split('-').map(Number);
        return `<option value="${m}" ${m===month?'selected':''}>${T[lang].months[p[1]-1]} ${p[0]}</option>`;
      }).join('');
      document.getElementById('mPrev').disabled=!hasPrev;
      document.getElementById('mNext').disabled=!hasNext;

      const savedId=localStorage.getItem('savedEmpId');
      const isMyId=savedId===data.id;
      const changeBtn=isMyId
        ?`<button class="change-btn" onclick="changeMyId()" title="${t('changeId')}">âœï¸</button>`
        :(!savedId?'':!isMyId?`<button class="change-btn" onclick="setAsMyId()" title="${t('setAsMyId')}">ğŸ“Œ</button>`:'');

      const initials=(data.name||'?').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();

      // Calendar cells â€” full grid: always 6 rows Ã— 7 cols
      const dayHdr=T[lang].days.map(d=>`<div>${d}</div>`).join('');
      let cells=''; let dc=1;
      for(let w=0;w<6;w++){
        let rowHasDays=false;
        for(let d=0;d<7;d++){
          if(w===0&&d<firstDow){
            cells+=`<div class="day empty"></div>`;
          }else if(dc>dim){
            cells+=`<div class="day empty"></div>`;
          }else{
            rowHasDays=true;
            const dd=sched.find(s=>s.day===dc);
            const sc=dd?shiftClass(dd.shift_group):'';
            const icon=dd?(COLORS[dd.shift_group]?.icon||''):'';
            const code=dd&&dd.shift_code?`<div class="day-tag">${esc(dd.shift_code)}</div>`:'';
            const isToday=(now.getFullYear()===yr&&(now.getMonth()+1)===mo&&now.getDate()===dc);
            cells+=`<div class="day ${sc} ${isToday?'today':''}">
              <div class="day-top">
                <span class="dnum">${dc}</span>
                <span class="day-ico">${icon}</span>
              </div>
              ${code}
            </div>`;
            dc++;
          }
        }
        // Stop adding empty rows after all days done
        if(dc>dim&&!rowHasDays) break;
        if(dc>dim) break;
      }

      const stats=calcStats(sched);

      // Stats cards
      const statsHTML=STAT_META.map(m=>`
        <div class="stat-card ${m.c}">
          <span class="stat-ico">${m.icon}</span>
          <div class="stat-val">${stats[m.k]}</div>
          <div class="stat-lbl">${lang==='ar'?m.label_ar:m.label_en}</div>
        </div>`).join('');

      document.getElementById('area').innerHTML=`
        <!-- Employee Banner -->
        <div class="emp-banner">
          <div class="emp-left">
            <div class="emp-avatar">${esc(initials)}</div>
            <div style="min-width:0">
              <div class="emp-name">${esc(data.name)}</div>
              <div class="emp-tags">
                <span class="emp-tag">ğŸ“‹ ${esc(data.department)}</span>
                <span class="emp-tag">ğŸ†” ${esc(data.id)}</span>
              </div>
            </div>
          </div>
          ${changeBtn}
        </div>

        <!-- Calendar -->
        <div class="cal-card">
          <div class="cal-head">${dayHdr}</div>
          <div class="cal-body">${cells}</div>
        </div>

        <!-- Stats -->
        <div class="stats-row">${statsHTML}</div>

        <!-- Actions -->
        <div class="actions-card">
          <div class="section-label">${t('actionsTitle')}</div>
          <div class="actions-grid">
            <button class="action-btn primary" onclick="dlPDF()"><span class="action-ico">ğŸ“„</span>${t('pdf')}</button>
            <button class="action-btn" onclick="dlIMG()"><span class="action-ico">ğŸ–¼ï¸</span>${t('img')}</button>
            <button class="action-btn" onclick="dlICS()"><span class="action-ico">ğŸ“†</span>${t('ics')}</button>
            <button class="action-btn" onclick="shareS()"><span class="action-ico">ğŸ”—</span>${t('share')}</button>
            <button class="action-btn" onclick="window.print()"><span class="action-ico">ğŸ–¨ï¸</span>${t('print')}</button>
          </div>
        </div>`;
    }

    /* IMAGE DOWNLOAD */
    async function dlIMG(){
      if(!window.html2canvas){alert('Image library loading, please try again.');return;}
      const calEl=document.querySelector('.cal-card');
      if(!calEl){alert('No calendar to capture.');return;}
      const sched=data.schedules[month]||[];
      const [yr,mo]=month.split('-').map(Number);
      const mName=`${T[lang].months[mo-1]} ${yr}`;
      const stats=calcStats(sched);
      const used=[...new Set(sched.map(s=>s.shift_group))];
      const W=Math.max(Math.min(calEl.offsetWidth,1000),360);

      const wrap=document.createElement('div');
      wrap.dir=(lang==='ar'?'rtl':'ltr');
      wrap.style.cssText=`position:fixed;left:-9999px;top:0;width:${W}px;background:#0d1117;font-family:'Sora',system-ui,sans-serif;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.08);`;
      const initials=(data.name||'?').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
      const hdr=document.createElement('div');
      hdr.style.cssText=`background:linear-gradient(135deg,#0d1117,#161b22);padding:16px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;border-bottom:1px solid rgba(255,255,255,.08);`;
      hdr.innerHTML=`
        <div style="display:flex;align-items:center;gap:10px;min-width:0">
          <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#1f6feb,#388bfd);display:grid;place-items:center;color:#fff;font-weight:800;font-size:16px;flex:0 0 auto">${esc(initials)}</div>
          <div style="min-width:0">
            <div style="color:#e6edf3;font-size:17px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:${Math.max(200,W-280)}px">${esc(data.name)}</div>
            <div style="color:#8b949e;font-size:11px;font-weight:500;margin-top:3px">ğŸ“‹ ${esc(data.department)} Â· ğŸ†” ${esc(data.id)}</div>
          </div>
        </div>
        <div style="background:rgba(88,166,255,.1);border:1px solid rgba(88,166,255,.2);color:#58a6ff;border-radius:8px;padding:7px 12px;font-size:12px;font-weight:700;white-space:nowrap">${esc(mName)}</div>`;
      wrap.appendChild(hdr);

      const calWrap=document.createElement('div');
      calWrap.style.cssText='padding:12px;background:#0d1117;';
      const calClone=calEl.cloneNode(true);
      calClone.style.cssText='border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.08);box-shadow:none;';
      calWrap.appendChild(calClone);
      wrap.appendChild(calWrap);

      const leg=document.createElement('div');
      leg.style.cssText='padding:0 12px 10px;background:#0d1117;display:flex;flex-wrap:wrap;gap:6px;';
      used.forEach(g=>{
        const c=COLORS[g];if(!c)return;
        const item=document.createElement('span');
        item.style.cssText='display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:6px;padding:4px 8px;font-size:11px;font-weight:500;color:#8b949e;white-space:nowrap';
        item.innerHTML=`<span style="width:8px;height:8px;border-radius:3px;background:${c.dot};display:inline-block;flex:0 0 auto"></span>${esc(T[lang].legend[g]||g)}`;
        leg.appendChild(item);
      });
      wrap.appendChild(leg);

      const stWrap=document.createElement('div');
      stWrap.style.cssText='background:#161b22;padding:12px;border-top:1px solid rgba(255,255,255,.08);';
      const stTitle=document.createElement('div');
      stTitle.style.cssText='font-size:10px;font-weight:700;color:#484f58;text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px';
      stTitle.textContent=t('statsTitle');
      stWrap.appendChild(stTitle);
      const stRow=document.createElement('div');
      stRow.style.cssText='display:flex;gap:8px;flex-wrap:wrap;';
      const CARD_COLORS={work:'#58a6ff',off:'#8b949e',morning:'#d29922',afternoon:'#db6d28',night:'#bc8cff',standby:'#ff7b72',leaves:'#3fb950'};
      STAT_META.forEach(m=>{
        const clr=CARD_COLORS[m.k];
        const box=document.createElement('div');
        box.style.cssText=`flex:1;min-width:120px;background:#1c2330;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 8px;text-align:center;border-top:2px solid ${clr};`;
        box.innerHTML=`<div style="font-size:20px;font-weight:800;color:${clr};line-height:1;font-family:'DM Mono',monospace">${stats[m.k]}</div>
                       <div style="font-size:9px;font-weight:600;color:#8b949e;margin-top:5px">${esc(lang==='ar'?m.label_ar:m.label_en)}</div>`;
        stRow.appendChild(box);
      });
      stWrap.appendChild(stRow);
      wrap.appendChild(stWrap);

      document.body.appendChild(wrap);
      try{
        const canvas=await html2canvas(wrap,{scale:3,useCORS:true,backgroundColor:'#0d1117',logging:false});
        const a=document.createElement('a');
        a.download=`schedule-${data.id}-${month}-${lang}.png`;
        a.href=canvas.toDataURL('image/png');
        a.click();
      }catch(e){alert('Image capture failed: '+e.message);}
      finally{document.body.removeChild(wrap);}
    }

    /* ICS */
    function dlICS(){
      const sched=data.schedules[month]||[];
      const [yr,mo]=month.split('-').map(Number);
      const pad=n=>String(n).padStart(2,'0');
      const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//MySchedule//EN','CALSCALE:GREGORIAN'];
      sched.forEach(d=>{
        const dt=`${yr}${pad(mo)}${pad(d.day)}`;
        const dtNext=new Date(yr,mo-1,d.day+1);
        const dtE=`${dtNext.getFullYear()}${pad(dtNext.getMonth()+1)}${pad(dtNext.getDate())}`;
        const sum=d.shift_code||d.shift_group;
        lines.push('BEGIN:VEVENT',`DTSTART;VALUE=DATE:${dt}`,`DTEND;VALUE=DATE:${dtE}`,`SUMMARY:${sum}`,`UID:${dt}-${data.id}-${d.day}@myschedule`,'END:VEVENT');
      });
      lines.push('END:VCALENDAR');
      const blob=new Blob([lines.join('\r\n')],{type:'text/calendar'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download=`schedule-${data.id}-${month}.ics`;a.click();
      URL.revokeObjectURL(a.href);
    }

    /* PDF */
    function dlPDF(){
      if(!window.jspdf){alert('PDF library loading, please try again.');return;}
      const{jsPDF}=window.jspdf;
      const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
      const W=210,H=297,ML=10,MR=10;
      const sched=data.schedules[month]||[];
      const[yr,mo]=month.split('-').map(Number);
      const mName=T.en.months[mo-1];
      const stats=calcStats(sched);
      const SC={Morning:{fg:[180,80,0],bg:[255,243,224]},Afternoon:{fg:[160,40,5],bg:[255,235,218]},Night:{fg:[100,40,210],bg:[237,233,254]},'Off Day':{fg:[85,95,115],bg:[238,240,245]},'Annual Leave':{fg:[10,125,60],bg:[218,248,230]},'Sick Leave':{fg:[10,125,60],bg:[218,248,230]},Training:{fg:[10,85,190],bg:[218,238,255]},Standby:{fg:[148,10,110],bg:[250,218,242]},Other:{fg:[90,100,115],bg:[240,241,246]}};
      const FALLBACK={'Off Day':'OFF','Annual Leave':'LV','Sick Leave':'SL',Training:'TR',Standby:'ST',Other:'â€”'};
      const LNAMES={Morning:'Morning',Afternoon:'Afternoon',Night:'Night','Off Day':'Day Off','Annual Leave':'Leave','Sick Leave':'Sick',Training:'Training',Standby:'Standby',Other:'Other'};
      const NAVY=[10,22,40],NAVY2=[18,36,65],WHITE=[255,255,255],RULE=[210,216,226],EMPTY=[246,247,251],DIM=[120,130,148],ACCENT=[29,111,235],MUTED=[140,155,180];

      // â”€â”€ HEADER â”€â”€
      // Deep navy gradient background
      const HDR_H=42;
      doc.setFillColor(...NAVY);doc.rect(0,0,W,HDR_H,'F');
      // Subtle accent stripe at bottom of header
      doc.setFillColor(...ACCENT);doc.rect(0,HDR_H-1.5,W,1.5,'F');

      // Employee name â€” big and bold, left side
      doc.setTextColor(...WHITE);
      doc.setFontSize(22);doc.setFont(undefined,'bold');
      doc.text(String(data.name), ML, 16);

      // Department Â· ID â€” smaller, muted blue
      doc.setFontSize(10);doc.setFont(undefined,'normal');
      doc.setTextColor(...MUTED);
      doc.text(`${data.department}`, ML, 25);

      // ID with slight separator
      doc.setTextColor(100,140,210);
      doc.setFontSize(9);
      doc.text(`ID  ${data.id}`, ML, 33);

      // Month + Year â€” right side, large, no box
      const monthStr = mName.toUpperCase();
      doc.setTextColor(...WHITE);
      doc.setFontSize(20);doc.setFont(undefined,'bold');
      doc.text(monthStr, W - MR, 19, {align:'right'});
      doc.setFontSize(11);doc.setFont(undefined,'normal');
      doc.setTextColor(...MUTED);
      doc.text(String(yr), W - MR, 29, {align:'right'});

      // â”€â”€ CALENDAR â”€â”€
      const CAL_HDR=9,STATS_H=44,FOOT_H=8,GAP1=4,GAP2=5;
      const CAL_TOP=HDR_H+GAP1,STATS_TOP=H-FOOT_H-GAP2-STATS_H,CAL_BOT=STATS_TOP-GAP2,CAL_BODY=CAL_BOT-CAL_TOP-CAL_HDR;
      const firstDow=new Date(yr,mo-1,1).getDay(),dim=new Date(yr,mo,0).getDate();
      let nRows=0;{let d2=1;for(let w=0;w<6;w++){let any=false;for(let d=0;d<7;d++){if(!((w===0&&d<firstDow)||d2>dim)){any=true;d2++;}}if(any)nRows++;if(d2>dim)break;}}
      const CH=Math.floor(CAL_BODY/nRows),CW=(W-ML-MR)/7;

      // Day header bar
      doc.setFillColor(...NAVY);doc.rect(ML,CAL_TOP,W-ML-MR,CAL_HDR,'F');
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach((d,i)=>{
        doc.setTextColor(...WHITE);doc.setFontSize(8);doc.setFont(undefined,'bold');
        doc.text(d,ML+i*CW+CW/2,CAL_TOP+6.2,{align:'center'});
      });

      // Calendar cells
      let dc=1,row=0;doc.setLineWidth(0.18);
      for(let w=0;w<6;w++){
        for(let d=0;d<7;d++){
          const cx=ML+d*CW,cy=CAL_TOP+CAL_HDR+row*CH;
          const isEmpty=(w===0&&d<firstDow)||dc>dim;
          if(isEmpty){doc.setFillColor(...EMPTY);doc.setDrawColor(...RULE);doc.rect(cx,cy,CW,CH,'FD');continue;}
          const dd=sched.find(s=>s.day===dc),sh=dd?(SC[dd.shift_group]||SC.Other):null;
          doc.setFillColor(...(sh?sh.bg:WHITE));doc.setDrawColor(...RULE);doc.rect(cx,cy,CW,CH,'FD');

          // Ghost day number
          const numStr=String(dc);
          let ghostR,ghostG,ghostB;
          if(sh){ghostR=Math.round(sh.bg[0]*.6+sh.fg[0]*.4);ghostG=Math.round(sh.bg[1]*.6+sh.fg[1]*.4);ghostB=Math.round(sh.bg[2]*.6+sh.fg[2]*.4);}
          else{ghostR=215;ghostG=220;ghostB=228;}
          const ghostSize=Math.round(CH*.68);
          doc.setTextColor(ghostR,ghostG,ghostB);
          doc.setFontSize(ghostSize>36?36:ghostSize<20?20:ghostSize);
          doc.setFont(undefined,'bold');
          doc.text(numStr,cx+2,cy+ghostSize*.7,{align:'left'});

          // Shift code centered
          if(dd){const code=dd.shift_code||(FALLBACK[dd.shift_group]||'');if(code){const fs=CH>=36?19:CH>=28?17:14;doc.setTextColor(...sh.fg);doc.setFontSize(fs);doc.setFont(undefined,'bold');doc.text(code,cx+CW/2,cy+CH*.68,{align:'center'});}}
          dc++;
        }
        if(dc>dim)break;
        row++;
      }

      // â”€â”€ STATS â”€â”€
      doc.setDrawColor(...RULE);doc.setLineWidth(0.25);doc.line(ML,STATS_TOP,W-MR,STATS_TOP);
      doc.setTextColor(...DIM);doc.setFontSize(7.5);doc.setFont(undefined,'bold');
      doc.text('MONTHLY STATISTICS', ML, STATS_TOP+5);

      const SL=[
        {l:'Work Days',v:stats.work,c:ACCENT},
        {l:'Day Off',v:stats.off,c:[85,95,115]},
        {l:'Morning',v:stats.morning,c:[180,80,0]},
        {l:'Afternoon',v:stats.afternoon,c:[160,40,5]},
        {l:'Night',v:stats.night,c:[100,40,210]},
        {l:'Standby',v:stats.standby,c:[148,10,110]},
        {l:'Leaves',v:stats.leaves,c:[10,125,60]}
      ];
      const nSt=SL.length,SGAP=2.5,sW=(W-ML-MR-(nSt-1)*SGAP)/nSt,CARD_Y=STATS_TOP+8,CARD_H=24;
      SL.forEach(({l,v,c},i)=>{
        const sx=ML+i*(sW+SGAP);
        // Card bg
        doc.setFillColor(248,250,254);doc.setDrawColor(...RULE);doc.setLineWidth(0.15);
        doc.roundedRect(sx,CARD_Y,sW,CARD_H,2,2,'FD');
        // Color top bar
        doc.setFillColor(...c);doc.roundedRect(sx,CARD_Y,sW,2.5,1,1,'F');
        // Value
        doc.setTextColor(...c);doc.setFontSize(19);doc.setFont(undefined,'bold');
        doc.text(String(v),sx+sW/2,CARD_Y+16,{align:'center'});
        // Label
        doc.setTextColor(...DIM);doc.setFontSize(5.5);doc.setFont(undefined,'bold');
        doc.text(l,sx+sW/2,CARD_Y+21.5,{align:'center'});
      });

      // Legend row
      const LY=CARD_Y+CARD_H+3;
      const usedG=[...new Set(sched.map(s=>s.shift_group))];
      const lStep=(W-ML-MR)/Math.max(usedG.length,1);
      usedG.forEach((g,i)=>{
        const sh2=SC[g]||SC.Other;const lx=ML+i*lStep;
        doc.setFillColor(...sh2.bg);doc.setDrawColor(...sh2.fg);doc.setLineWidth(0.4);
        doc.roundedRect(lx,LY,lStep-2,5.5,1.5,1.5,'FD');
        doc.setTextColor(...sh2.fg);doc.setFontSize(6);doc.setFont(undefined,'bold');
        doc.text(LNAMES[g]||g,lx+(lStep-2)/2,LY+3.8,{align:'center'});
      });

      // â”€â”€ FOOTER â”€â”€
      doc.setDrawColor(...RULE);doc.setLineWidth(0.2);doc.line(ML,H-5,W-MR,H-5);
      doc.setTextColor(...DIM);doc.setFontSize(6.5);doc.setFont(undefined,'normal');
      doc.text('My Schedule', ML, H-2);
      doc.text(`${mName} ${yr}  Â·  ${data.id}`, W-MR, H-2, {align:'right'});

      doc.save(`schedule-${data.id}-${month}.pdf`);
    }

    /* SHARE */
    function shareS(){
      const id=data.id;
      const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
      const url=`${location.origin}${base}my-schedules/?emp=${encodeURIComponent(id)}`;
      if(navigator.share){navigator.share({title:'My Schedule',text:`Schedule: ${data.name}`,url});}
      else{navigator.clipboard.writeText(url);alert(lang==='ar'?'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· âœ…':'Link copied âœ…');}
    }

    /* Init */
    applyLangUI();
    const p=new URLSearchParams(location.search).get('emp');
    if(p){document.getElementById('empId').value=p;loadSchedule(p);}
    else{const saved=localStorage.getItem('savedEmpId');if(saved){document.getElementById('empId').value=saved;loadSchedule(saved);}}
  </script>
</body>
</html>
