<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>My Schedule</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --navy:#0a1628;--blue:#1d4ed8;--sky:#3b82f6;--cyan:#06b6d4;
      --amber:#f59e0b;--orange:#f97316;--violet:#7c3aed;
      --slate:#64748b;--border:#e2e8f0;--bg:#f8fafc;--card:#fff;
      --r:16px;--shadow:0 4px 24px rgba(10,22,40,.08);
    }
    body{
      font-family:'Plus Jakarta Sans',system-ui,sans-serif;
      background:var(--bg);min-height:100vh;color:var(--navy);font-size:14px;
    }
    body.ar{direction:rtl;}

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .topbar{
      background:var(--navy);
      padding:0 24px;height:56px;
      display:flex;align-items:center;justify-content:space-between;
      position:sticky;top:0;z-index:100;
      box-shadow:0 2px 12px rgba(10,22,40,.2);
    }
    .topbar-brand{display:flex;align-items:center;gap:10px;color:#fff}
    .topbar-icon{
      width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg,var(--blue),var(--cyan));
      display:flex;align-items:center;justify-content:center;font-size:16px;
    }
    .topbar-title{font-size:15px;font-weight:800;letter-spacing:-.3px}
    .topbar-sub{font-size:10px;opacity:.6;font-weight:600;margin-top:1px}
    .topbar-btns{display:flex;gap:8px}
    .topbar-btn{
      background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);
      color:#fff;border-radius:9px;padding:6px 14px;
      font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;
      font-family:inherit;white-space:nowrap;
    }
    .topbar-btn:hover{background:rgba(255,255,255,.2);}

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SEARCH SECTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .search-section{
      background:linear-gradient(135deg,var(--navy) 0%,#1e3a5f 100%);
      padding:28px 24px 32px;
    }
    .search-label{color:rgba(255,255,255,.7);font-size:11px;font-weight:700;
      letter-spacing:.8px;text-transform:uppercase;margin-bottom:10px}
    .search-row{display:flex;gap:8px;max-width:500px}
    .search-input{
      flex:1;padding:12px 16px;border:1.5px solid rgba(255,255,255,.15);
      border-radius:12px;font-size:15px;direction:ltr;
      background:rgba(255,255,255,.08);color:#fff;
      font-family:inherit;font-weight:600;
      transition:all .2s;
    }
    .search-input::placeholder{color:rgba(255,255,255,.35);font-weight:400}
    .search-input:focus{outline:none;border-color:var(--sky);background:rgba(255,255,255,.12);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .search-btn{
      padding:12px 20px;background:linear-gradient(135deg,var(--blue),var(--cyan));
      color:#fff;border:none;border-radius:12px;font-size:13px;font-weight:800;
      cursor:pointer;transition:all .2s;white-space:nowrap;font-family:inherit;
      box-shadow:0 4px 14px rgba(29,78,216,.35);
    }
    .search-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(29,78,216,.45)}

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .main{max-width:1300px;margin:0 auto;padding:24px;display:flex;flex-direction:column;gap:20px}

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EMPTY STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .empty-state{
      text-align:center;padding:60px 24px;color:var(--slate);
      background:var(--card);border-radius:var(--r);border:1px solid var(--border);
    }
    .empty-icon{font-size:52px;margin-bottom:16px;opacity:.7}
    .empty-state h3{font-size:18px;font-weight:800;margin-bottom:6px;color:var(--navy)}
    .empty-state p{font-size:13px;opacity:.8}

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EMPLOYEE HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .emp-header{
      background:linear-gradient(135deg,var(--navy),#1e3a5f);
      border-radius:var(--r);padding:20px 24px;
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      box-shadow:var(--shadow);
    }
    .emp-avatar{
      width:52px;height:52px;border-radius:14px;flex-shrink:0;
      background:linear-gradient(135deg,var(--blue),var(--cyan));
      display:flex;align-items:center;justify-content:center;
      font-size:22px;font-weight:900;color:#fff;
      box-shadow:0 4px 14px rgba(29,78,216,.35);
    }
    .emp-details{flex:1;min-width:0}
    .emp-name{font-size:20px;font-weight:900;color:#fff;letter-spacing:-.3px;line-height:1.2}
    .emp-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .emp-badge{
      display:inline-flex;align-items:center;gap:5px;
      background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);
      color:rgba(255,255,255,.9);border-radius:8px;padding:3px 10px;
      font-size:11px;font-weight:700;
    }
    .change-id-btn{
      display:inline-flex;align-items:center;gap:4px;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);
      color:rgba(255,255,255,.7);border-radius:8px;padding:3px 10px;
      font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;margin-top:6px;
      font-family:inherit;
    }
    .change-id-btn:hover{background:rgba(255,255,255,.15);color:#fff}
    .month-nav{display:flex;align-items:center;gap:8px;flex-shrink:0}
    .month-btn{
      width:34px;height:34px;border-radius:10px;
      background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);
      color:#fff;font-size:16px;cursor:pointer;transition:all .2s;
      display:flex;align-items:center;justify-content:center;font-family:inherit;
    }
    .month-btn:hover{background:rgba(255,255,255,.2)}
    .month-btn:disabled{opacity:.3;cursor:default}
    .month-select{
      background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);
      color:#fff;border-radius:10px;padding:6px 12px;
      font-size:12px;font-weight:700;cursor:pointer;
      font-family:inherit;appearance:none;-webkit-appearance:none;outline:none;
      min-width:120px;text-align:center;
    }
    .month-select option{background:#0a1628;color:#fff}

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTENT GRID ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .content-grid{display:grid;grid-template-columns:1fr 300px;gap:20px;align-items:start}
    @media(min-width:1100px){.content-grid{grid-template-columns:1fr 340px}}
    @media(max-width:768px){.content-grid{grid-template-columns:1fr}}

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CALENDAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .calendar-card{background:var(--card);border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden}
    .cal-head{
      display:grid;grid-template-columns:repeat(7,1fr);
      background:var(--navy);
    }
    .cal-head div{
      padding:10px 4px;text-align:center;
      font-weight:800;color:rgba(255,255,255,.7);font-size:11px;letter-spacing:.5px;
    }
    .cal-body{display:grid;grid-template-columns:repeat(7,1fr)}
    .cal-day{
      border-right:1px solid var(--border);border-bottom:1px solid var(--border);
      padding:6px 4px;background:#fff;min-height:72px;
      display:flex;flex-direction:column;align-items:center;gap:2px;
      transition:background .15s;position:relative;
    }
    .cal-day.empty{background:#fafbfc}
    .cal-day.today::after{
      content:'';position:absolute;inset:0;
      border:2px solid var(--blue);border-radius:2px;pointer-events:none;
    }
    .cal-day.s-morning  {border-top:3px solid var(--amber);background:#fffbf0}
    .cal-day.s-afternoon{border-top:3px solid var(--orange);background:#fff8f5}
    .cal-day.s-night    {border-top:3px solid var(--violet);background:#faf5ff}
    .cal-day.s-off      {border-top:3px solid #94a3b8;background:#f8fafc}
    .cal-day.s-leave    {border-top:3px solid #22c55e;background:#f0fdf4}
    .cal-day.s-training {border-top:3px solid var(--sky);background:#f0f9ff}
    .cal-day.s-standby  {border-top:3px solid #ec4899;background:#fdf2f8}
    .cal-day.s-other    {border-top:3px solid #9ca3af}
    .d-num{font-size:13px;font-weight:900;color:var(--navy);line-height:1}
    .d-icon{font-size:18px;line-height:1}
    .d-code{
      font-size:9px;font-weight:800;
      background:rgba(10,22,40,.06);color:var(--slate);
      border-radius:5px;padding:1px 5px;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDE PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .side-panel{display:flex;flex-direction:column;gap:16px;position:sticky;top:76px}

    /* STATS CARD */
    .stats-card{background:var(--card);border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden}
    .stats-header{
      padding:14px 18px;background:linear-gradient(135deg,#f8fafc,#fff);
      border-bottom:1px solid var(--border);
    }
    .stats-title{font-size:10px;font-weight:800;color:var(--slate);text-transform:uppercase;letter-spacing:.8px}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border)}
    .stat-item{
      background:var(--card);padding:14px 16px;
      display:flex;align-items:center;gap:12px;
    }
    .stat-dot{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
    .stat-info{}
    .stat-val{font-size:20px;font-weight:900;color:var(--navy);line-height:1}
    .stat-lbl{font-size:10px;font-weight:700;color:var(--slate);margin-top:2px}
    .stat-full{grid-column:1/-1}

    /* ACTIONS CARD */
    .actions-card{background:var(--card);border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden}
    .actions-header{padding:14px 18px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,#f8fafc,#fff)}
    .actions-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border)}
    .act-btn{
      background:var(--card);padding:14px 12px;
      display:flex;flex-direction:column;align-items:center;gap:6px;
      cursor:pointer;transition:all .2s;border:none;font-family:inherit;
    }
    .act-btn:hover{background:#f8fafc}
    .act-icon{font-size:22px}
    .act-label{font-size:10px;font-weight:800;color:var(--slate)}
    .act-btn-full{
      grid-column:1/-1;background:linear-gradient(135deg,var(--blue),var(--cyan));
      color:#fff;padding:14px;display:flex;align-items:center;justify-content:center;gap:8px;
      cursor:pointer;border:none;font-family:inherit;font-size:13px;font-weight:800;
      transition:all .2s;
    }
    .act-btn-full:hover{filter:brightness(1.08)}

    /* LEGEND */
    .legend-card{background:var(--card);border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:14px 18px}
    .legend-title{font-size:10px;font-weight:800;color:var(--slate);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px}
    .legend-grid{display:flex;flex-wrap:wrap;gap:6px}
    .leg-item{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:700;color:var(--slate)}
    .leg-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

    /* MOBILE ONLY */
    .mobile-stats{display:none}
    @media(max-width:768px){
      .side-panel{display:none}
      .mobile-stats{display:block;margin-top:16px}
      .stats-grid-mob{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
      .stat-mob{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 8px;text-align:center}
      .stat-mob .val{font-size:20px;font-weight:900;color:var(--navy)}
      .stat-mob .lbl{font-size:9px;font-weight:700;color:var(--slate);margin-top:2px}
      .actions-mob{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
      .act-mob{background:var(--card);border:1.5px solid var(--border);border-radius:12px;padding:10px 6px;text-align:center;cursor:pointer;font-family:inherit;transition:all .2s}
      .act-mob:hover{border-color:var(--blue);transform:translateY(-1px)}
      .act-mob .ico{font-size:18px}
      .act-mob .lbl{font-size:10px;font-weight:800;color:var(--slate);display:block;margin-top:4px}
    }

    /* LOADING */
    .loading{text-align:center;padding:60px 24px;color:var(--slate);background:var(--card);border-radius:var(--r);border:1px solid var(--border)}
    .spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 14px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* SAVE POPUP */
    .save-popup{
      position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
      background:var(--navy);color:#fff;border-radius:16px;
      padding:16px 20px;box-shadow:0 12px 40px rgba(10,22,40,.35);
      z-index:9999;max-width:340px;width:92%;
      animation:slideUp .35s cubic-bezier(.34,1.56,.64,1);
      border:1px solid rgba(255,255,255,.1);
    }
    @keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(24px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
    .save-popup p{font-size:13px;font-weight:600;margin-bottom:12px;line-height:1.5}
    .save-popup-btns{display:flex;gap:8px}
    .popup-yes{flex:1;padding:9px;background:linear-gradient(135deg,var(--blue),var(--cyan));
      color:#fff;border:none;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;font-family:inherit}
    .popup-no{flex:1;padding:9px;background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.8);border:1px solid rgba(255,255,255,.15);border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit}

    @media print{
      body{background:#fff}
      .topbar,.search-section,.actions-card,.actions-mob,.topbar-btns{display:none!important}
    }
  </style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-brand">
    <div class="topbar-icon">üìÖ</div>
    <div>
      <div class="topbar-title" id="ttl">My Schedule</div>
      <div class="topbar-sub" id="sub">Enter your Employee ID</div>
    </div>
  </div>
  <div class="topbar-btns">
    <button class="topbar-btn" onclick="toggleLang()">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
    <button class="topbar-btn" onclick="goBack()">‚Üê Back</button>
  </div>
</div>

<!-- SEARCH -->
<div class="search-section">
  <div class="search-label" id="search-lbl">Employee ID</div>
  <form class="search-row" id="searchForm">
    <input type="text" class="search-input" id="empId"
      placeholder="e.g. 12345" pattern="[0-9]+" required>
    <button type="submit" class="search-btn" id="sbtn">üìÖ View</button>
  </form>
</div>

<!-- MAIN -->
<div class="main" id="area">
  <div class="empty-state">
    <div class="empty-icon">üîç</div>
    <h3 id="e1">Search your schedule</h3>
    <p id="e2">Enter your Employee ID above to view your monthly roster</p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let data=null,month=null,months=[],lang='en';

const COLORS={
  Morning:      {strip:'#f59e0b',icon:'‚òÄÔ∏è',dot:'#f59e0b',bg:'#fffbf0'},
  Afternoon:    {strip:'#f97316',icon:'üå§Ô∏è',dot:'#f97316',bg:'#fff8f5'},
  Night:        {strip:'#7c3aed',icon:'üåô',dot:'#7c3aed',bg:'#faf5ff'},
  'Off Day':    {strip:'#94a3b8',icon:'üõå',dot:'#94a3b8',bg:'#f8fafc'},
  'Annual Leave':{strip:'#22c55e',icon:'‚úàÔ∏è',dot:'#22c55e',bg:'#f0fdf4'},
  'Sick Leave': {strip:'#22c55e',icon:'ü§í',dot:'#22c55e',bg:'#f0fdf4'},
  Training:     {strip:'#3b82f6',icon:'üìö',dot:'#3b82f6',bg:'#f0f9ff'},
  Standby:      {strip:'#ec4899',icon:'üßç',dot:'#ec4899',bg:'#fdf2f8'},
  Other:        {strip:'#9ca3af',icon:'‚ùì',dot:'#9ca3af',bg:'#f9fafb'}
};

const STAT_META=[
  {k:'work',  icon:'üíº',bg:'#eff6ff',label_en:'Work Days',label_ar:'ÿ£ŸäÿßŸÖ ÿπŸÖŸÑ'},
  {k:'off',   icon:'üõå',bg:'#f8fafc',label_en:'Days Off',label_ar:'ÿ•ÿ¨ÿßÿ≤ÿßÿ™'},
  {k:'morning',icon:'‚òÄÔ∏è',bg:'#fffbf0',label_en:'Morning',label_ar:'ÿµÿ®ÿßÿ≠Ÿä'},
  {k:'afternoon',icon:'üå§Ô∏è',bg:'#fff8f5',label_en:'Afternoon',label_ar:'ŸÖÿ≥ÿßÿ¶Ÿä'},
  {k:'night', icon:'üåô',bg:'#faf5ff',label_en:'Night',label_ar:'ŸÑŸäŸÑŸä'},
  {k:'standby',icon:'üßç',bg:'#fdf2f8',label_en:'Standby',label_ar:'ÿßÿ≠ÿ™Ÿäÿßÿ∑'},
  {k:'leaves',icon:'‚úàÔ∏è',bg:'#f0fdf4',label_en:'Leaves',label_ar:'ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ≥ŸÜŸàŸäÿ©'},
];

const T={
  en:{
    title:'My Schedule',sub:'Enter your Employee ID',searchLbl:'Employee ID',
    back:'‚Üê Back',langBtn:'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
    ph:'e.g. 12345',sbtn:'üìÖ View',
    e1:'Search your schedule',e2:'Enter your Employee ID above to view your monthly roster',
    loading:'Loading...',notFound:'Employee not found',
    notFoundSub:'ID not in the system. Please check and try again.',
    statsTitle:'STATISTICS',actionsTitle:'ACTIONS',legendTitle:'LEGEND',
    pdf:'PDF',img:'Image',share:'Share',print:'Print',ics:'ICS',
    days:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
    months:['January','February','March','April','May','June',
            'July','August','September','October','November','December'],
    legend:{Morning:'Morning',Afternoon:'Afternoon',Night:'Night',
            'Off Day':'Day Off','Annual Leave':'Annual Leave','Sick Leave':'Sick Leave',
            Training:'Training',Standby:'Standby',Other:'Other'}
  },
  ar:{
    title:'ÿ¨ÿØŸàŸÑŸä',sub:'ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖŸÉ ÿßŸÑŸàÿ∏ŸäŸÅŸä',searchLbl:'ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä',
    back:'ÿ±ÿ¨Ÿàÿπ ‚Üê',langBtn:'English',
    ph:'ŸÖÿ´ÿßŸÑ: 12345',sbtn:'üìÖ ÿπÿ±ÿ∂',
    e1:'ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ¨ÿØŸàŸÑŸÉ',e2:'ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖŸÉ ÿßŸÑŸàÿ∏ŸäŸÅŸä ÿ£ÿπŸÑÿßŸá ŸÑÿπÿ±ÿ∂ ŸÖŸÜÿßŸàÿ®ÿßÿ™ŸÉ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©',
    loading:'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...',notFound:'ŸÑŸÖ ŸäŸèÿπÿ´ÿ± ÿπŸÑŸâ ŸÖŸàÿ∏ŸÅ',
    notFoundSub:'ÿßŸÑÿ±ŸÇŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ. ÿ™ÿ≠ŸÇŸÇ Ÿàÿ£ÿπÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©.',
    statsTitle:'ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™',actionsTitle:'ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™',legendTitle:'ÿßŸÑÿØŸÑŸäŸÑ',
    pdf:'PDF',img:'ÿµŸàÿ±ÿ©',share:'ŸÖÿ¥ÿßÿ±ŸÉÿ©',print:'ÿ∑ÿ®ÿßÿπÿ©',ics:'ICS',
    days:['ÿßŸÑÿ£ÿ≠','ÿßŸÑÿßÿ´','ÿßŸÑÿ´ŸÑ','ÿßŸÑÿ£ÿ±','ÿßŸÑÿÆŸÖ','ÿßŸÑÿ¨ŸÖ','ÿßŸÑÿ≥ÿ®'],
    months:['ŸäŸÜÿßŸäÿ±','ŸÅÿ®ÿ±ÿßŸäÿ±','ŸÖÿßÿ±ÿ≥','ÿ£ÿ®ÿ±ŸäŸÑ','ŸÖÿßŸäŸà','ŸäŸàŸÜŸäŸà',
            'ŸäŸàŸÑŸäŸà','ÿ£ÿ∫ÿ≥ÿ∑ÿ≥','ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±','ÿ£ŸÉÿ™Ÿàÿ®ÿ±','ŸÜŸàŸÅŸÖÿ®ÿ±','ÿØŸäÿ≥ŸÖÿ®ÿ±'],
    legend:{Morning:'ÿµÿ®ÿßÿ≠Ÿä',Afternoon:'ŸÖÿ≥ÿßÿ¶Ÿä',Night:'ŸÑŸäŸÑŸä',
            'Off Day':'ÿ•ÿ¨ÿßÿ≤ÿ©','Annual Leave':'ÿ≥ŸÜŸàŸäÿ©','Sick Leave':'ŸÖÿ±ÿ∂Ÿäÿ©',
            Training:'ÿ™ÿØÿ±Ÿäÿ®',Standby:'ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä',Other:'ÿ£ÿÆÿ±Ÿâ'}
  }
};

function t(k){return T[lang][k]}

function applyLangUI(){
  document.documentElement.lang=lang;
  document.documentElement.dir=lang==='ar'?'rtl':'ltr';
  document.body.classList.toggle('ar',lang==='ar');
  document.getElementById('ttl').textContent=t('title');
  document.getElementById('sub').textContent=t('sub');
  document.getElementById('search-lbl').textContent=t('searchLbl');
  document.querySelector('.topbar-btn').textContent=t('langBtn');
  document.querySelectorAll('.topbar-btn')[1].textContent=t('back');
  document.getElementById('empId').placeholder=t('ph');
  document.getElementById('sbtn').textContent=t('sbtn');
  const e1=document.getElementById('e1'),e2=document.getElementById('e2');
  if(e1)e1.textContent=t('e1');
  if(e2)e2.textContent=t('e2');
  if(data)renderSchedule();
}
function toggleLang(){lang=lang==='en'?'ar':'en';applyLangUI();}

function goBack(){
  const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
  if(document.referrer&&document.referrer.includes(location.host))history.back();
  else location.href=base;
}

document.getElementById('searchForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const id=document.getElementById('empId').value.trim();
  if(id)await loadSchedule(id);
});

async function loadSchedule(id){
  document.getElementById('area').innerHTML=
    `<div class="loading"><div class="spinner"></div><p>${t('loading')}</p></div>`;
  try{
    const res=await fetch(`../schedules/${id}.json`);
    if(!res.ok)throw new Error();
    data=await res.json();
    months=Object.keys(data.schedules).sort();
    if(!months.length)throw new Error();
    const savedId=localStorage.getItem('savedEmpId');
    if(!savedId)showSavePopup(id,data.name);
    const _now=new Date();
    const _cur=_now.getFullYear()+'-'+String(_now.getMonth()+1).padStart(2,'0');
    month=months.includes(_cur)?_cur:months[months.length-1];
    renderSchedule();
  }catch{
    document.getElementById('area').innerHTML=`
      <div class="empty-state">
        <div class="empty-icon">‚ùå</div>
        <h3>${t('notFound')}</h3>
        <p>${t('notFoundSub')}</p>
      </div>`;
  }
}

function showSavePopup(id,name){
  var old=document.getElementById('savePopup');
  if(old)old.remove();
  var firstName=name?name.split(' ')[0]:id;
  var popup=document.createElement('div');
  popup.className='save-popup';popup.id='savePopup';
  popup.innerHTML=`
    <p>üëã ŸáŸÑ ÿ£ŸÜÿ™ <strong>${firstName}</strong>ÿü<br>
    <span style="font-weight:400;font-size:12px;opacity:.75;">ÿßÿ≠ŸÅÿ∏ ÿ±ŸÇŸÖŸÉ ŸÑÿ™ÿµŸÑ ŸÑÿ¨ÿØŸàŸÑŸÉ ÿ®ÿ≥ÿ±ÿπÿ© ŸÅŸä ÿßŸÑŸÖÿ±ÿßÿ™ ÿßŸÑŸÇÿßÿØŸÖÿ©</span></p>
    <div class="save-popup-btns">
      <button class="popup-yes" onclick="confirmSave('${id}')">‚úÖ ŸÜÿπŸÖÿå ÿßÿ≠ŸÅÿ∏ ÿ±ŸÇŸÖŸä</button>
      <button class="popup-no" onclick="dismissPopup()">ŸÅŸÇÿ∑ ÿ£ÿ™ÿµŸÅÿ≠</button>
    </div>`;
  document.body.appendChild(popup);
  setTimeout(()=>dismissPopup(),10000);
}
function confirmSave(id){localStorage.setItem('savedEmpId',id);dismissPopup();renderSchedule();}
function dismissPopup(){var p=document.getElementById('savePopup');if(p)p.remove();}
function changeMyId(){
  if(confirm(lang==='ar'?'ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ∫ŸäŸäÿ± ÿ±ŸÇŸÖŸÉ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿü':'Change your saved Employee ID?')){
    localStorage.removeItem('savedEmpId');renderSchedule();
  }
}
function setAsMyId(){if(data&&data.id){localStorage.setItem('savedEmpId',data.id);renderSchedule();}}

function renderSchedule(){
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const ci=months.indexOf(month);
  const hasPrev=ci>0,hasNext=ci<months.length-1;
  const firstDow=new Date(yr,mo-1,1).getDay();
  const dim=new Date(yr,mo,0).getDate();
  const stats=calcStats(sched);
  const savedId=localStorage.getItem('savedEmpId');
  const isMyId=savedId===data.id;

  // Calendar cells
  let cells='',dc=1;
  const nowD=new Date();
  for(let w=0;w<6;w++){
    for(let d=0;d<7;d++){
      if((w===0&&d<firstDow)||dc>dim){
        cells+='<div class="cal-day empty"></div>';
      }else{
        const dd=sched.find(s=>s.day===dc);
        const sc=dd?shiftClass(dd.shift_group):'';
        const icon=dd?(COLORS[dd.shift_group]?.icon||''):'';
        const code=dd&&dd.shift_code?'<div class="d-code">'+esc(dd.shift_code)+'</div>':'';
        const todayCls=(nowD.getFullYear()===yr&&nowD.getMonth()+1===mo&&nowD.getDate()===dc)?' today':'';
        cells+='<div class="cal-day '+sc+todayCls+'">'
          +'<div class="d-num">'+dc+'</div>'
          +(icon?'<div class="d-icon">'+icon+'</div>':'')+code+'</div>';
        dc++;
      }
    }
    if(dc>dim)break;
  }

  // Day headers
  const dayHdr=T[lang].days.map(d=>'<div>'+d+'</div>').join('');

  // Month options
  const monthOpts=months.map(m=>{
    const p=m.split('-').map(Number);
    const label=T[lang].months[p[1]-1]+' '+p[0];
    return '<option value="'+m+'"'+(m===month?' selected':'')+'>'+label+'</option>';
  }).join('');

  // Legend
  const used=[...new Set(sched.map(s=>s.shift_group))];
  const legHTML=used.map(g=>{
    const c=COLORS[g];if(!c)return '';
    return '<span class="leg-item"><span class="leg-dot" style="background:'+c.dot+'"></span>'+(T[lang].legend[g]||g)+'</span>';
  }).join('');

  // Stats grid (desktop)
  const statsItemsHTML=STAT_META.map(m=>`
    <div class="stat-item${m.k==='work'?' stat-full':''}">
      <div class="stat-dot" style="background:${m.bg}">${m.icon}</div>
      <div class="stat-info">
        <div class="stat-val">${stats[m.k]}</div>
        <div class="stat-lbl">${lang==='ar'?m.label_ar:m.label_en}</div>
      </div>
    </div>`).join('');

  // Change ID button
  const changeBtn=isMyId
    ?`<button class="change-id-btn" onclick="changeMyId()">‚úèÔ∏è ${lang==='ar'?'ÿ™ÿ∫ŸäŸäÿ± ÿ±ŸÇŸÖŸä':'Change My ID'}</button>`
    :(!savedId?'':`<button class="change-id-btn" onclick="setAsMyId()">üìå ${lang==='ar'?'ÿßÿ≠ŸÅÿ∏ ŸÉÿ±ŸÇŸÖŸä':'Set as My ID'}</button>`);

  // Avatar initials
  const initials=(data.name||'?').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();

  // Mobile stats
  const mobStats=STAT_META.map(m=>`
    <div class="stat-mob">
      <div class="val">${stats[m.k]}</div>
      <div class="lbl">${lang==='ar'?m.label_ar:m.label_en}</div>
    </div>`).join('');

  document.getElementById('area').innerHTML=`
    <!-- EMP HEADER -->
    <div class="emp-header">
      <div style="display:flex;align-items:center;gap:14px;flex:1;min-width:0">
        <div class="emp-avatar">${initials}</div>
        <div class="emp-details">
          <div class="emp-name">${esc(data.name)}</div>
          <div class="emp-meta">
            <span class="emp-badge">üìã ${esc(data.department)}</span>
            <span class="emp-badge">üÜî ${esc(data.id)}</span>
          </div>
          ${changeBtn}
        </div>
      </div>
      <div class="month-nav">
        <button class="month-btn" onclick="chMonth(-1)" ${!hasPrev?'disabled':''}>&#8249;</button>
        <select class="month-select" onchange="jumpMonth(this.value)">${monthOpts}</select>
        <button class="month-btn" onclick="chMonth(1)" ${!hasNext?'disabled':''}>&#8250;</button>
      </div>
    </div>

    <!-- CONTENT GRID -->
    <div class="content-grid">

      <!-- LEFT: CALENDAR -->
      <div>
        <div class="calendar-card">
          <div class="cal-head">${dayHdr}</div>
          <div class="cal-body">${cells}</div>
        </div>

        <!-- LEGEND (below calendar) -->
        <div class="legend-card" style="margin-top:12px">
          <div class="legend-title">${t('legendTitle')}</div>
          <div class="legend-grid">${legHTML}</div>
        </div>

        <!-- MOBILE STATS & ACTIONS -->
        <div class="mobile-stats">
          <div class="stats-title" style="font-size:10px;font-weight:800;color:var(--slate);text-transform:uppercase;letter-spacing:.8px">${t('statsTitle')}</div>
          <div class="stats-grid-mob">${mobStats}</div>
          <div class="actions-mob" style="margin-top:12px">
            <button class="act-mob" onclick="dlPDF()"><span class="ico">üì•</span><span class="lbl">${t('pdf')}</span></button>
            <button class="act-mob" onclick="dlICS()"><span class="ico">üìÜ</span><span class="lbl">${t('ics')}</span></button>
            <button class="act-mob" onclick="dlIMG()"><span class="ico">üñºÔ∏è</span><span class="lbl">${t('img')}</span></button>
            <button class="act-mob" onclick="shareS()"><span class="ico">üîó</span><span class="lbl">${t('share')}</span></button>
            <button class="act-mob" onclick="window.print()"><span class="ico">üñ®Ô∏è</span><span class="lbl">${t('print')}</span></button>
          </div>
        </div>
      </div>

      <!-- RIGHT: SIDE PANEL -->
      <div class="side-panel">
        <!-- STATS -->
        <div class="stats-card">
          <div class="stats-header"><div class="stats-title">${t('statsTitle')}</div></div>
          <div class="stats-grid">${statsItemsHTML}</div>
        </div>

        <!-- ACTIONS -->
        <div class="actions-card">
          <div class="actions-header"><div class="stats-title">${t('actionsTitle')}</div></div>
          <div class="actions-grid">
            <button class="act-btn act-btn-full" onclick="dlPDF()">üì• ${t('pdf')}</button>
            <button class="act-btn" onclick="dlICS()"><span class="act-icon">üìÜ</span><span class="act-label">${t('ics')}</span></button>
            <button class="act-btn" onclick="dlIMG()"><span class="act-icon">üñºÔ∏è</span><span class="act-label">${t('img')}</span></button>
            <button class="act-btn" onclick="shareS()"><span class="act-icon">üîó</span><span class="act-label">${t('share')}</span></button>
            <button class="act-btn" onclick="window.print()"><span class="act-icon">üñ®Ô∏è</span><span class="act-label">${t('print')}</span></button>
          </div>
        </div>
      </div>

    </div>`;
}

function chMonth(dir){const ci=months.indexOf(month),ni=ci+dir;if(ni>=0&&ni<months.length){month=months[ni];renderSchedule();}}
function jumpMonth(val){if(months.includes(val)){month=val;renderSchedule();}}

function calcStats(s){
  const r={work:0,off:0,morning:0,afternoon:0,night:0,standby:0,leaves:0};
  s.forEach(d=>{
    if(d.shift_group==='Morning')r.morning++;
    else if(d.shift_group==='Afternoon')r.afternoon++;
    else if(d.shift_group==='Night')r.night++;
    else if(d.shift_group==='Off Day')r.off++;
    else if(d.shift_group==='Standby')r.standby++;
    else if(d.shift_group==='Annual Leave'||d.shift_group==='Sick Leave')r.leaves++;
  });
  r.work=r.morning+r.afternoon+r.night;
  return r;
}
function shiftClass(g){
  return{Morning:'s-morning',Afternoon:'s-afternoon',Night:'s-night',
         'Off Day':'s-off','Annual Leave':'s-leave','Sick Leave':'s-leave',
         Training:'s-training',Standby:'s-standby',Other:'s-other'}[g]||'s-other';
}
function esc(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

/* ‚îÄ‚îÄ IMAGE DOWNLOAD ‚îÄ‚îÄ */
async function dlIMG(){
  if(!window.html2canvas){alert('Image library loading, please try again.');return}
  const calEl=document.querySelector('.calendar-card');
  const statsEl=document.querySelector('.stats-card');
  const legendEl=document.querySelector('.legend-card');
  if(!calEl){alert('No calendar to capture.');return}
  const [yr,mo]=month.split('-').map(Number);
  const mName=T[lang].months[mo-1]+' '+yr;
  const W=calEl.offsetWidth;
  const wrap=document.createElement('div');
  wrap.style.cssText=`position:fixed;left:-9999px;top:0;background:#f8fafc;padding:0;border-radius:16px;overflow:hidden;font-family:'Plus Jakarta Sans',system-ui,sans-serif;width:${W+32}px;`;
  const hdr=document.createElement('div');
  hdr.style.cssText='background:linear-gradient(135deg,#0a1628,#1e3a5f);padding:16px 20px;display:flex;align-items:center;justify-content:space-between;';
  hdr.innerHTML=`<div><div style="color:#fff;font-size:18px;font-weight:900">${esc(data.name)}</div><div style="color:rgba(255,255,255,.7);font-size:11px;font-weight:600;margin-top:3px">üìã ${esc(data.department)} ¬∑ üÜî ${esc(data.id)}</div></div><div style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:10px;padding:6px 14px;font-size:12px;font-weight:800">${mName}</div>`;
  wrap.appendChild(hdr);
  const calWrap=document.createElement('div');
  calWrap.style.cssText='background:#fff;padding:12px 16px 8px;';
  calWrap.appendChild(calEl.cloneNode(true));
  wrap.appendChild(calWrap);
  if(legendEl){const lw=document.createElement('div');lw.style.cssText='background:#fff;padding:0 16px 12px;';lw.appendChild(legendEl.cloneNode(true));wrap.appendChild(lw);}
  if(statsEl){const sw=document.createElement('div');sw.style.cssText='background:#fff;padding:0 16px 16px;';sw.appendChild(statsEl.cloneNode(true));wrap.appendChild(sw);}
  document.body.appendChild(wrap);
  try{
    const canvas=await html2canvas(wrap,{scale:3,useCORS:true,backgroundColor:'#f8fafc',logging:false});
    const link=document.createElement('a');link.download=`schedule-${data.id}-${month}.png`;link.href=canvas.toDataURL('image/png');link.click();
  }catch(e){alert('Image capture failed: '+e.message);}
  finally{document.body.removeChild(wrap);}
}

/* ‚îÄ‚îÄ ICS ‚îÄ‚îÄ */
function dlICS(){
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const pad=n=>String(n).padStart(2,'0');
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//MySchedule//EN','CALSCALE:GREGORIAN'];
  sched.forEach(d=>{
    const dt=`${yr}${pad(mo)}${pad(d.day)}`;
    const dtNext=new Date(yr,mo-1,d.day+1);
    const dtE=`${dtNext.getFullYear()}${pad(dtNext.getMonth()+1)}${pad(dtNext.getDate())}`;
    const sum=d.shift_code||d.shift_group;
    lines.push('BEGIN:VEVENT',`DTSTART;VALUE=DATE:${dt}`,`DTEND;VALUE=DATE:${dtE}`,`SUMMARY:${sum}`,`UID:${dt}-${data.id}-${d.day}@myschedule`,'END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  const blob=new Blob([lines.join('\r\n')],{type:'text/calendar'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`schedule-${data.id}-${month}.ics`;a.click();URL.revokeObjectURL(a.href);
}

/* ‚îÄ‚îÄ PDF ‚îÄ‚îÄ */
function dlPDF(){
  if(!window.jspdf){alert('PDF library loading, please try again.');return}
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210,H=297,ML=7,MR=7;
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const mName=T.en.months[mo-1];
  const stats=calcStats(sched);
  const SC={Morning:{fg:[200,90,0],bg:[255,243,224]},Afternoon:{fg:[180,45,5],bg:[255,235,218]},Night:{fg:[20,55,190],bg:[224,230,255]},'Off Day':{fg:[85,95,115],bg:[238,240,245]},'Annual Leave':{fg:[10,125,60],bg:[218,248,230]},'Sick Leave':{fg:[10,125,60],bg:[218,248,230]},Training:{fg:[10,85,190],bg:[218,238,255]},Standby:{fg:[148,10,110],bg:[250,218,242]},Other:{fg:[90,100,115],bg:[240,241,246]}};
  const FALLBACK={'Off Day':'OFF','Annual Leave':'LV','Sick Leave':'SL',Training:'TR',Standby:'ST',Other:'‚Äî'};
  const LNAMES={Morning:'Morning',Afternoon:'Afternoon',Night:'Night','Off Day':'Day Off','Annual Leave':'Leave','Sick Leave':'Sick',Training:'Training',Standby:'Standby',Other:'Other'};
  const NAVY=[10,22,40],WHITE=[255,255,255],RULE=[195,202,215],EMPTY=[244,245,249],DIM=[105,115,132];
  const HDR_H=30,CAL_HDR=9,STATS_H=42,FOOT_H=10,GAP1=3,GAP2=4;
  const CAL_TOP=HDR_H+GAP1,STATS_TOP=H-FOOT_H-GAP2-STATS_H,CAL_BOT=STATS_TOP-GAP2,CAL_BODY=CAL_BOT-CAL_TOP-CAL_HDR;
  const firstDow=new Date(yr,mo-1,1).getDay(),dim=new Date(yr,mo,0).getDate();
  const now=new Date(),thisMo=now.getFullYear()===yr&&now.getMonth()+1===mo;
  let nRows=0;{let d2=1;for(let w=0;w<6;w++){let any=false;for(let d=0;d<7;d++)if(!((w===0&&d<firstDow)||d2>dim)){any=true;d2++;}if(any)nRows++;if(d2>dim)break;}}
  const CH=Math.floor(CAL_BODY/nRows),CW=(W-ML-MR)/7;
  doc.setFillColor(...NAVY);doc.rect(0,0,W,HDR_H,'F');
  doc.setTextColor(...WHITE);doc.setFontSize(17);doc.setFont(undefined,'bold');doc.text(String(data.name),ML,13);
  doc.setFontSize(8.5);doc.setFont(undefined,'normal');doc.setTextColor(165,188,235);doc.text(`${data.department}   ¬∑   ID: ${data.id}`,ML,21);
  doc.setFillColor(...WHITE);doc.roundedRect(W-MR-55,9,55,14,3,3,'F');doc.setTextColor(...NAVY);doc.setFontSize(10.5);doc.setFont(undefined,'bold');doc.text(`${mName}  ${yr}`,W-MR-27.5,18,{align:'center'});
  doc.setFillColor(...NAVY);doc.rect(ML,CAL_TOP,W-ML-MR,CAL_HDR,'F');
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach((d,i)=>{doc.setTextColor(...WHITE);doc.setFontSize(8.5);doc.setFont(undefined,'bold');doc.text(d,ML+i*CW+CW/2,CAL_TOP+6.3,{align:'center'});});
  let dc=1,row=0;doc.setLineWidth(0.22);
  for(let w=0;w<6;w++){
    for(let d=0;d<7;d++){
      const cx=ML+d*CW,cy=CAL_TOP+CAL_HDR+row*CH,isEmpty=(w===0&&d<firstDow)||dc>dim;
      if(isEmpty){doc.setFillColor(...EMPTY);doc.setDrawColor(...RULE);doc.rect(cx,cy,CW,CH,'FD');continue;}
      const dd=sched.find(s=>s.day===dc),sh=dd?(SC[dd.shift_group]||SC.Other):null;
      doc.setFillColor(...(sh?sh.bg:WHITE));doc.setDrawColor(...RULE);doc.rect(cx,cy,CW,CH,'FD');
      const numStr=String(dc);
      let ghostR,ghostG,ghostB;
      if(sh){ghostR=Math.round(sh.bg[0]*0.55+sh.fg[0]*0.45);ghostG=Math.round(sh.bg[1]*0.55+sh.fg[1]*0.45);ghostB=Math.round(sh.bg[2]*0.55+sh.fg[2]*0.45);}else{ghostR=210;ghostG=215;ghostB=225;}
      const ghostSize=Math.round(CH*0.72);doc.setTextColor(ghostR,ghostG,ghostB);doc.setFontSize(ghostSize>38?38:ghostSize<22?22:ghostSize);doc.setFont(undefined,'bold');doc.text(numStr,cx+2.5,cy+ghostSize*0.72,{align:'left'});
      doc.setDrawColor(...RULE);
      if(dd){const code=dd.shift_code||(FALLBACK[dd.shift_group]||'');if(code){const fs=CH>=36?20:CH>=28?18:15;doc.setTextColor(...sh.fg);doc.setFontSize(fs);doc.setFont(undefined,'bold');doc.text(code,cx+CW/2,cy+CH*0.67,{align:'center'});}}
      dc++;
    }
    if(dc>dim)break;row++;
  }
  doc.setDrawColor(...RULE);doc.setLineWidth(0.3);doc.line(ML,STATS_TOP,W-MR,STATS_TOP);
  doc.setTextColor(...NAVY);doc.setFontSize(8);doc.setFont(undefined,'bold');doc.text('STATISTICS',ML,STATS_TOP+5);
  const SL=[{l:'Work Days',v:stats.work,c:NAVY},{l:'Day Off',v:stats.off,c:[85,95,115]},{l:'Morning',v:stats.morning,c:[200,90,0]},{l:'Afternoon',v:stats.afternoon,c:[180,45,5]},{l:'Night',v:stats.night,c:[20,55,190]},{l:'Standby',v:stats.standby,c:[148,10,110]},{l:'Leaves',v:stats.leaves,c:[10,125,60]}];
  const nSt=SL.length,SGAP=2,sW=(W-ML-MR-(nSt-1)*SGAP)/nSt,CARD_Y=STATS_TOP+7,CARD_H=22;
  SL.forEach(({l,v,c},i)=>{const sx=ML+i*(sW+SGAP);doc.setFillColor(247,248,253);doc.setDrawColor(...RULE);doc.setLineWidth(0.2);doc.roundedRect(sx,CARD_Y,sW,CARD_H,2,2,'FD');doc.setFillColor(...c);doc.roundedRect(sx,CARD_Y,sW,3,1,1,'F');doc.setTextColor(...c);doc.setFontSize(18);doc.setFont(undefined,'bold');doc.text(String(v),sx+sW/2,CARD_Y+15,{align:'center'});doc.setTextColor(...DIM);doc.setFontSize(5.8);doc.setFont(undefined,'bold');doc.text(l,sx+sW/2,CARD_Y+20.5,{align:'center'});});
  const LY=CARD_Y+CARD_H+3;const used=[...new Set(sched.map(s=>s.shift_group))];const lStep=(W-ML-MR)/used.length;
  used.forEach((g,i)=>{const sh2=SC[g]||SC.Other;const lx=ML+i*lStep;doc.setFillColor(...sh2.bg);doc.setDrawColor(...sh2.fg);doc.setLineWidth(0.5);doc.roundedRect(lx,LY,lStep-2,6,1.5,1.5,'FD');doc.setTextColor(...sh2.fg);doc.setFontSize(6.5);doc.setFont(undefined,'bold');doc.text(LNAMES[g]||g,lx+(lStep-2)/2,LY+4.1,{align:'center'});});
  doc.setDrawColor(...RULE);doc.setLineWidth(0.25);doc.line(ML,H-6,W-MR,H-6);doc.setTextColor(...DIM);doc.setFontSize(7);doc.setFont(undefined,'normal');doc.text('My Schedule',ML,H-2.5);doc.text(`${mName} ${yr}  ¬∑  ${data.id}`,W-MR,H-2.5,{align:'right'});
  doc.save(`schedule-${data.id}-${month}.pdf`);
}

/* ‚îÄ‚îÄ SHARE ‚îÄ‚îÄ */
function shareS(){
  const id=data.id;
  const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
  const url=`${location.origin}${base}my-schedules/?emp=${encodeURIComponent(id)}`;
  if(navigator.share)navigator.share({title:'My Schedule',text:`Schedule: ${data.name}`,url});
  else{navigator.clipboard.writeText(url);alert('Link copied!');}
}

const p=new URLSearchParams(location.search).get('emp');
if(p){document.getElementById('empId').value=p;loadSchedule(p);}
else{
  const saved=localStorage.getItem('savedEmpId');
  if(saved){document.getElementById('empId').value=saved;loadSchedule(saved);}
}
</script>
</body>
</html>
