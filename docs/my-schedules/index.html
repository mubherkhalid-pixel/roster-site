<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>My Schedule</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#f0f4ff;--card:#fff;--text:#0f172a;--muted:#64748b;
      --border:#e5e7eb;--b1:#1e73ff;--b2:#00b3ff;--b3:#2b59ff;--r:14px;
    }
    body{
      font-family:'Segoe UI',system-ui,sans-serif;
      background:radial-gradient(ellipse 120% 40% at 50% 0%,rgba(30,115,255,.15),transparent 60%),
                 linear-gradient(180deg,var(--bg),#fff 70%);
      min-height:100vh;padding:8px;color:var(--text);font-size:14px;
    }
    .wrap{max-width:520px;margin:0 auto;display:flex;flex-direction:column;gap:8px}

    .hero{
      background:linear-gradient(135deg,var(--b3),var(--b2));
      border-radius:var(--r);padding:11px 13px;position:relative;overflow:hidden;
    }
    .hero::before{
      content:"";position:absolute;top:-40px;right:-40px;
      width:130px;height:130px;border-radius:50%;background:rgba(255,255,255,.12);
    }
    .hero-row{position:relative;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .brand{display:flex;align-items:center;gap:9px}
    .logo{
      width:36px;height:36px;border-radius:10px;
      background:rgba(255,255,255,.22);border:1px solid rgba(255,255,255,.25);
      display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;
    }
    .brand-text h1{color:#fff;font-size:15px;font-weight:800;line-height:1.2}
    .brand-text p{color:rgba(255,255,255,.85);font-size:11px;font-weight:600}
    .hero-btns{display:flex;gap:6px;align-items:center}
    .lang-btn,.back-btn{
      background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);
      color:#fff;border-radius:8px;padding:5px 10px;
      font-size:11px;font-weight:700;cursor:pointer;transition:background .2s;white-space:nowrap;
    }
    .lang-btn:hover,.back-btn:hover{background:rgba(255,255,255,.3)}

    .card{
      background:var(--card);border-radius:var(--r);
      box-shadow:0 4px 20px rgba(2,6,23,.07);border:1px solid var(--border);overflow:hidden;
    }
    .search-area{
      padding:10px 12px;background:linear-gradient(180deg,#fff,#fbfcff);
      border-bottom:1px solid var(--border);
    }
    .search-row{display:flex;gap:7px}
    .search-input{
      flex:1;min-width:0;padding:9px 12px;border:1.5px solid var(--border);
      border-radius:10px;font-size:14px;direction:ltr;background:#fff;
      transition:border-color .2s,box-shadow .2s;
    }
    .search-input:focus{outline:none;border-color:rgba(30,115,255,.7);box-shadow:0 0 0 3px rgba(30,115,255,.1)}
    .search-btn{
      padding:9px 14px;background:linear-gradient(135deg,var(--b3),var(--b2));
      color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:800;
      cursor:pointer;transition:transform .2s,box-shadow .2s;white-space:nowrap;
    }
    .search-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(30,115,255,.28)}

    .content{padding:10px}
    .empty-state{text-align:center;padding:30px 16px;color:var(--muted)}
    .empty-icon{font-size:38px;margin-bottom:8px}
    .empty-state h3{font-size:15px;margin-bottom:4px;color:var(--text)}
    .empty-state p{font-size:12px}

    .emp-bar{
      background:linear-gradient(135deg,var(--b3),var(--b2));color:#fff;
      border-radius:10px;padding:9px 11px;margin-bottom:8px;
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      box-shadow:0 4px 14px rgba(30,115,255,.2);
    }
    .emp-info h2{font-size:14px;font-weight:800;line-height:1.3}
    .emp-info p{font-size:11px;opacity:.9;margin-top:2px}
    .month-nav{display:flex;align-items:center;gap:6px;flex-shrink:0}
    .month-nav button{
      width:30px;height:30px;border-radius:50%;
      background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);
      color:#fff;font-size:15px;cursor:pointer;transition:background .2s;
      display:flex;align-items:center;justify-content:center;
    }
    .month-nav button:hover{background:rgba(255,255,255,.3)}
    .month-nav span{font-size:12px;font-weight:800;min-width:86px;text-align:center}

    /* CALENDAR */
    .calendar{
      background:#fff;border-radius:10px;border:1px solid var(--border);
      overflow:hidden;margin-bottom:8px;
    }
    .cal-head{
      display:grid;grid-template-columns:repeat(7,1fr);
      background:#f8fafc;border-bottom:1.5px solid var(--border);
    }
    .cal-head div{padding:7px 2px;text-align:center;font-weight:800;color:#475569;font-size:10px}
    .cal-body{display:grid;grid-template-columns:repeat(7,1fr)}

    .cal-day{
      border:1px solid #f0f0f0;padding:4px 2px;background:#fff;
      min-height:54px;display:flex;flex-direction:column;align-items:center;
    }
    .cal-day.empty{background:#fafafa}
    .cal-day.today{box-shadow:inset 0 0 0 2px var(--b1);background:#f0f6ff}

    /* coloured top strip per shift ‚Äî no text at all */
    .cal-day.s-morning  {border-top:3px solid #f59e0b}
    .cal-day.s-afternoon{border-top:3px solid #f97316}
    .cal-day.s-night    {border-top:3px solid #7c3aed}
    .cal-day.s-off      {border-top:3px solid #94a3b8}
    .cal-day.s-leave    {border-top:3px solid #22c55e}
    .cal-day.s-training {border-top:3px solid #3b82f6}
    .cal-day.s-standby  {border-top:3px solid #ec4899}
    .cal-day.s-other    {border-top:3px solid #9ca3af}

    .d-num{font-size:12px;font-weight:900;color:#0f172a;margin-bottom:1px;margin-top:1px}
    .d-icon{font-size:16px;line-height:1;margin:2px 0}
    .d-code{font-size:9px;color:var(--muted);font-weight:800;margin-top:2px;background:#f1f5f9;border-radius:4px;padding:1px 4px}

    /* LEGEND */
    .legend{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px}
    .leg-item{display:flex;align-items:center;gap:4px;font-size:10px;font-weight:700;color:var(--muted)}
    .leg-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

    /* STATS */
    .stats{background:#f8fafc;border-radius:10px;border:1px solid var(--border);padding:8px;margin-bottom:8px}
    .stats-title{font-size:10px;font-weight:800;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
    .stats-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:4px}
    @media(max-width:360px){.stats-grid{grid-template-columns:repeat(3,1fr)}}
    .stat-box{background:#fff;border:1px solid var(--border);border-radius:7px;padding:6px 4px;text-align:center}
    .stat-lbl{font-size:9px;color:var(--muted);font-weight:700;margin-bottom:3px}
    .stat-val{font-size:17px;font-weight:900;color:var(--text);line-height:1}

    /* ACTIONS */
    .actions{display:grid;grid-template-columns:repeat(2,1fr);gap:5px}
    .act-btn{
      padding:8px 6px;border:1.5px solid var(--border);background:#fff;
      border-radius:9px;font-size:11px;font-weight:800;cursor:pointer;transition:all .2s;
      display:flex;align-items:center;justify-content:center;gap:5px;white-space:nowrap;
    }
    .act-btn:hover{border-color:rgba(30,115,255,.5);color:var(--b1);transform:translateY(-1px)}
    .act-primary{background:linear-gradient(135deg,var(--b3),var(--b2));color:#fff;border-color:transparent}
    .act-primary:hover{color:#fff;border-color:transparent;box-shadow:0 6px 18px rgba(30,115,255,.26)}
    .act-ics{background:#f0fdf4;border-color:#86efac;color:#166534}
    .act-ics:hover{background:#dcfce7;border-color:#4ade80;color:#166534;transform:translateY(-1px)}

    .loading{text-align:center;padding:30px 16px;color:var(--muted)}
    .spinner{width:32px;height:32px;border:3px solid #e5e7eb;border-top-color:var(--b1);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading p{font-size:12px}

    @media print{
      body{background:#fff;padding:0}
      .hero,.search-area,.actions,.back-btn,.lang-btn{display:none!important}
      .wrap{max-width:100%}
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="hero">
    <div class="hero-row">
      <div class="brand">
        <div class="logo">üìÖ</div>
        <div class="brand-text">
          <h1 id="ttl">My Schedule</h1>
          <p id="sub">Enter your Employee ID to view schedule</p>
        </div>
      </div>
      <div class="hero-btns">
        <button class="lang-btn" onclick="toggleLang()">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
        <button class="back-btn" onclick="goBack()">‚Üê Back</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="search-area">
      <form class="search-row" id="searchForm">
        <input type="text" class="search-input" id="empId"
          placeholder="Employee ID (e.g. 12345)" pattern="[0-9]+" required>
        <button type="submit" class="search-btn" id="sbtn">üìÖ View</button>
      </form>
    </div>
    <div class="content" id="area">
      <div class="empty-state">
        <div class="empty-icon">üîç</div>
        <h3 id="e1">Search your schedule</h3>
        <p id="e2">Enter your Employee ID above</p>
      </div>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let data=null,month=null,months=[],lang='en';

const COLORS={
  Morning:     {strip:'#f59e0b',icon:'‚òÄÔ∏è'},
  Afternoon:   {strip:'#f97316',icon:'üå§Ô∏è'},
  Night:       {strip:'#7c3aed',icon:'üåô'},
  'Off Day':   {strip:'#94a3b8',icon:'üõå'},
  'Annual Leave':{strip:'#22c55e',icon:'‚úàÔ∏è'},
  'Sick Leave':{strip:'#22c55e',icon:'ü§í'},
  Training:    {strip:'#3b82f6',icon:'üìö'},
  Standby:     {strip:'#ec4899',icon:'üßç'},
  Other:       {strip:'#9ca3af',icon:'‚ùì'}
};

const T={
  en:{
    title:'My Schedule',sub:'Enter your Employee ID to view schedule',
    back:'‚Üê Back',langBtn:'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
    ph:'Employee ID (e.g. 12345)',sbtn:'üìÖ View',
    e1:'Search your schedule',e2:'Enter your Employee ID above',
    loading:'Loading...',notFound:'Employee not found',
    notFoundSub:'ID not in the system. Please check and try again.',
    statsTitle:'STATISTICS',
    workDays:'Work',offDays:'Off',morning:'‚òÄÔ∏è',afternoon:'üå§Ô∏è',night:'üåô',leaves:'Leaves',
    pdf:'üì• PDF',share:'üîó Share',print:'üñ®Ô∏è Print',ics:'üìÜ ICS',
    days:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
    months:['January','February','March','April','May','June',
            'July','August','September','October','November','December'],
    legend:{Morning:'Morning',Afternoon:'Afternoon',Night:'Night',
            'Off Day':'Off','Annual Leave':'Leave','Sick Leave':'Sick',
            Training:'Training',Standby:'Standby',Other:'Other'}
  },
  ar:{
    title:'ÿ¨ÿØŸàŸÑŸä',sub:'ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖŸÉ ÿßŸÑŸàÿ∏ŸäŸÅŸä ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ¨ÿØŸàŸÑ',
    back:'ÿ±ÿ¨Ÿàÿπ ‚Üê',langBtn:'English',
    ph:'ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä (ŸÖÿ´ÿßŸÑ: 12345)',sbtn:'üìÖ ÿπÿ±ÿ∂',
    e1:'ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ¨ÿØŸàŸÑŸÉ',e2:'ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖŸÉ ÿßŸÑŸàÿ∏ŸäŸÅŸä ÿ£ÿπŸÑÿßŸá',
    loading:'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...',notFound:'ŸÑŸÖ ŸäŸèÿπÿ´ÿ± ÿπŸÑŸâ ŸÖŸàÿ∏ŸÅ',
    notFoundSub:'ÿßŸÑÿ±ŸÇŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ. ÿ™ÿ≠ŸÇŸÇ Ÿàÿ£ÿπÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©.',
    statsTitle:'ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™',
    workDays:'ÿπŸÖŸÑ',offDays:'ÿ•ÿ¨ÿßÿ≤ÿ©',morning:'‚òÄÔ∏è',afternoon:'üå§Ô∏è',night:'üåô',leaves:'ÿ≥ŸÜŸàŸäÿ©',
    pdf:'üì• PDF',share:'üîó ŸÖÿ¥ÿßÿ±ŸÉÿ©',print:'üñ®Ô∏è ÿ∑ÿ®ÿßÿπÿ©',ics:'üìÜ ICS',
    days:['ÿßŸÑÿ£ÿ≠','ÿßŸÑÿßÿ´','ÿßŸÑÿ´ŸÑ','ÿßŸÑÿ£ÿ±','ÿßŸÑÿÆŸÖ','ÿßŸÑÿ¨ŸÖ','ÿßŸÑÿ≥ÿ®'],
    months:['ŸäŸÜÿßŸäÿ±','ŸÅÿ®ÿ±ÿßŸäÿ±','ŸÖÿßÿ±ÿ≥','ÿ£ÿ®ÿ±ŸäŸÑ','ŸÖÿßŸäŸà','ŸäŸàŸÜŸäŸà',
            'ŸäŸàŸÑŸäŸà','ÿ£ÿ∫ÿ≥ÿ∑ÿ≥','ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±','ÿ£ŸÉÿ™Ÿàÿ®ÿ±','ŸÜŸàŸÅŸÖÿ®ÿ±','ÿØŸäÿ≥ŸÖÿ®ÿ±'],
    legend:{Morning:'ÿµÿ®ÿßÿ≠Ÿä',Afternoon:'ŸÖÿ≥ÿßÿ¶Ÿä',Night:'ŸÑŸäŸÑŸä',
            'Off Day':'ÿ•ÿ¨ÿßÿ≤ÿ©','Annual Leave':'ÿ≥ŸÜŸàŸäÿ©','Sick Leave':'ŸÖÿ±ÿ∂Ÿäÿ©',
            Training:'ÿ™ÿØÿ±Ÿäÿ®',Standby:'ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä',Other:'ÿ£ÿÆÿ±Ÿâ'}
  }
};

function t(k){return T[lang][k]}

function applyLangUI(){
  document.documentElement.lang=lang;
  document.documentElement.dir=lang==='ar'?'rtl':'ltr';
  document.getElementById('ttl').textContent=t('title');
  document.getElementById('sub').textContent=t('sub');
  document.querySelector('.back-btn').textContent=t('back');
  document.querySelector('.lang-btn').textContent=t('langBtn');
  document.getElementById('empId').placeholder=t('ph');
  document.getElementById('sbtn').textContent=t('sbtn');
  const e1=document.getElementById('e1'),e2=document.getElementById('e2');
  if(e1) e1.textContent=t('e1');
  if(e2) e2.textContent=t('e2');
  if(data) renderSchedule();
}
function toggleLang(){lang=lang==='en'?'ar':'en';applyLangUI()}

function goBack(){
  const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
  if(document.referrer&&document.referrer.includes(location.host)) history.back();
  else location.href=base;
}

document.getElementById('searchForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const id=document.getElementById('empId').value.trim();
  if(id) await loadSchedule(id);
});

async function loadSchedule(id){
  document.getElementById('area').innerHTML=
    `<div class="loading"><div class="spinner"></div><p>${t('loading')}</p></div>`;
  try{
    const res=await fetch(`../schedules/${id}.json`);
    if(!res.ok) throw new Error();
    data=await res.json();
    months=Object.keys(data.schedules).sort().reverse();
    if(!months.length) throw new Error();
    month=months[0];
    renderSchedule();
  }catch{
    document.getElementById('area').innerHTML=`
      <div class="empty-state">
        <div class="empty-icon">‚ùå</div>
        <h3>${t('notFound')}</h3>
        <p>${t('notFoundSub')}</p>
      </div>`;
  }
}

function renderSchedule(){
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const mName=T[lang].months[mo-1];
  const ci=months.indexOf(month);
  const hasNext=ci>0,hasPrev=ci<months.length-1;

  const firstDow=new Date(yr,mo-1,1).getDay();
  const daysInMonth=new Date(yr,mo,0).getDate();
  const stats=calcStats(sched);

  /* Calendar cells: ICON + CODE only ‚Äî zero text labels */
  let cells='',dc=1;
  for(let w=0;w<6;w++){
    for(let d=0;d<7;d++){
      if((w===0&&d<firstDow)||dc>daysInMonth){
        cells+='<div class="cal-day empty"></div>';
      }else{
        const dd=sched.find(s=>s.day===dc);
        const today=isToday(yr,mo,dc);
        if(dd){
          const sc=shiftClass(dd.shift_group);
          const icon=COLORS[dd.shift_group]?.icon||'‚ùì';
          cells+=`<div class="cal-day ${sc}${today?' today':''}">
            <div class="d-num">${dc}</div>
            <div class="d-icon">${icon}</div>
            ${dd.shift_code?`<div class="d-code">${esc(dd.shift_code)}</div>`:''}
          </div>`;
        }else{
          cells+=`<div class="cal-day${today?' today':''}"><div class="d-num">${dc}</div></div>`;
        }
        dc++;
      }
    }
    if(dc>daysInMonth) break;
  }

  const dayHdr=T[lang].days.map(d=>`<div>${d}</div>`).join('');

  /* Legend */
  const used=[...new Set(sched.map(s=>s.shift_group))];
  const legHTML=used.map(g=>{
    const c=COLORS[g];if(!c) return '';
    return `<span class="leg-item"><span class="leg-dot" style="background:${c.strip}"></span>${T[lang].legend[g]||g}</span>`;
  }).join('');

  document.getElementById('area').innerHTML=`
    <div class="emp-bar">
      <div class="emp-info">
        <h2>${esc(data.name)}</h2>
        <p>üìã ${esc(data.department)} &nbsp;‚Ä¢&nbsp; üÜî ${esc(data.id)}</p>
      </div>
      <div class="month-nav">
        <button onclick="chMonth(-1)" ${!hasPrev?'disabled style="opacity:.35;cursor:default"':''}>&lt;</button>
        <span>${mName} ${yr}</span>
        <button onclick="chMonth(1)" ${!hasNext?'disabled style="opacity:.35;cursor:default"':''}>&gt;</button>
      </div>
    </div>

    <div class="calendar">
      <div class="cal-head">${dayHdr}</div>
      <div class="cal-body">${cells}</div>
    </div>

    <div class="legend">${legHTML}</div>

    <div class="stats">
      <div class="stats-title">${t('statsTitle')}</div>
      <div class="stats-grid">
        <div class="stat-box"><div class="stat-lbl">${t('workDays')}</div><div class="stat-val">${stats.work}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('offDays')}</div><div class="stat-val">${stats.off}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('morning')}</div><div class="stat-val">${stats.morning}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('afternoon')}</div><div class="stat-val">${stats.afternoon}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('night')}</div><div class="stat-val">${stats.night}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('leaves')}</div><div class="stat-val">${stats.leaves}</div></div>
      </div>
    </div>

    <div class="actions">
      <button class="act-btn act-primary" onclick="dlPDF()">${t('pdf')}</button>
      <button class="act-btn act-ics" onclick="dlICS()">${t('ics')}</button>
      <button class="act-btn" onclick="shareS()">${t('share')}</button>
      <button class="act-btn" onclick="window.print()">${t('print')}</button>
    </div>
  `;
}

function chMonth(dir){
  const ci=months.indexOf(month),ni=ci-dir;
  if(ni>=0&&ni<months.length){month=months[ni];renderSchedule()}
}

function calcStats(s){
  const r={work:0,off:0,morning:0,afternoon:0,night:0,leaves:0};
  s.forEach(d=>{
    if(d.shift_group==='Morning') r.morning++;
    else if(d.shift_group==='Afternoon') r.afternoon++;
    else if(d.shift_group==='Night') r.night++;
    else if(d.shift_group==='Off Day') r.off++;
    else if(d.shift_group==='Annual Leave'||d.shift_group==='Sick Leave') r.leaves++;
  });
  r.work=r.morning+r.afternoon+r.night;
  return r;
}

function shiftClass(g){
  return{Morning:'s-morning',Afternoon:'s-afternoon',Night:'s-night',
         'Off Day':'s-off','Annual Leave':'s-leave','Sick Leave':'s-leave',
         Training:'s-training',Standby:'s-standby',Other:'s-other'}[g]||'s-other';
}
function isToday(y,m,d){
  const n=new Date();
  return n.getFullYear()===y&&n.getMonth()+1===m&&n.getDate()===d;
}
function esc(s){
  return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ‚îÄ‚îÄ ICS ‚îÄ‚îÄ */
function dlICS(){
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const pad=n=>String(n).padStart(2,'0');
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//MySchedule//EN','CALSCALE:GREGORIAN'];
  sched.forEach(d=>{
    const dt=`${yr}${pad(mo)}${pad(d.day)}`;
    const dtNext=new Date(yr,mo-1,d.day+1);
    const dtE=`${dtNext.getFullYear()}${pad(dtNext.getMonth()+1)}${pad(dtNext.getDate())}`;
    const sum=d.shift_code||d.shift_group;
    lines.push('BEGIN:VEVENT',
      `DTSTART;VALUE=DATE:${dt}`,
      `DTEND;VALUE=DATE:${dtE}`,
      `SUMMARY:${sum}`,
      `UID:${dt}-${data.id}-${d.day}@myschedule`,
      'END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  const blob=new Blob([lines.join('\r\n')],{type:'text/calendar'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`schedule-${data.id}-${month}.ics`;
  a.click();URL.revokeObjectURL(a.href);
}

/* ‚îÄ‚îÄ PDF ‚îÄ‚îÄ Clean minimal A4 ‚îÄ‚îÄ */
function dlPDF(){
  if(!window.jspdf){alert('PDF library loading, please try again.');return}
  const {jsPDF}=window.jspdf;

  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210, H=297, M=12;

  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const mName=T.en.months[mo-1];
  const stats=calcStats(sched);

  // ‚îÄ‚îÄ colour palette: one accent per shift type, all muted/elegant ‚îÄ‚îÄ
  // Each entry: [dot R,G,B]  (cells stay white, only dot + code get colour)
  const DOT={
    Morning:     [180,130,40],
    Afternoon:   [180,90,40],
    Night:       [70,60,160],
    'Off Day':   [150,160,170],
    'Annual Leave':[50,140,90],
    'Sick Leave':[50,140,90],
    Training:    [50,100,180],
    Standby:     [160,70,120],
    Other:       [130,130,130]
  };
  const LNAMES={
    Morning:'Morning', Afternoon:'Afternoon', Night:'Night',
    'Off Day':'Day Off','Annual Leave':'Ann. Leave','Sick Leave':'Sick',
    Training:'Training',Standby:'Standby',Other:'Other'
  };

  const INK  =[30, 35, 50];   // near-black text
  const MUTED=[130,140,155];  // grey labels
  const LINE =[215,220,228];  // cell borders
  const BG   =[249,250,252];  // light grey backgrounds

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  HEADER  ‚Äì white background, left rule
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // thin blue left bar
  doc.setFillColor(43,89,255);
  doc.rect(0,0,3,H,'F');

  // name
  doc.setTextColor(...INK);
  doc.setFontSize(22);doc.setFont(undefined,'bold');
  doc.text(String(data.name), M, 18);

  // department ¬∑ id
  doc.setFontSize(10);doc.setFont(undefined,'normal');
  doc.setTextColor(...MUTED);
  doc.text(`${data.department}   ¬∑   ${data.id}`, M, 25);

  // month + year  ‚Äì right aligned, large
  doc.setFontSize(20);doc.setFont(undefined,'bold');
  doc.setTextColor(43,89,255);
  doc.text(`${mName} ${yr}`, W-M, 18, {align:'right'});

  // thin separator line under header
  doc.setDrawColor(...LINE);
  doc.setLineWidth(0.4);
  doc.line(M, 29, W-M, 29);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  STATS ROW  ‚Äì 6 compact boxes
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const stY=33;
  const stData=[
    ['Work',stats.work], ['Off',stats.off],
    ['Morning',stats.morning], ['Afternoon',stats.afternoon],
    ['Night',stats.night], ['Leaves',stats.leaves]
  ];
  const stW=(W-M*2-5*2)/6;
  stData.forEach(([lbl,val],i)=>{
    const sx=M+i*(stW+2);
    doc.setFillColor(...BG);
    doc.setDrawColor(...LINE);
    doc.setLineWidth(0.3);
    doc.roundedRect(sx,stY,stW,14,1.5,1.5,'FD');
    doc.setTextColor(...INK);
    doc.setFontSize(15);doc.setFont(undefined,'bold');
    doc.text(String(val),sx+stW/2,stY+9,{align:'center'});
    doc.setTextColor(...MUTED);
    doc.setFontSize(6.5);doc.setFont(undefined,'normal');
    doc.text(lbl,sx+stW/2,stY+13.2,{align:'center'});
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CALENDAR
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const calTop=stY+18;
  const dLabels=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const cW=(W-M*2)/7;
  const hH=8; // day-header row height

  // Day header row ‚Äì dark fill
  doc.setFillColor(30,35,50);
  doc.rect(M,calTop,W-M*2,hH,'F');
  dLabels.forEach((d,i)=>{
    doc.setTextColor(255,255,255);
    doc.setFontSize(8.5);doc.setFont(undefined,'bold');
    doc.text(d, M+i*cW+cW/2, calTop+5.5, {align:'center'});
  });

  const firstDow=new Date(yr,mo-1,1).getDay();
  const dim=new Date(yr,mo,0).getDate();
  const todayD=new Date();
  const sameMonth=todayD.getFullYear()===yr&&todayD.getMonth()+1===mo;

  // count weeks
  let nRows=0;
  {let d2=1;
   for(let w=0;w<6;w++){
     let any=false;
     for(let d=0;d<7;d++) if(!((w===0&&d<firstDow)||d2>dim)){any=true;d2++;}
     if(any) nRows++;
     if(d2>dim) break;
   }
  }

  const calH=H-M-calTop-hH-10; // leave 10mm for footer
  const cH=Math.floor(calH/nRows);

  let dc=1,row=0;
  doc.setLineWidth(0.25);

  for(let w=0;w<6;w++){
    for(let d=0;d<7;d++){
      const x=M+d*cW;
      const y=calTop+hH+row*cH;
      const empty=(w===0&&d<firstDow)||dc>dim;

      if(empty){
        doc.setFillColor(245,246,249);
        doc.setDrawColor(...LINE);
        doc.rect(x,y,cW,cH,'FD');
      } else {
        const dd=sched.find(s=>s.day===dc);
        const isToday=sameMonth&&todayD.getDate()===dc;

        // white cell
        doc.setFillColor(255,255,255);
        doc.setDrawColor(...LINE);
        doc.rect(x,y,cW,cH,'FD');

        // today: subtle blue background
        if(isToday){
          doc.setFillColor(237,244,255);
          doc.rect(x+0.15,y+0.15,cW-0.3,cH-0.3,'F');
          doc.setDrawColor(43,89,255);
          doc.setLineWidth(0.5);
          doc.rect(x+0.15,y+0.15,cW-0.3,cH-0.3,'D');
          doc.setLineWidth(0.25);
          doc.setDrawColor(...LINE);
        }

        // day number ‚Äì top-left
        doc.setTextColor(...INK);
        doc.setFontSize(12);doc.setFont(undefined,'bold');
        doc.text(String(dc), x+3.5, y+8);

        if(dd){
          const col=DOT[dd.shift_group]||[130,130,130];
          const lbl=LNAMES[dd.shift_group]||dd.shift_group;

          // small filled dot centre-top
          doc.setFillColor(...col);
          doc.circle(x+cW/2, y+cH*0.42, 2.2, 'F');

          // shift label ‚Äì bottom centre, grey small
          doc.setTextColor(...col);
          doc.setFontSize(6.5);doc.setFont(undefined,'bold');
          doc.text(lbl, x+cW/2, y+cH-3.5, {align:'center'});

          // shift code above label if exists
          if(dd.shift_code){
            doc.setTextColor(...MUTED);
            doc.setFontSize(7);doc.setFont(undefined,'bold');
            doc.text(dd.shift_code, x+cW/2, y+cH-8, {align:'center'});
          }
        }
        dc++;
      }
    }
    if(dc>dim) break;
    row++;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  LEGEND  ‚Äì one row at bottom
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const legY=calTop+hH+row*cH+3;
  const used=[...new Set(sched.map(s=>s.shift_group))];
  const gap=(W-M*2)/used.length;
  used.forEach((g,i)=>{
    const col=DOT[g]||[130,130,130];
    const lx=M+i*gap;
    doc.setFillColor(...col);
    doc.circle(lx+2, legY+1.5, 1.5, 'F');
    doc.setTextColor(...MUTED);
    doc.setFontSize(7);doc.setFont(undefined,'normal');
    doc.text(LNAMES[g]||g, lx+5.5, legY+2.5);
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  FOOTER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  doc.setDrawColor(...LINE);
  doc.setLineWidth(0.3);
  doc.line(M, H-8, W-M, H-8);
  doc.setTextColor(...MUTED);
  doc.setFontSize(7);doc.setFont(undefined,'normal');
  doc.text('My Schedule', M, H-4);
  doc.text(`${mName} ${yr}  ¬∑  ID ${data.id}`, W-M, H-4, {align:'right'});

  doc.save(`schedule-${data.id}-${month}.pdf`);
}

/* ‚îÄ‚îÄ SHARE ‚îÄ‚îÄ */
function shareS(){
  const id=data.id;
  const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
  const url=`${location.origin}${base}my-schedule/?emp=${encodeURIComponent(id)}`;
  if(navigator.share) navigator.share({title:'My Schedule',text:`Schedule: ${data.name}`,url});
  else{navigator.clipboard.writeText(url);alert('Link copied!');}
}

const p=new URLSearchParams(location.search).get('emp');
if(p){document.getElementById('empId').value=p;loadSchedule(p);}
</script>
</body>
</html>
