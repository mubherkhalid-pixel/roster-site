<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>My Schedule</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* â”€â”€ RESET â”€â”€ */
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    :root{
      --bg:#0d1117;
      --surface:#161b22;
      --surface2:#1c2330;
      --surface3:#21262d;
      --border:rgba(255,255,255,.08);
      --border2:rgba(255,255,255,.12);
      --ink:#e6edf3;
      --muted:#8b949e;
      --dim:#484f58;
      --accent:#58a6ff;
      --accent2:#3fb950;
      --amber:#d29922;
      --orange:#db6d28;
      --purple:#bc8cff;
      --pink:#ff7b72;
      --cyan:#39d353;
      --r:12px;
      --r-lg:18px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
    }
    body.light{
      --bg:#f5f7fa;
      --surface:#ffffff;
      --surface2:#f0f2f5;
      --surface3:#e8ebf0;
      --border:rgba(0,0,0,.08);
      --border2:rgba(0,0,0,.13);
      --ink:#1a1f2e;
      --muted:#6b7280;
      --dim:#9ca3af;
      --accent:#1d6fd4;
    }

    html{background:var(--bg); color:var(--ink); font-size:15px; scroll-behavior:smooth}
    body{
      font-family:'Sora', system-ui, -apple-system, sans-serif;
      background:var(--bg);
      min-height:100dvh;
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
      transition:background .2s, color .2s;
    }
    body.ar{direction:rtl}
    a{color:var(--accent);text-decoration:none}
    button,input,select{font-family:inherit;font-size:inherit}
    button{cursor:pointer}

    /* â”€â”€ TOPBAR â”€â”€ */
    .topbar{
      position:sticky;top:0;z-index:100;
      padding-top:var(--safe-top);
      background:rgba(13,17,23,.92);
      backdrop-filter:blur(20px) saturate(180%);
      -webkit-backdrop-filter:blur(20px) saturate(180%);
      border-bottom:1px solid var(--border);
      transition:background .2s;
    }
    body.light .topbar{background:rgba(245,247,250,.92)}
    .topbar-inner{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 24px;
      gap:12px;
      max-width:960px;margin:0 auto;
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand-icon{
      width:38px;height:38px;border-radius:10px;
      background:linear-gradient(135deg,#1f6feb,#388bfd);
      display:grid;place-items:center;
      font-size:18px;
      flex:0 0 auto;
      box-shadow:0 0 0 1px rgba(56,139,253,.3),0 4px 12px rgba(31,111,235,.4);
    }
    .brand-info{min-width:0}
    .brand-name{font-size:14px;font-weight:700;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand-sub{font-size:11px;color:var(--muted);font-weight:500;white-space:nowrap}
    .top-btns{display:flex;gap:6px;flex:0 0 auto}
    .ghost-btn{
      height:34px;padding:0 12px;
      border:1px solid var(--border2);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      border-radius:8px;
      font-size:12px;font-weight:600;
      transition:all .15s;
      white-space:nowrap;
    }
    .ghost-btn:hover{background:rgba(255,255,255,.1);color:var(--ink);border-color:rgba(255,255,255,.2)}
    body.light .ghost-btn:hover{background:rgba(0,0,0,.07);border-color:rgba(0,0,0,.18)}
    .ghost-btn:active{transform:scale(.97)}
    .theme-btn{width:34px;padding:0;font-size:15px;}

    /* â”€â”€ SEARCH SECTION â”€â”€ */
    .search-section{
      padding:16px 20px 0;
      max-width:960px;margin:0 auto;
    }
    .tips-pill{
      width:36px;height:36px;
      border:1px solid var(--border2);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      border-radius:10px;
      font-size:16px;
      display:grid;place-items:center;
      flex:0 0 auto;
      transition:all .15s;
    }
    .tips-pill:hover{background:rgba(255,255,255,.1);color:var(--ink)}
    .search-form{display:flex;gap:8px;align-items:center}
    .search-avatar-wrap{
      display:flex;align-items:center;gap:4px;flex:0 0 auto;
    }
    .search-avatar{
      width:36px;height:36px;
      border-radius:10px;
      background:linear-gradient(135deg,#1f6feb,#58a6ff);
      display:grid;place-items:center;
      color:#fff;font-weight:800;font-size:13px;
      flex:0 0 auto;
      box-shadow:0 3px 10px rgba(31,111,235,.4);
      letter-spacing:-.5px;
      font-family:'Sora',system-ui,sans-serif;
      animation:avatarPop .2s cubic-bezier(.22,1,.36,1);
    }
    .search-change-btn{
      width:28px;height:28px;
      background:transparent;
      border:1px solid var(--border2);
      color:var(--muted);
      border-radius:7px;
      font-size:13px;
      display:grid;place-items:center;
      flex:0 0 auto;
      transition:all .15s;
      cursor:pointer;
    }
    .search-change-btn:hover{background:rgba(255,255,255,.08);color:var(--ink)}
    @keyframes avatarPop{from{transform:scale(.6);opacity:0}to{transform:scale(1);opacity:1}}
    .search-input{
      width:130px;flex:0 0 130px;
      background:var(--surface3);
      border:1px solid var(--border2);
      color:var(--ink);
      border-radius:10px;
      padding:9px 12px;
      font-size:14px;font-weight:500;
      outline:none;
      transition:border-color .15s,box-shadow .15s;
    }
    .search-input::placeholder{color:var(--dim);font-size:13px}
    .search-input:focus{border-color:rgba(56,139,253,.6);box-shadow:0 0 0 3px rgba(56,139,253,.15)}
    .search-btn{
      height:36px;padding:0 16px;
      background:linear-gradient(135deg,#1f6feb,#388bfd);
      border:none;color:#fff;
      border-radius:10px;
      font-size:13px;font-weight:700;
      white-space:nowrap;
      transition:filter .15s,transform .1s;
      box-shadow:0 4px 14px rgba(31,111,235,.35);
      flex:0 0 auto;
    }
    .search-btn:hover{filter:brightness(1.1)}
    .search-btn:active{transform:scale(.97)}

    .mnav-arrow{
      width:32px;height:32px;
      background:var(--surface2);
      border:1px solid var(--border2);
      color:var(--muted);
      border-radius:8px;
      display:grid;place-items:center;
      font-size:16px;flex:0 0 auto;
      transition:all .15s;cursor:pointer;
    }
    .mnav-arrow:hover:not(:disabled){background:var(--surface3);color:var(--ink)}
    .mnav-arrow:disabled{opacity:.3;cursor:not-allowed}

    /* â”€â”€ MONTH PICKER POPUP â”€â”€ */
    .month-picker-btn{
      display:flex;align-items:center;gap:6px;
      background:var(--surface2);
      border:1px solid var(--border2);
      color:var(--ink);
      border-radius:10px;
      padding:0 12px;
      height:38px;
      font-size:13px;font-weight:700;
      font-family:'DM Mono',monospace;
      cursor:pointer;
      transition:all .15s;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .month-picker-btn:hover{background:var(--surface3);border-color:rgba(255,255,255,.2)}
    .month-picker-btn .mpb-arrow{font-size:10px;opacity:.6}
    .month-popup{
      position:absolute;
      top:calc(100% + 8px);
      z-index:200;
      background:var(--surface);
      border:1px solid var(--border2);
      border-radius:14px;
      padding:10px;
      box-shadow:0 16px 40px rgba(0,0,0,.45);
      display:none;
      min-width:200px;
      animation:popIn .18s cubic-bezier(.22,1,.36,1);
    }
    body.light .month-popup{box-shadow:0 8px 28px rgba(0,0,0,.15)}
    .month-popup.open{display:block}
    @keyframes popIn{from{opacity:0;transform:scale(.94) translateY(-4px)}to{opacity:1;transform:scale(1) translateY(0)}}
    .month-popup-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:5px;
    }
    .mp-item{
      padding:7px 4px;
      border-radius:8px;
      font-size:11px;font-weight:600;
      text-align:center;
      cursor:pointer;
      color:var(--muted);
      transition:all .12s;
      border:1px solid transparent;
    }
    .mp-item:hover{background:var(--surface3);color:var(--ink);border-color:var(--border)}
    .mp-item.active{
      background:linear-gradient(135deg,rgba(31,111,235,.2),rgba(56,139,253,.1));
      border-color:rgba(56,139,253,.4);
      color:var(--accent);
      font-weight:700;
    }
    .mp-year{
      font-size:10px;font-weight:700;color:var(--dim);
      text-align:center;padding:4px 0 8px;
      letter-spacing:.6px;text-transform:uppercase;
      border-bottom:1px solid var(--border);
      margin-bottom:8px;
    }

    /* â”€â”€ MAIN CONTENT â”€â”€ */
    .main{
      padding:20px 20px calc(40px + var(--safe-bot));
      max-width:960px;
      margin:0 auto;
    }
    .stack{display:flex;flex-direction:column;gap:16px}
    .col-left,.col-right{display:contents}

    /* â”€â”€ EMPLOYEE BANNER â”€â”€ */
    .emp-banner{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r-lg);
      padding:16px 20px;
      display:flex;align-items:center;justify-content:space-between;gap:14px;
    }
    .emp-left{display:flex;align-items:center;gap:14px;min-width:0}
    .emp-avatar{
      width:48px;height:48px;border-radius:14px;
      background:linear-gradient(135deg,#1f6feb,#58a6ff);
      display:grid;place-items:center;
      color:#fff;font-weight:800;font-size:17px;
      flex:0 0 auto;
      box-shadow:0 4px 16px rgba(31,111,235,.4);
    }
    .emp-name{font-size:16px;font-weight:700;color:var(--ink);line-height:1.25;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .emp-tags{display:flex;flex-wrap:wrap;gap:5px;margin-top:5px}
    .emp-tag{
      display:inline-flex;align-items:center;gap:4px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--border);
      border-radius:6px;
      padding:3px 8px;
      font-size:11px;color:var(--muted);font-weight:500;
      font-family:'DM Mono',monospace;
    }
    .change-btn{
      width:34px;height:34px;
      background:transparent;
      border:1px solid var(--border2);
      color:var(--muted);
      border-radius:9px;
      font-size:16px;
      display:grid;place-items:center;
      flex:0 0 auto;
      transition:all .15s;
    }
    .change-btn:hover{background:rgba(255,255,255,.07);color:var(--ink)}

    /* â”€â”€ STATS ROW â€” 7 cards in one row on desktop â”€â”€ */
    .stats-row{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:10px;
    }
    @media(max-width:700px){.stats-row{grid-template-columns:repeat(4,1fr)}}
    @media(max-width:400px){.stats-row{grid-template-columns:repeat(2,1fr)}}
    .stat-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:16px 8px 14px;
      text-align:center;
      position:relative;
      overflow:hidden;
      transition:border-color .2s, transform .15s, box-shadow .15s;
      cursor:default;
    }
    .stat-card:hover{
      border-color:var(--border2);
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(0,0,0,.3);
    }
    .stat-card::after{
      content:'';
      position:absolute;top:0;left:0;right:0;height:3px;
    }
    .stat-card.c-blue::after{background:linear-gradient(90deg,#1f6feb,#58a6ff)}
    .stat-card.c-gray::after{background:linear-gradient(90deg,#484f58,#8b949e)}
    .stat-card.c-amber::after{background:linear-gradient(90deg,#b45309,#d29922)}
    .stat-card.c-orange::after{background:linear-gradient(90deg,#c2410c,#db6d28)}
    .stat-card.c-purple::after{background:linear-gradient(90deg,#7c3aed,#bc8cff)}
    .stat-card.c-pink::after{background:linear-gradient(90deg,#be185d,#ff7b72)}
    .stat-card.c-green::after{background:linear-gradient(90deg,#15803d,#3fb950)}
    .stat-ico{font-size:18px;margin-bottom:6px;display:block}
    .stat-val{font-size:24px;font-weight:800;color:var(--ink);font-family:'DM Mono',monospace;line-height:1}
    .stat-lbl{font-size:9.5px;color:var(--muted);font-weight:600;margin-top:5px;line-height:1.3}

    /* â”€â”€ CALENDAR â”€â”€ */
    .cal-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r-lg);
      overflow:hidden;
    }
    .cal-head{
      display:grid;grid-template-columns:repeat(7,1fr);
      background:var(--surface2);
      border-bottom:1px solid var(--border);
    }
    .cal-head div{
      padding:14px 4px;
      text-align:center;
      font-size:12px;font-weight:700;
      color:var(--muted);
      letter-spacing:.5px;
      text-transform:uppercase;
    }
    .cal-body{
      display:grid;
      grid-template-columns:repeat(7,1fr);
    }
    .day{
      background:var(--surface);
      min-height:96px;
      padding:8px 7px 7px;
      display:flex;flex-direction:column;
      align-items:flex-start;
      position:relative;
      transition:background .1s;
      cursor:default;
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
      overflow:hidden;
    }
    .day:nth-child(7n){border-right:none}
    @media(max-width:380px){.day{min-height:60px;padding:4px 3px}}
    .day.empty{background:rgba(13,17,23,.5);cursor:default}
    body.light .day.empty{background:rgba(240,242,245,.6)}
    .dnum{
      font-size:15px;font-weight:800;
      color:var(--ink);
      font-family:'DM Mono',monospace;
      line-height:1;
      position:relative;z-index:2;
    }
    .day.today .dnum{color:var(--accent)}
    /* Ghost code â€” huge faint fill */
    .day-ghost{
      position:absolute;
      inset:0;
      display:flex;align-items:center;justify-content:center;
      font-size:clamp(22px,5vw,46px);
      font-weight:900;
      opacity:.17;
      pointer-events:none;
      letter-spacing:-2px;
      line-height:1;
      font-family:'DM Mono',monospace;
    }
    /* Readable code â€” bottom of cell, no container, bigger */
    .day-code{
      position:absolute;
      bottom:8px;
      left:50%;
      transform:translateX(-50%);
      font-size:clamp(10px,1.8vw,15px);
      font-weight:800;
      font-family:'DM Mono',monospace;
      letter-spacing:.2px;
      white-space:nowrap;
      z-index:2;
      line-height:1;
    }
    /* Today */
    .day.today{background:rgba(31,111,235,.1)!important}
    .day.today::before{
      content:'';
      position:absolute;top:0;left:0;right:0;height:2.5px;
      background:linear-gradient(90deg,#1f6feb,#58a6ff);
      z-index:3;
    }
    /* Shift backgrounds */
    .s-morning{background:#1a140a}
    .s-afternoon{background:#1a0f07}
    .s-night{background:#110d1f}
    .s-off{background:#0f1117}
    .s-leave{background:#0a1410}
    .s-training{background:#0a1020}
    .s-standby{background:#1a0d14}
    .s-other{background:#111318}
    /* Light mode shift backgrounds */
    body.light .s-morning{background:#fffbf0}
    body.light .s-afternoon{background:#fff7f0}
    body.light .s-night{background:#f5f3ff}
    body.light .s-off{background:#f8fafc}
    body.light .s-leave{background:#f0fdf4}
    body.light .s-training{background:#eff6ff}
    body.light .s-standby{background:#fdf2f8}
    body.light .s-other{background:#f9fafb}
    body.light .day{background:var(--surface)}
    body.light .day.empty{background:rgba(245,247,250,.7)}
    /* Shift code text colors (no container) */
    .s-morning .day-code{color:#d29922}
    .s-afternoon .day-code{color:#e8722a}
    .s-night .day-code{color:#bc8cff}
    .s-off .day-code{color:#8b949e}
    .s-leave .day-code{color:#3fb950}
    .s-training .day-code{color:#58a6ff}
    .s-standby .day-code{color:#ff7b72}
    .s-other .day-code{color:#8b949e}
    /* Ghost inherits same color */
    .s-morning .day-ghost{color:#d29922}
    .s-afternoon .day-ghost{color:#e8722a}
    .s-night .day-ghost{color:#bc8cff}
    .s-off .day-ghost{color:#8b949e}
    .s-leave .day-ghost{color:#3fb950}
    .s-training .day-ghost{color:#58a6ff}
    .s-standby .day-ghost{color:#ff7b72}
    .s-other .day-ghost{color:#8b949e}
    /* Light mode code colors */
    body.light .s-morning .day-code{color:#b45309}
    body.light .s-afternoon .day-code{color:#c2410c}
    body.light .s-night .day-code{color:#7c3aed}
    body.light .s-off .day-code{color:#6b7280}
    body.light .s-leave .day-code{color:#15803d}
    body.light .s-training .day-code{color:#1d4ed8}
    body.light .s-standby .day-code{color:#be185d}
    body.light .s-morning .day-ghost{color:#b45309}
    body.light .s-afternoon .day-ghost{color:#c2410c}
    body.light .s-night .day-ghost{color:#7c3aed}
    body.light .s-off .day-ghost{color:#6b7280}
    body.light .s-leave .day-ghost{color:#15803d}
    body.light .s-training .day-ghost{color:#1d4ed8}
    body.light .s-standby .day-ghost{color:#be185d}

    /* â”€â”€ LEGEND â”€â”€ */
    .legend-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r-lg);
      padding:14px;
    }
    .section-label{
      font-size:10px;font-weight:700;
      color:var(--dim);letter-spacing:.8px;text-transform:uppercase;
      margin-bottom:10px;
    }
    .legend-grid{display:flex;flex-wrap:wrap;gap:6px}
    .leg-item{
      display:inline-flex;align-items:center;gap:6px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:6px;
      padding:5px 9px;
      font-size:11px;color:var(--muted);font-weight:500;
    }
    .l-dot{width:8px;height:8px;border-radius:3px;flex:0 0 auto}

    /* â”€â”€ ACTIONS â”€â”€ */
    .actions-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r-lg);
      padding:14px;
      display:flex;flex-direction:column;gap:8px;
    }
    .actions-top-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .actions-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
    }
    .action-btn{
      display:flex;align-items:center;justify-content:center;gap:9px;
      background:var(--surface3);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px 14px;
      color:var(--muted);
      font-size:13px;font-weight:600;
      transition:all .15s;
      cursor:pointer;
    }
    .action-btn:hover{background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.15);color:var(--ink)}
    .action-btn:active{transform:scale(.98)}
    .action-btn.primary{
      background:linear-gradient(135deg,rgba(31,111,235,.18),rgba(56,139,253,.08));
      border-color:rgba(56,139,253,.35);
      color:var(--accent);
      font-weight:700;
    }
    .action-btn.primary:hover{background:linear-gradient(135deg,rgba(31,111,235,.28),rgba(56,139,253,.18));border-color:rgba(56,139,253,.55)}
    .action-ico{font-size:17px;flex:0 0 auto}

    /* â”€â”€ STATE VIEWS â”€â”€ */
    .state-view{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r-lg);
      padding:48px 24px;
      text-align:center;
    }
    .state-emoji{font-size:42px;display:block;margin-bottom:12px}
    .state-title{font-size:18px;font-weight:700;color:var(--ink);margin-bottom:6px}
    .state-desc{font-size:13px;color:var(--muted);line-height:1.65;max-width:38ch;margin:0 auto}
    .spin{
      width:36px;height:36px;
      border:2.5px solid var(--border2);
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin:0 auto 14px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* â”€â”€ MODAL â”€â”€ */
    .modal{
      position:fixed;inset:0;z-index:999;
      display:none;align-items:flex-end;justify-content:center;
      padding:0;
    }
    @media(min-width:600px){.modal{align-items:center;padding:20px}}
    .modal.open{display:flex}
    .modal-backdrop{
      position:absolute;inset:0;
      background:rgba(0,0,0,.7);
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
    }
    .modal-sheet{
      position:relative;z-index:1;
      width:100%;max-width:540px;
      background:var(--surface);
      border:1px solid var(--border2);
      border-radius:24px 24px 0 0;
      overflow:hidden;
      animation:slideUp .25s cubic-bezier(.22,1,.36,1);
    }
    @media(min-width:600px){.modal-sheet{border-radius:20px;max-width:560px}}
    @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-handle{width:40px;height:4px;background:var(--dim);border-radius:2px;margin:14px auto 0;opacity:.5}
    .modal-head{
      padding:18px 22px 16px;
      border-bottom:1px solid var(--border);
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }
    .modal-title{font-size:18px;font-weight:700;color:var(--ink)}
    .modal-sub{font-size:13px;color:var(--muted);margin-top:4px;line-height:1.5}
    .modal-close{
      width:36px;height:36px;border-radius:10px;
      background:rgba(255,255,255,.06);border:1px solid var(--border);
      color:var(--muted);font-size:16px;
      display:grid;place-items:center;flex:0 0 auto;
      transition:all .15s;
    }
    .modal-close:hover{background:rgba(255,255,255,.12);color:var(--ink)}
    .modal-body{padding:18px 22px}
    .modal-intro{
      background:rgba(88,166,255,.05);
      border:1px solid rgba(88,166,255,.15);
      border-radius:12px;
      padding:14px 16px;
      margin-bottom:14px;
    }
    .modal-intro-title{font-size:14px;font-weight:700;color:var(--ink);margin-bottom:5px}
    .modal-intro-desc{font-size:13px;color:var(--muted);line-height:1.65}
    .tip{
      display:flex;align-items:flex-start;gap:12px;
      padding:14px;border:1px solid var(--border);
      border-radius:12px;background:rgba(255,255,255,.02);
    }
    .tip+.tip{margin-top:10px}
    .tip-ico{font-size:20px;flex:0 0 auto;margin-top:1px}
    .tip-text{font-size:13px;color:var(--muted);line-height:1.65;font-weight:500}
    .modal-foot{padding:16px 22px calc(16px + var(--safe-bot));display:flex;justify-content:flex-end}
    .ok-btn{
      height:40px;padding:0 20px;
      background:linear-gradient(135deg,#1f6feb,#388bfd);
      border:none;color:#fff;
      border-radius:10px;
      font-size:13px;font-weight:700;
      transition:filter .15s;
    }
    .ok-btn:hover{filter:brightness(1.1)}

    /* â”€â”€ TOAST â”€â”€ */
    .toast-container{
      position:fixed;
      bottom:calc(16px + var(--safe-bot));
      left:16px;right:16px;
      z-index:9999;
      display:flex;justify-content:center;
      pointer-events:none;
    }
    .toast-card{
      pointer-events:auto;
      width:min(560px,100%);
      background:var(--surface2);
      border:1px solid var(--border2);
      border-radius:16px;
      padding:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      animation:slideUp .2s cubic-bezier(.22,1,.36,1);
    }
    .toast-row{display:flex;align-items:flex-start;gap:10px}
    .toast-ico{
      width:38px;height:38px;border-radius:10px;
      background:rgba(88,166,255,.1);border:1px solid rgba(88,166,255,.2);
      display:grid;place-items:center;font-size:16px;flex:0 0 auto;
    }
    .toast-text p{font-size:12.5px;color:var(--muted);line-height:1.55;font-weight:500}
    .toast-text strong{color:var(--ink)}
    .toast-btns{display:flex;gap:8px;margin-top:10px}
    .tbtn{
      flex:1;height:36px;
      border-radius:8px;font-size:12px;font-weight:700;
      border:1px solid var(--border2);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      transition:all .12s;
    }
    .tbtn:hover{background:rgba(255,255,255,.1);color:var(--ink)}
    .tbtn.primary{
      background:linear-gradient(135deg,#1f6feb,#388bfd);
      border:none;color:#fff;
    }
    .tbtn.primary:hover{filter:brightness(1.1)}

    /* â”€â”€ PRINT â”€â”€ */
    @media print{
      .topbar,.search-section,.toast-container,.modal,.actions-card,.legend-card{display:none!important}
      body{background:#fff;color:#000}
    }
  </style>
</head>
<body>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-icon">ğŸ“…</div>
        <div class="brand-info">
          <div class="brand-name" id="ttl">My Schedule</div>
          <div class="brand-sub" id="sub">Enter your Employee ID</div>
        </div>
      </div>
      <div class="top-btns">
        <button class="ghost-btn theme-btn" onclick="toggleTheme()" id="themeBtn" aria-label="Toggle theme">ğŸŒ™</button>
        <button class="ghost-btn" onclick="toggleLang()" id="langBtn">English</button>
        <button class="ghost-btn" onclick="goBack()" id="backBtn">Ø±Ø¬ÙˆØ¹ â†’</button>
      </div>
    </div>
  </header>

  <!-- SEARCH SECTION -->
  <section class="search-section">
    <form id="searchForm">
      <div class="search-form">
        <div class="search-avatar-wrap" id="searchAvatarWrap" style="display:none">
          <div class="search-avatar" id="searchAvatar"></div>
          <button class="search-change-btn" type="button" id="searchChangeBtn" style="display:none"></button>
        </div>
        <input class="search-input" id="empId" inputmode="numeric" autocomplete="off"
               placeholder="e.g. 12345" pattern="[0-9]+" required/>
        <button class="search-btn" type="submit" id="sbtn">ğŸ“… View</button>
        <button class="tips-pill" type="button" onclick="openTips()" id="tipsBtn" aria-label="Tips">â”</button>
      </div>
    </form>
  </section>

  <!-- MAIN -->
  <main class="main">
    <div id="area" class="stack">
      <div class="state-view">
        <span class="state-emoji">ğŸ“†</span>
        <div class="state-title" id="e1">Search your schedule</div>
        <div class="state-desc" id="e2">Enter your Employee ID above to view your monthly roster.</div>
      </div>
    </div>
  </main>

  <!-- TOAST -->
  <div class="toast-container" id="toastMount" style="display:none"></div>

  <!-- TIPS MODAL -->
  <div class="modal" id="tipsModal" role="dialog" aria-modal="true">
    <div class="modal-backdrop" onclick="closeTips()"></div>
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-head">
        <div>
          <div class="modal-title" id="tipsTitleModal">Help & Tips</div>
          <div class="modal-sub" id="tipsSub">Quick help for using the roster.</div>
        </div>
        <button class="modal-close" onclick="closeTips()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="modal-intro">
          <div class="modal-intro-title" id="miTitle">Your roster in one view</div>
          <div class="modal-intro-desc" id="miDesc">Enter your Employee ID to view the month, then export it as PDF / Image or add it to your calendar.</div>
        </div>
        <div class="tip">
          <div class="tip-ico">ğŸ’¾</div>
          <div class="tip-text" id="tip1">Save your Employee ID once â€” it will load automatically next time.</div>
        </div>
        <div class="tip">
          <div class="tip-ico">ğŸ–¼ï¸</div>
          <div class="tip-text" id="tip2">Image export produces a clean card with header, calendar, legend, and stats.</div>
        </div>
        <div class="tip">
          <div class="tip-ico">ğŸ“†</div>
          <div class="tip-text" id="tip3">Use ICS export to add shifts to Apple/Google/Outlook calendars.</div>
        </div>
      </div>
      <div class="modal-foot">
        <button class="ok-btn" onclick="closeTips()" id="tipsOk">Got it</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    let data=null, month=null, months=[], lang='ar', theme='dark';

    // â”€â”€ Restore saved preferences â”€â”€
    (function(){
      const sl=localStorage.getItem('prefLang');
      const st=localStorage.getItem('prefTheme');
      if(sl==='en'||sl==='ar') lang=sl;
      if(st==='light'||st==='dark') theme=st;
      if(theme==='light') document.body.classList.add('light');
      if(lang==='en'){ document.documentElement.lang='en'; document.documentElement.dir='ltr'; }
    })();

    const COLORS={
      Morning:       {icon:'â˜€ï¸', dot:'#d29922'},
      Afternoon:     {icon:'ğŸŒ¤ï¸', dot:'#db6d28'},
      Night:         {icon:'ğŸŒ™', dot:'#bc8cff'},
      'Off Day':     {icon:'ğŸ–ï¸', dot:'#8b949e'},
      'Annual Leave':{icon:'âœˆï¸', dot:'#3fb950'},
      'Sick Leave':  {icon:'ğŸ¤’', dot:'#3fb950'},
      Training:      {icon:'ğŸ“š', dot:'#58a6ff'},
      Standby:       {icon:'ğŸ§', dot:'#ff7b72'},
      Other:         {icon:'â“', dot:'#8b949e'}
    };

    const STAT_META=[
      {k:'work',     icon:'ğŸ’¼', c:'c-blue',   label_en:'Work Days',  label_ar:'Ø£ÙŠØ§Ù… Ø¹Ù…Ù„'},
      {k:'off',      icon:'ğŸ›Œ', c:'c-gray',   label_en:'Days Off',   label_ar:'Ø£ÙŠØ§Ù… Ø±Ø§Ø­Ø©'},
      {k:'morning',  icon:'â˜€ï¸', c:'c-amber',  label_en:'Morning',    label_ar:'ØµØ¨Ø§Ø­ÙŠ'},
      {k:'afternoon',icon:'ğŸŒ¤ï¸', c:'c-orange', label_en:'Afternoon',  label_ar:'Ù…Ø³Ø§Ø¦ÙŠ'},
      {k:'night',    icon:'ğŸŒ™', c:'c-purple', label_en:'Night',      label_ar:'Ù„ÙŠÙ„ÙŠ'},
      {k:'standby',  icon:'ğŸ§', c:'c-pink',   label_en:'Standby',    label_ar:'Ø§Ø­ØªÙŠØ§Ø·ÙŠ'},
      {k:'leaves',   icon:'âœˆï¸', c:'c-green',  label_en:'Leaves',     label_ar:'Ø¥Ø¬Ø§Ø²Ø§Øª'},
    ];

    const T={
      en:{
        title:'My Schedule',sub:'Enter your Employee ID',
        heroTitle:'Your roster in one view',
        heroDesc:'Enter your Employee ID to view the month, export as PDF, Image, or add to your calendar.',
        tipsTitle:'Help & Tips',tipsSub:'Quick help for using the roster.',
        langBtn:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',back:'â† Back',ph:'e.g. 12345',sbtn:'ğŸ“… View',tipsBtn:'â” Tips',
        loading:'Loadingâ€¦',notFound:'Employee not found',
        notFoundSub:'ID not in the system. Please check and try again.',
        e1:'Search your schedule',e2:'Enter your Employee ID above to view your monthly roster.',
        statsTitle:'Statistics',legendTitle:'Legend',actionsTitle:'Downloads',
        pdf:'Download PDF',img:'Download Image',ics:'Export ICS',share:'Share Link',print:'Print',
        changeId:'Change ID',setAsMyId:'Set as My ID',dept:'Dept',id:'ID',
        days:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
        months:['January','February','March','April','May','June','July','August','September','October','November','December'],
        legend:{Morning:'Morning',Afternoon:'Afternoon',Night:'Night','Off Day':'Day Off','Annual Leave':'Annual Leave','Sick Leave':'Sick Leave',Training:'Training',Standby:'Standby',Other:'Other'},
        saveTitle:'Save your ID?',saveSub:'Open your schedule faster next time.',saveYes:'âœ… Save',saveNo:'Not now'
      },
      ar:{
        title:'Ø¬Ø¯ÙˆÙ„ÙŠ',sub:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ',
        heroTitle:'Ø¬Ø¯ÙˆÙ„Ùƒ ÙÙŠ Ø¹Ø±Ø¶ ÙˆØ§Ø­Ø¯',
        heroDesc:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø±ØŒ Ø«Ù… Ø­Ù…Ù‘Ù„ PDF/ØµÙˆØ±Ø© Ø£Ùˆ Ø£Ø¶ÙÙ‡ Ù„Ù„ØªÙ‚ÙˆÙŠÙ….',
        tipsTitle:'Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆÙ†ØµØ§Ø¦Ø­',tipsSub:'Ù…Ø³Ø§Ø¹Ø¯Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„.',
        langBtn:'English',back:'Ø±Ø¬ÙˆØ¹ â†’',ph:'Ù…Ø«Ø§Ù„: 12345',sbtn:'ğŸ“… Ø¹Ø±Ø¶',tipsBtn:'â” Ù†ØµØ§Ø¦Ø­',
        loading:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦',notFound:'Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù',
        notFoundSub:'Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ØªØ­Ù‚Ù‚ ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.',
        e1:'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¬Ø¯ÙˆÙ„Ùƒ',e2:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¹Ø±Ø¶ Ù…Ù†Ø§ÙˆØ¨Ø§ØªÙƒ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©.',
        statsTitle:'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',legendTitle:'Ø§Ù„Ø¯Ù„ÙŠÙ„',actionsTitle:'Ø§Ù„ØªØ­Ù…ÙŠÙ„',
        pdf:'ØªØ­Ù…ÙŠÙ„ PDF',img:'ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©',ics:'ØªØµØ¯ÙŠØ± ICS',share:'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ø§Ø¨Ø·',print:'Ø·Ø¨Ø§Ø¹Ø©',
        changeId:'ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù…',setAsMyId:'Ø§Ø­ÙØ¸ ÙƒØ±Ù‚Ù…ÙŠ',dept:'Ø§Ù„Ù‚Ø³Ù…',id:'Ø§Ù„Ø±Ù‚Ù…',
        days:['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'],
        months:['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'],
        legend:{Morning:'ØµØ¨Ø§Ø­ÙŠ',Afternoon:'Ù…Ø³Ø§Ø¦ÙŠ',Night:'Ù„ÙŠÙ„ÙŠ','Off Day':'Ø¥Ø¬Ø§Ø²Ø©','Annual Leave':'Ø³Ù†ÙˆÙŠØ©','Sick Leave':'Ù…Ø±Ø¶ÙŠØ©',Training:'ØªØ¯Ø±ÙŠØ¨',Standby:'Ø§Ø­ØªÙŠØ§Ø·ÙŠ',Other:'Ø£Ø®Ø±Ù‰'},
        saveTitle:'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù…ØŸ',saveSub:'Ù„ÙØªØ­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.',saveYes:'âœ… Ø§Ø­ÙØ¸',saveNo:'Ù„ÙŠØ³ Ø§Ù„Ø¢Ù†'
      }
    };

    function t(k){ return T[lang][k]; }
    function esc(s){ return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // Set initial button states from restored prefs
    document.getElementById('themeBtn').textContent=(theme==='dark'?'ğŸŒ™':'â˜€ï¸');

    function applyLangUI(){
      document.documentElement.lang=lang;
      document.documentElement.dir=lang==='ar'?'rtl':'ltr';
      document.body.classList.toggle('ar',lang==='ar');
      document.getElementById('ttl').textContent=t('title');
      document.getElementById('sub').textContent=t('sub');
      document.getElementById('langBtn').textContent=t('langBtn');
      document.getElementById('backBtn').textContent=t('back');
      document.getElementById('empId').placeholder=t('ph');
      document.getElementById('sbtn').textContent=t('sbtn');
      const e1=document.getElementById('e1'),e2=document.getElementById('e2');
      if(e1)e1.textContent=t('e1');
      if(e2)e2.textContent=t('e2');
      document.getElementById('tipsTitleModal').textContent=t('tipsTitle');
      document.getElementById('tipsSub').textContent=t('tipsSub');
      document.getElementById('miTitle').textContent=t('heroTitle');
      document.getElementById('miDesc').textContent=t('heroDesc');
      document.getElementById('tip1').textContent=(lang==='ar'?'Ø§Ø­ÙØ¸ Ø±Ù‚Ù…Ùƒ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© â€” ÙˆØ³ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.':'Save your Employee ID once â€” it will load automatically next time.');
      document.getElementById('tip2').textContent=(lang==='ar'?'Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© ÙŠÙ†ØªØ¬ Ø¨Ø·Ø§Ù‚Ø© Ù…Ø±ØªØ¨Ø© (Ø±Ø£Ø³ + ØªÙ‚ÙˆÙŠÙ… + Ø¯Ù„ÙŠÙ„ + Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª).':'Image export produces a clean card with header, calendar, legend, and stats.');
      document.getElementById('tip3').textContent=(lang==='ar'?'Ø§Ø³ØªØ®Ø¯Ù… ØªØµØ¯ÙŠØ± ICS Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª Ø¥Ù„Ù‰ ØªÙ‚ÙˆÙŠÙ… Apple/Google/Outlook.':'Use ICS export to add shifts to Apple/Google/Outlook calendars.');
      document.getElementById('tipsOk').textContent='OK';
      if(data) renderSchedule();
    }

    function toggleTheme(){
      theme=(theme==='dark'?'light':'dark');
      document.body.classList.toggle('light', theme==='light');
      document.getElementById('themeBtn').textContent=(theme==='dark'?'ğŸŒ™':'â˜€ï¸');
      localStorage.setItem('prefTheme', theme);
    }
    function toggleLang(){
      lang=(lang==='en'?'ar':'en');
      localStorage.setItem('prefLang', lang);
      applyLangUI();
    }

    function goBack(){
      const wrap=document.getElementById('searchAvatarWrap');
      if(wrap) wrap.style.display='none';
      const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
      if(document.referrer&&document.referrer.includes(location.host)) history.back();
      else location.href=base;
    }

    function openTips(){ document.getElementById('tipsModal').classList.add('open'); }
    function closeTips(){ document.getElementById('tipsModal').classList.remove('open'); }
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeTips(); });

    document.getElementById('searchForm').addEventListener('submit',async(e)=>{
      e.preventDefault();
      const id=document.getElementById('empId').value.trim();
      if(id) await loadSchedule(id);
    });

    async function loadSchedule(id){
      document.getElementById('area').innerHTML=`
        <div class="state-view">
          <div class="spin"></div>
          <div class="state-title">${t('loading')}</div>
          <div class="state-desc">${lang==='ar'?'Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø§Øªâ€¦':'Please wait a momentâ€¦'}</div>
        </div>`;
      try{
        const res=await fetch(`../schedules/${id}.json`);
        if(!res.ok) throw new Error('not found');
        data=await res.json();
        months=Object.keys(data.schedules||{}).sort();
        if(!months.length) throw new Error('empty');
        const savedId=localStorage.getItem('savedEmpId');
        if(!savedId) showSaveToast(id,data.name);
        const now=new Date();
        const cur=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
        month=months.includes(cur)?cur:months[months.length-1];
        renderSchedule();
      }catch(err){
        const wrap=document.getElementById('searchAvatarWrap');
        if(wrap) wrap.style.display='none';        document.getElementById('area').innerHTML=`
          <div class="state-view">
            <span class="state-emoji">âŒ</span>
            <div class="state-title">${t('notFound')}</div>
            <div class="state-desc">${t('notFoundSub')}</div>
          </div>`;
      }
    }

    function showSaveToast(id,name){
      const mount=document.getElementById('toastMount');
      const first=(name?name.split(' ')[0]:id);
      mount.style.display='flex';
      mount.innerHTML=`
        <div class="toast-card">
          <div class="toast-row">
            <div class="toast-ico">ğŸ’¾</div>
            <div class="toast-text">
              <p><strong>${t('saveTitle')}</strong><br>
              ${lang==='ar'?'Ù‡Ù„ Ø£Ù†Øª ':'Are you '}<strong>${esc(first)}</strong>? ${t('saveSub')}</p>
            </div>
          </div>
          <div class="toast-btns">
            <button class="tbtn primary" onclick="confirmSave('${id}')">${t('saveYes')}</button>
            <button class="tbtn" onclick="dismissToast()">${t('saveNo')}</button>
          </div>
        </div>`;
      setTimeout(()=>dismissToast(),10000);
    }
    function confirmSave(id){ localStorage.setItem('savedEmpId',id); dismissToast(); if(data) renderSchedule(); }
    function dismissToast(){ const m=document.getElementById('toastMount'); m.innerHTML=''; m.style.display='none'; }
    function changeMyId(){ if(confirm(lang==='ar'?'Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ØŸ':'Change your saved Employee ID?')){ localStorage.removeItem('savedEmpId'); if(data) renderSchedule(); } }
    function setAsMyId(){ if(data&&data.id){ localStorage.setItem('savedEmpId',data.id); if(data) renderSchedule(); } }

    function calcStats(s){
      const r={work:0,off:0,morning:0,afternoon:0,night:0,standby:0,leaves:0};
      s.forEach(d=>{
        if(d.shift_group==='Morning') r.morning++;
        else if(d.shift_group==='Afternoon') r.afternoon++;
        else if(d.shift_group==='Night') r.night++;
        else if(d.shift_group==='Off Day') r.off++;
        else if(d.shift_group==='Standby') r.standby++;
        else if(d.shift_group==='Annual Leave'||d.shift_group==='Sick Leave') r.leaves++;
      });
      r.work=r.morning+r.afternoon+r.night;
      return r;
    }

    function shiftClass(g){
      return {Morning:'s-morning',Afternoon:'s-afternoon',Night:'s-night','Off Day':'s-off','Annual Leave':'s-leave','Sick Leave':'s-leave',Training:'s-training',Standby:'s-standby',Other:'s-other'}[g]||'s-other';
    }

    function chMonth(dir){ const ci=months.indexOf(month),ni=ci+dir; if(ni>=0&&ni<months.length){month=months[ni];renderSchedule();} }
    function jumpMonth(val){ if(months.includes(val)){month=val;renderSchedule();} }
    function toggleMonthPicker(){
      const p=document.getElementById('monthPopup');
      if(p) p.classList.toggle('open');
    }
    function closeMonthPicker(){
      const p=document.getElementById('monthPopup');
      if(p) p.classList.remove('open');
    }
    // Close popup on outside click
    document.addEventListener('click',function(e){
      if(!e.target.closest('#mpBtn')&&!e.target.closest('#monthPopup')) closeMonthPicker();
    });

    function renderSchedule(){
      const sched=data.schedules[month]||[];
      const [yr,mo]=month.split('-').map(Number);
      const ci=months.indexOf(month);
      const hasPrev=ci>0,hasNext=ci<months.length-1;
      const firstDow=new Date(yr,mo-1,1).getDay();
      const dim=new Date(yr,mo,0).getDate();
      const now=new Date();

      // Month picker popup data
      const mLabel=`${T[lang].months[mo-1]} ${yr}`;
      const years=[...new Set(months.map(m=>m.split('-')[0]))];
      const popupHTML=years.map(y=>`
        <div class="mp-year">${y}</div>
        <div class="month-popup-grid">
          ${months.filter(m=>m.startsWith(y)).map(m=>{
            const mm=parseInt(m.split('-')[1]);
            return '<div class="mp-item '+(m===month?'active':'')+'" onclick="jumpMonth(\'' +m+ '\');closeMonthPicker()">'+T[lang].months[mm-1].slice(0,3)+'</div>';
          }).join('')}
        </div>`).join('');

      const savedId=localStorage.getItem('savedEmpId');
      const isMyId=savedId===data.id;
      const changeBtn=isMyId
        ?`<button class="change-btn" onclick="changeMyId()" title="${t('changeId')}">âœï¸</button>`
        :(!savedId?'':!isMyId?`<button class="change-btn" onclick="setAsMyId()" title="${t('setAsMyId')}">ğŸ“Œ</button>`:'');

      const initials=(data.name||'?').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();

      // Calendar cells
      const dayHdr=T[lang].days.map(d=>`<div>${d}</div>`).join('');
      let cells=''; let dc=1;
      for(let w=0;w<6;w++){
        let rowHasDays=false;
        for(let d=0;d<7;d++){
          if(w===0&&d<firstDow){
            cells+=`<div class="day empty"></div>`;
          }else if(dc>dim){
            cells+=`<div class="day empty"></div>`;
          }else{
            rowHasDays=true;
            const dd=sched.find(s=>s.day===dc);
            const sc=dd?shiftClass(dd.shift_group):'';
            const isToday=(now.getFullYear()===yr&&(now.getMonth()+1)===mo&&now.getDate()===dc);
            const ghostCode = dd ? (dd.shift_code || (dd.shift_group==='Off Day'?'OFF':dd.shift_group==='Annual Leave'?'LV':dd.shift_group==='Sick Leave'?'SL':dd.shift_group==='Training'?'TR':dd.shift_group==='Standby'?'ST':'')) : '';
            const ghostEl = ghostCode ? `<span class="day-ghost">${esc(ghostCode)}</span>` : '';
            const codeEl = ghostCode ? `<span class="day-code">${esc(ghostCode)}</span>` : '';
            cells+=`<div class="day ${sc} ${isToday?'today':''}">
              <span class="dnum">${dc}</span>
              ${ghostEl}
              ${codeEl}
            </div>`;
            dc++;
          }
        }
        if(dc>dim&&!rowHasDays) break;
        if(dc>dim) break;
      }

      const stats=calcStats(sched);

      // Stats cards
      const statsHTML=STAT_META.map(m=>`
        <div class="stat-card ${m.c}">
          <span class="stat-ico">${m.icon}</span>
          <div class="stat-val">${stats[m.k]}</div>
          <div class="stat-lbl">${lang==='ar'?m.label_ar:m.label_en}</div>
        </div>`).join('');

      // Show avatar + change button next to search input
      const avatarWrap=document.getElementById('searchAvatarWrap');
      const avatarEl=document.getElementById('searchAvatar');
      const changeSearchBtn=document.getElementById('searchChangeBtn');
      if(avatarEl){ avatarEl.textContent=initials; }
      if(avatarWrap){ avatarWrap.style.display='flex'; }
      if(changeSearchBtn){
        const savedId=localStorage.getItem('savedEmpId');
        if(savedId===data.id){
          changeSearchBtn.textContent='âœï¸';
          changeSearchBtn.title=t('changeId');
          changeSearchBtn.style.display='grid';
          changeSearchBtn.onclick=()=>changeMyId();
        } else if(!savedId){
          changeSearchBtn.style.display='none';
        } else {
          changeSearchBtn.textContent='ğŸ“Œ';
          changeSearchBtn.title=t('setAsMyId');
          changeSearchBtn.style.display='grid';
          changeSearchBtn.onclick=()=>setAsMyId();
        }
      }

      document.getElementById('area').innerHTML=`
        <!-- Employee Banner â€” no avatar here -->
        <div class="emp-banner">
          <div class="emp-left" style="min-width:0">
            <div>
              <div class="emp-name">${esc(data.name)}</div>
              <div class="emp-tags">
                <span class="emp-tag">ğŸ“‹ ${esc(data.department)}</span>
                <span class="emp-tag">ğŸ†” ${esc(data.id)}</span>
              </div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;flex:0 0 auto">
            <button class="mnav-arrow" onclick="chMonth(-1)" ${!hasPrev?'disabled':''} aria-label="Prev">â€¹</button>
            <div style="position:relative">
              <button class="month-picker-btn" id="mpBtn" onclick="toggleMonthPicker()">
                ${esc(mLabel)} <span class="mpb-arrow">â–¼</span>
              </button>
              <div class="month-popup" id="monthPopup">${popupHTML}</div>
            </div>
            <button class="mnav-arrow" onclick="chMonth(1)" ${!hasNext?'disabled':''} aria-label="Next">â€º</button>
            ${changeBtn}
          </div>
        </div>

        <!-- Calendar -->
        <div class="cal-card">
          <div class="cal-head">${dayHdr}</div>
          <div class="cal-body">${cells}</div>
        </div>

        <!-- Stats -->
        <div class="stats-row">${statsHTML}</div>

        <!-- Actions -->
        <div class="actions-card">
          <div class="section-label">${t('actionsTitle')}</div>
          <div class="actions-top-row">
            <button class="action-btn primary" onclick="dlPDF()"><span class="action-ico">ğŸ“„</span>${t('pdf')}</button>
            <button class="action-btn primary" onclick="dlIMG()"><span class="action-ico">ğŸ–¼ï¸</span>${t('img')}</button>
          </div>
          <div class="actions-grid">
            <button class="action-btn" onclick="dlICS()"><span class="action-ico">ğŸ“†</span>${t('ics')}</button>
            <button class="action-btn" onclick="shareS()"><span class="action-ico">ğŸ”—</span>${t('share')}</button>
            <button class="action-btn" onclick="window.print()"><span class="action-ico">ğŸ–¨ï¸</span>${t('print')}</button>
          </div>
        </div>`;
    }

    /* IMAGE DOWNLOAD â€” pure Canvas v2 */
    async function dlIMG(){
      const sched=data.schedules[month]||[];
      const [yr,mo]=month.split('-').map(Number);
      const stats=calcStats(sched);
      const isAr=lang==='ar';

      // â”€â”€ Palette â”€â”€
      const BG='#0d1117', SURF='#161b22', SURF2='#1c2330';
      const INK='#e6edf3', MUTED='#8b949e', DIM='#3d444d';
      const BORDER='rgba(255,255,255,0.09)', BORDER2='rgba(255,255,255,0.15)';
      const ACCENT='#58a6ff';

      const SHIFT_THEME={
        Morning:       {bg:'#1f1500',fg:'#e3a217',tagBg:'rgba(227,162,23,.22)',tagBd:'rgba(227,162,23,.5)'},
        Afternoon:     {bg:'#1f0e00',fg:'#e8722a',tagBg:'rgba(232,114,42,.22)',tagBd:'rgba(232,114,42,.5)'},
        Night:         {bg:'#100b20',fg:'#c084fc',tagBg:'rgba(192,132,252,.22)',tagBd:'rgba(192,132,252,.5)'},
        'Off Day':     {bg:'#0e1015',fg:'#94a3b8',tagBg:'rgba(148,163,184,.18)',tagBd:'rgba(148,163,184,.4)'},
        'Annual Leave':{bg:'#061410',fg:'#4ade80',tagBg:'rgba(74,222,128,.18)',tagBd:'rgba(74,222,128,.45)'},
        'Sick Leave':  {bg:'#061410',fg:'#4ade80',tagBg:'rgba(74,222,128,.18)',tagBd:'rgba(74,222,128,.45)'},
        Training:      {bg:'#070e1f',fg:'#60a5fa',tagBg:'rgba(96,165,250,.18)',tagBd:'rgba(96,165,250,.45)'},
        Standby:       {bg:'#1a0910',fg:'#fb7185',tagBg:'rgba(251,113,133,.18)',tagBd:'rgba(251,113,133,.45)'},
        Other:         {bg:'#0f1115',fg:'#94a3b8',tagBg:'rgba(148,163,184,.18)',tagBd:'rgba(148,163,184,.4)'},
      };

      const STAT_COLORS={work:ACCENT,off:'#94a3b8',morning:'#e3a217',afternoon:'#e8722a',night:'#c084fc',standby:'#fb7185',leaves:'#4ade80'};
      const FALLBACK={'Off Day':'OFF','Annual Leave':'LV','Sick Leave':'SL',Training:'TR',Standby:'ST',Other:'â€”'};

      // Short Arabic day names for the calendar header
      const DAY_SHORT_AR=['Ø£Ø­Ø¯','Ø§Ø«Ù†','Ø«Ù„Ø§','Ø£Ø±Ø¨','Ø®Ù…Ø³','Ø¬Ù…Ø¹','Ø³Ø¨Øª'];
      const DAY_SHORT_EN=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      const dayShort=isAr?DAY_SHORT_AR:DAY_SHORT_EN;

      // â”€â”€ Layout â”€â”€
      const SC=3;
      const W=560;
      const PAD=16;
      const INNER=W-PAD*2;

      // Header
      const HDR_H=82;

      // Calendar
      const CAL_GAP=12;
      const DAY_LBL_H=34;
      const firstDow=new Date(yr,mo-1,1).getDay();
      const dim=new Date(yr,mo,0).getDate();
      const nRows=Math.ceil((firstDow+dim)/7);
      const CELL_W=Math.floor(INNER/7);
      const CELL_H=74;
      const CAL_CARD_H=DAY_LBL_H+nRows*CELL_H;

      // Stats
      const STATS_GAP=12;
      const STAT_COLS=4;
      const STAT_GAP=8;
      const STAT_CARD_W=Math.floor((INNER-(STAT_COLS-1)*STAT_GAP)/STAT_COLS);
      const STAT_CARD_H=80;
      const STAT_ROWS=Math.ceil(STAT_META.length/STAT_COLS);
      const STATS_INNER_H=26+STAT_ROWS*(STAT_CARD_H+STAT_GAP)-STAT_GAP+16;
      const STATS_CARD_H=STATS_INNER_H;

      const TOTAL_H=HDR_H+CAL_GAP+CAL_CARD_H+STATS_GAP+STATS_CARD_H+PAD;

      const canvas=document.createElement('canvas');
      canvas.width=W*SC; canvas.height=TOTAL_H*SC;
      const ctx=canvas.getContext('2d');
      ctx.scale(SC,SC);

      // â”€â”€ Helpers â”€â”€
      function rr(x,y,w,h,r){
        if(r<=0){ctx.rect(x,y,w,h);return;}
        ctx.beginPath();
        ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.arcTo(x+w,y,x+w,y+r,r);
        ctx.lineTo(x+w,y+h-r);ctx.arcTo(x+w,y+h,x+w-r,y+h,r);
        ctx.lineTo(x+r,y+h);ctx.arcTo(x,y+h,x,y+h-r,r);
        ctx.lineTo(x,y+r);ctx.arcTo(x,y,x+r,y,r);
        ctx.closePath();
      }
      function fillRR(x,y,w,h,r,c){ctx.fillStyle=c;rr(x,y,w,h,r);ctx.fill();}
      function strokeRR(x,y,w,h,r,c,lw){ctx.lineWidth=lw||0.6;ctx.strokeStyle=c;rr(x,y,w,h,r);ctx.stroke();}
      function clipRR(x,y,w,h,r){ctx.save();rr(x,y,w,h,r);ctx.clip();}

      // â”€â”€ Background â”€â”€
      ctx.fillStyle=BG;ctx.fillRect(0,0,W,TOTAL_H);

      // â•â• HEADER CARD â•â•
      fillRR(0,0,W,HDR_H,0,SURF2);
      // Accent bottom line
      ctx.fillStyle=ACCENT;ctx.fillRect(0,HDR_H-2,W,2);

      // Avatar
      const AV=48, AVY=(HDR_H-AV)/2;
      const AVX=isAr?W-PAD-AV:PAD;
      const initials=(data.name||'?').split(/\s+/).slice(0,2).map(w=>w[0]||'').join('').toUpperCase();
      const avGrad=ctx.createLinearGradient(AVX,AVY,AVX+AV,AVY+AV);
      avGrad.addColorStop(0,'#1f6feb');avGrad.addColorStop(1,'#58a6ff');
      fillRR(AVX,AVY,AV,AV,12,avGrad);
      ctx.fillStyle='#fff';ctx.font=`800 16px Arial`;
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(initials,AVX+AV/2,AVY+AV/2+1);

      // Text block (opposite side from avatar)
      const TX=isAr?W-PAD-AV-12:PAD+AV+12;
      const tAlign=isAr?'right':'left';
      ctx.textAlign=tAlign;ctx.textBaseline='alphabetic';

      // Name
      ctx.fillStyle=INK;ctx.font=`700 20px Arial`;
      ctx.fillText(String(data.name||''),TX,HDR_H*0.38);

      // Department
      ctx.fillStyle=MUTED;ctx.font=`400 12px Arial`;
      ctx.fillText(String(data.department||''),TX,HDR_H*0.38+20);

      // ID badge pill
      const idTxt=`ID  ${data.id||''}`;
      ctx.font=`700 11px Arial`;
      const idW=ctx.measureText(idTxt).width+16;
      const idX=isAr?W-PAD-AV-12-idW:PAD+AV+12;
      const idY=HDR_H*0.38+34;
      fillRR(idX,idY-13,idW,18,5,'rgba(88,166,255,0.15)');
      strokeRR(idX,idY-13,idW,18,5,'rgba(88,166,255,0.35)',0.5);
      ctx.fillStyle=ACCENT;ctx.textAlign='left';
      ctx.fillText(idTxt,idX+8,idY);

      // Month + Year  (right side if LTR, left if RTL â€” opposite text block)
      const MX=isAr?PAD:W-PAD;
      ctx.textAlign=isAr?'left':'right';
      ctx.fillStyle=INK;ctx.font=`800 22px Arial`;
      ctx.fillText(T[lang].months[mo-1]||'',MX,32);
      ctx.fillStyle=MUTED;ctx.font=`400 13px Arial`;
      ctx.fillText(String(yr),MX,52);

      // â•â• CALENDAR CARD â•â•
      const calY=HDR_H+CAL_GAP;
      clipRR(PAD,calY,INNER,CAL_CARD_H,14);
      fillRR(PAD,calY,INNER,CAL_CARD_H,14,SURF);
      ctx.restore();
      strokeRR(PAD,calY,INNER,CAL_CARD_H,14,BORDER2,0.7);

      // Day label row
      clipRR(PAD,calY,INNER,DAY_LBL_H,14);
      fillRR(PAD,calY,INNER,DAY_LBL_H,0,SURF2);
      // cover bottom corners
      ctx.fillStyle=SURF2;
      ctx.fillRect(PAD,calY+DAY_LBL_H-14,INNER,14);
      ctx.restore();

      ctx.textAlign='center';ctx.textBaseline='middle';
      for(let d=0;d<7;d++){
        const lx=PAD+d*CELL_W+CELL_W/2;
        ctx.fillStyle=MUTED;ctx.font=`700 11px Arial`;
        ctx.fillText(dayShort[d],lx,calY+DAY_LBL_H/2);
      }

      // Separator line
      ctx.strokeStyle=BORDER;ctx.lineWidth=0.5;
      ctx.beginPath();ctx.moveTo(PAD,calY+DAY_LBL_H);ctx.lineTo(PAD+INNER,calY+DAY_LBL_H);ctx.stroke();

      // â”€â”€ Cells â”€â”€
      const cellsY=calY+DAY_LBL_H;
      const now=new Date();
      let dc=1;

      for(let w=0;w<nRows;w++){
        for(let d=0;d<7;d++){
          const cx=PAD+d*CELL_W;
          const cy2=cellsY+w*CELL_H;
          const isEmpty=(w===0&&d<firstDow)||dc>dim;

          if(isEmpty){
            ctx.fillStyle='rgba(10,12,16,0.7)';
            ctx.fillRect(cx,cy2,CELL_W,CELL_H);
          } else {
            const dd=sched.find(s=>s.day===dc);
            const th=dd?(SHIFT_THEME[dd.shift_group]||SHIFT_THEME.Other):null;
            const isToday=(now.getFullYear()===yr&&(now.getMonth()+1)===mo&&now.getDate()===dc);

            // Cell bg
            ctx.fillStyle=th?th.bg:SURF;
            ctx.fillRect(cx,cy2,CELL_W,CELL_H);

            if(isToday){
              ctx.fillStyle='rgba(31,111,235,0.18)';
              ctx.fillRect(cx,cy2,CELL_W,CELL_H);
              ctx.fillStyle=ACCENT;ctx.fillRect(cx,cy2,CELL_W,2.5);
            }

            // Ghost number (big, faint) â€” day number
            const gSize=Math.min(CELL_H*0.55,34);
            ctx.save();
            ctx.font=`800 ${gSize}px Arial`;
            ctx.textAlign='left';ctx.textBaseline='top';
            ctx.fillStyle=th?th.fg+'22':'rgba(255,255,255,0.06)';
            ctx.fillText(String(dc),cx+3,cy2+1);
            ctx.restore();

            // Day number (small, readable, top-left)
            ctx.font=`700 11px Arial`;
            ctx.textAlign='left';ctx.textBaseline='top';
            ctx.fillStyle=isToday?ACCENT:(th?th.fg:MUTED);
            ctx.fillText(String(dc),cx+5,cy2+5);

            // Shift code â€” HUGE ghost filling the cell center
            if(dd){
              const code=dd.shift_code||(FALLBACK[dd.shift_group]||'');
              if(code){
                // Big ghost code â€” measure to fit
                ctx.save();
                ctx.textAlign='center';ctx.textBaseline='middle';
                let bigFS=Math.min(CELL_H*0.52, CELL_W*0.75);
                ctx.font=`900 ${bigFS}px Arial`;
                // Scale down if too wide
                const tw=ctx.measureText(code).width;
                if(tw>CELL_W-6){ bigFS=bigFS*(CELL_W-6)/tw; }
                ctx.font=`900 ${bigFS}px Arial`;
                ctx.fillStyle=th?th.fg+'2e':'rgba(255,255,255,0.08)';
                ctx.fillText(code, cx+CELL_W/2, cy2+CELL_H*0.55);
                ctx.restore();

                // Small readable tag at bottom
                const tagH=20, tagMargin=6;
                const tagY=cy2+CELL_H-tagH-tagMargin;
                ctx.font=`700 10px Arial`;
                const stw=ctx.measureText(code).width;
                const tagW=Math.min(stw+14,CELL_W-8);
                const tagX=cx+(CELL_W-tagW)/2;
                fillRR(tagX,tagY,tagW,tagH,5,th.tagBg);
                strokeRR(tagX,tagY,tagW,tagH,5,th.tagBd,0.7);
                ctx.fillStyle=th.fg;
                ctx.font=`700 10px Arial`;
                ctx.textAlign='center';ctx.textBaseline='middle';
                ctx.fillText(code,tagX+tagW/2,tagY+tagH/2);
              }
            }
            dc++;
          }

          // Grid lines
          ctx.strokeStyle=BORDER;ctx.lineWidth=0.5;
          ctx.strokeRect(cx+0.25,cy2+0.25,CELL_W-0.5,CELL_H-0.5);
        }
      }

      // â•â• STATS CARD â•â•
      const stCardY=calY+CAL_CARD_H+STATS_GAP;
      fillRR(PAD,stCardY,INNER,STATS_CARD_H,14,SURF);
      strokeRR(PAD,stCardY,INNER,STATS_CARD_H,14,BORDER2,0.7);

      // Section label
      ctx.textAlign=isAr?'right':'left';ctx.textBaseline='alphabetic';
      ctx.fillStyle=DIM;ctx.font=`700 10px Arial`;
      ctx.fillText((isAr?'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª':'STATISTICS'),isAr?PAD+INNER-10:PAD+10,stCardY+20);

      // Stat cards
      STAT_META.forEach((m,i)=>{
        const col=i%STAT_COLS;
        const row=Math.floor(i/STAT_COLS);
        const sx=PAD+col*(STAT_CARD_W+STAT_GAP);
        const sy=stCardY+28+row*(STAT_CARD_H+STAT_GAP);
        const clr=STAT_COLORS[m.k];

        fillRR(sx,sy,STAT_CARD_W,STAT_CARD_H,10,SURF2);
        strokeRR(sx,sy,STAT_CARD_W,STAT_CARD_H,10,BORDER,0.5);

        // Top color accent bar
        clipRR(sx,sy,STAT_CARD_W,STAT_CARD_H,10);
        ctx.fillStyle=clr;ctx.fillRect(sx,sy,STAT_CARD_W,3.5);
        ctx.restore();

        // Ghost number â€” huge, faint, filling the card
        ctx.save();
        ctx.textAlign='center';ctx.textBaseline='middle';
        let gfs=Math.min(STAT_CARD_H*0.75, STAT_CARD_W*0.85);
        ctx.font=`900 ${gfs}px Arial`;
        const gtw=ctx.measureText(String(stats[m.k])).width;
        if(gtw>STAT_CARD_W-4){ gfs=gfs*(STAT_CARD_W-4)/gtw; }
        ctx.font=`900 ${gfs}px Arial`;
        ctx.fillStyle=clr+'28';
        ctx.fillText(String(stats[m.k]),sx+STAT_CARD_W/2,sy+STAT_CARD_H*0.54);
        ctx.restore();

        // Emoji icon
        ctx.font=`16px Arial`;ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText(m.icon,sx+STAT_CARD_W/2,sy+20);

        // Number value (on top of ghost)
        ctx.fillStyle=clr;ctx.font=`800 24px Arial`;
        ctx.textAlign='center';ctx.textBaseline='alphabetic';
        ctx.fillText(String(stats[m.k]),sx+STAT_CARD_W/2,sy+58);

        // Label
        ctx.fillStyle=MUTED;ctx.font=`500 9px Arial`;
        const lbl=isAr?m.label_ar:m.label_en;
        ctx.fillText(lbl,sx+STAT_CARD_W/2,sy+72);
      });

      // â”€â”€ Download â”€â”€
      const a=document.createElement('a');
      a.download=`schedule-${data.id}-${month}-${lang}.png`;
      a.href=canvas.toDataURL('image/png');
      a.click();
    }

    /* ICS */
    function dlICS(){
      const sched=data.schedules[month]||[];
      const [yr,mo]=month.split('-').map(Number);
      const pad=n=>String(n).padStart(2,'0');
      const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//MySchedule//EN','CALSCALE:GREGORIAN'];
      sched.forEach(d=>{
        const dt=`${yr}${pad(mo)}${pad(d.day)}`;
        const dtNext=new Date(yr,mo-1,d.day+1);
        const dtE=`${dtNext.getFullYear()}${pad(dtNext.getMonth()+1)}${pad(dtNext.getDate())}`;
        const sum=d.shift_code||d.shift_group;
        lines.push('BEGIN:VEVENT',`DTSTART;VALUE=DATE:${dt}`,`DTEND;VALUE=DATE:${dtE}`,`SUMMARY:${sum}`,`UID:${dt}-${data.id}-${d.day}@myschedule`,'END:VEVENT');
      });
      lines.push('END:VCALENDAR');
      const blob=new Blob([lines.join('\r\n')],{type:'text/calendar'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download=`schedule-${data.id}-${month}.ics`;a.click();
      URL.revokeObjectURL(a.href);
    }

    /* PDF */
    function dlPDF(){
      if(!window.jspdf){alert('PDF library loading, please try again.');return;}
      const{jsPDF}=window.jspdf;
      const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
      const W=210,H=297,ML=10,MR=10;
      const sched=data.schedules[month]||[];
      const[yr,mo]=month.split('-').map(Number);
      const mName=T.en.months[mo-1];
      const stats=calcStats(sched);
      const SC={Morning:{fg:[180,80,0],bg:[255,243,224]},Afternoon:{fg:[160,40,5],bg:[255,235,218]},Night:{fg:[100,40,210],bg:[237,233,254]},'Off Day':{fg:[85,95,115],bg:[238,240,245]},'Annual Leave':{fg:[10,125,60],bg:[218,248,230]},'Sick Leave':{fg:[10,125,60],bg:[218,248,230]},Training:{fg:[10,85,190],bg:[218,238,255]},Standby:{fg:[148,10,110],bg:[250,218,242]},Other:{fg:[90,100,115],bg:[240,241,246]}};
      const FALLBACK={'Off Day':'OFF','Annual Leave':'LV','Sick Leave':'SL',Training:'TR',Standby:'ST',Other:'â€”'};
      const LNAMES={Morning:'Morning',Afternoon:'Afternoon',Night:'Night','Off Day':'Day Off','Annual Leave':'Leave','Sick Leave':'Sick',Training:'Training',Standby:'Standby',Other:'Other'};
      const NAVY=[10,22,40],NAVY2=[18,36,65],WHITE=[255,255,255],RULE=[210,216,226],EMPTY=[246,247,251],DIM=[120,130,148],ACCENT=[29,111,235],MUTED=[140,155,180];

      // â”€â”€ HEADER â”€â”€
      // Deep navy gradient background
      const HDR_H=42;
      doc.setFillColor(...NAVY);doc.rect(0,0,W,HDR_H,'F');
      // Subtle accent stripe at bottom of header
      doc.setFillColor(...ACCENT);doc.rect(0,HDR_H-1.5,W,1.5,'F');

      // Employee name â€” big and bold, left side
      doc.setTextColor(...WHITE);
      doc.setFontSize(22);doc.setFont(undefined,'bold');
      doc.text(String(data.name), ML, 16);

      // Department Â· ID â€” smaller, muted blue
      doc.setFontSize(10);doc.setFont(undefined,'normal');
      doc.setTextColor(...MUTED);
      doc.text(`${data.department}`, ML, 25);

      // ID with slight separator
      doc.setTextColor(100,140,210);
      doc.setFontSize(9);
      doc.text(`ID  ${data.id}`, ML, 33);

      // Month + Year â€” right side, large, no box
      const monthStr = mName.toUpperCase();
      doc.setTextColor(...WHITE);
      doc.setFontSize(20);doc.setFont(undefined,'bold');
      doc.text(monthStr, W - MR, 19, {align:'right'});
      doc.setFontSize(11);doc.setFont(undefined,'normal');
      doc.setTextColor(...MUTED);
      doc.text(String(yr), W - MR, 29, {align:'right'});

      // â”€â”€ CALENDAR â”€â”€
      const CAL_HDR=9,STATS_H=44,FOOT_H=8,GAP1=4,GAP2=5;
      const CAL_TOP=HDR_H+GAP1,STATS_TOP=H-FOOT_H-GAP2-STATS_H,CAL_BOT=STATS_TOP-GAP2,CAL_BODY=CAL_BOT-CAL_TOP-CAL_HDR;
      const firstDow=new Date(yr,mo-1,1).getDay(),dim=new Date(yr,mo,0).getDate();
      let nRows=0;{let d2=1;for(let w=0;w<6;w++){let any=false;for(let d=0;d<7;d++){if(!((w===0&&d<firstDow)||d2>dim)){any=true;d2++;}}if(any)nRows++;if(d2>dim)break;}}
      const CH=Math.floor(CAL_BODY/nRows),CW=(W-ML-MR)/7;

      // Day header bar
      doc.setFillColor(...NAVY);doc.rect(ML,CAL_TOP,W-ML-MR,CAL_HDR,'F');
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach((d,i)=>{
        doc.setTextColor(...WHITE);doc.setFontSize(8);doc.setFont(undefined,'bold');
        doc.text(d,ML+i*CW+CW/2,CAL_TOP+6.2,{align:'center'});
      });

      // Calendar cells
      let dc=1,row=0;doc.setLineWidth(0.18);
      for(let w=0;w<6;w++){
        for(let d=0;d<7;d++){
          const cx=ML+d*CW,cy=CAL_TOP+CAL_HDR+row*CH;
          const isEmpty=(w===0&&d<firstDow)||dc>dim;
          if(isEmpty){doc.setFillColor(...EMPTY);doc.setDrawColor(...RULE);doc.rect(cx,cy,CW,CH,'FD');continue;}
          const dd=sched.find(s=>s.day===dc),sh=dd?(SC[dd.shift_group]||SC.Other):null;
          doc.setFillColor(...(sh?sh.bg:WHITE));doc.setDrawColor(...RULE);doc.rect(cx,cy,CW,CH,'FD');

          // Ghost day number
          const numStr=String(dc);
          let ghostR,ghostG,ghostB;
          if(sh){ghostR=Math.round(sh.bg[0]*.6+sh.fg[0]*.4);ghostG=Math.round(sh.bg[1]*.6+sh.fg[1]*.4);ghostB=Math.round(sh.bg[2]*.6+sh.fg[2]*.4);}
          else{ghostR=215;ghostG=220;ghostB=228;}
          const ghostSize=Math.round(CH*.68);
          doc.setTextColor(ghostR,ghostG,ghostB);
          doc.setFontSize(ghostSize>36?36:ghostSize<20?20:ghostSize);
          doc.setFont(undefined,'bold');
          doc.text(numStr,cx+2,cy+ghostSize*.7,{align:'left'});

          // Shift code centered
          if(dd){const code=dd.shift_code||(FALLBACK[dd.shift_group]||'');if(code){const fs=CH>=36?19:CH>=28?17:14;doc.setTextColor(...sh.fg);doc.setFontSize(fs);doc.setFont(undefined,'bold');doc.text(code,cx+CW/2,cy+CH*.68,{align:'center'});}}
          dc++;
        }
        if(dc>dim)break;
        row++;
      }

      // â”€â”€ STATS â”€â”€
      doc.setDrawColor(...RULE);doc.setLineWidth(0.25);doc.line(ML,STATS_TOP,W-MR,STATS_TOP);
      doc.setTextColor(...DIM);doc.setFontSize(7.5);doc.setFont(undefined,'bold');
      doc.text('MONTHLY STATISTICS', ML, STATS_TOP+5);

      const SL=[
        {l:'Work Days',v:stats.work,c:ACCENT},
        {l:'Day Off',v:stats.off,c:[85,95,115]},
        {l:'Morning',v:stats.morning,c:[180,80,0]},
        {l:'Afternoon',v:stats.afternoon,c:[160,40,5]},
        {l:'Night',v:stats.night,c:[100,40,210]},
        {l:'Standby',v:stats.standby,c:[148,10,110]},
        {l:'Leaves',v:stats.leaves,c:[10,125,60]}
      ];
      const nSt=SL.length,SGAP=2.5,sW=(W-ML-MR-(nSt-1)*SGAP)/nSt,CARD_Y=STATS_TOP+8,CARD_H=24;
      SL.forEach(({l,v,c},i)=>{
        const sx=ML+i*(sW+SGAP);
        // Card bg
        doc.setFillColor(248,250,254);doc.setDrawColor(...RULE);doc.setLineWidth(0.15);
        doc.roundedRect(sx,CARD_Y,sW,CARD_H,2,2,'FD');
        // Color top bar
        doc.setFillColor(...c);doc.roundedRect(sx,CARD_Y,sW,2.5,1,1,'F');
        // Value
        doc.setTextColor(...c);doc.setFontSize(19);doc.setFont(undefined,'bold');
        doc.text(String(v),sx+sW/2,CARD_Y+16,{align:'center'});
        // Label
        doc.setTextColor(...DIM);doc.setFontSize(5.5);doc.setFont(undefined,'bold');
        doc.text(l,sx+sW/2,CARD_Y+21.5,{align:'center'});
      });

      // Legend row
      const LY=CARD_Y+CARD_H+3;
      const usedG=[...new Set(sched.map(s=>s.shift_group))];
      const lStep=(W-ML-MR)/Math.max(usedG.length,1);
      usedG.forEach((g,i)=>{
        const sh2=SC[g]||SC.Other;const lx=ML+i*lStep;
        doc.setFillColor(...sh2.bg);doc.setDrawColor(...sh2.fg);doc.setLineWidth(0.4);
        doc.roundedRect(lx,LY,lStep-2,5.5,1.5,1.5,'FD');
        doc.setTextColor(...sh2.fg);doc.setFontSize(6);doc.setFont(undefined,'bold');
        doc.text(LNAMES[g]||g,lx+(lStep-2)/2,LY+3.8,{align:'center'});
      });

      // â”€â”€ FOOTER â”€â”€
      doc.setDrawColor(...RULE);doc.setLineWidth(0.2);doc.line(ML,H-5,W-MR,H-5);
      doc.setTextColor(...DIM);doc.setFontSize(6.5);doc.setFont(undefined,'normal');
      doc.text('My Schedule', ML, H-2);
      doc.text(`${mName} ${yr}  Â·  ${data.id}`, W-MR, H-2, {align:'right'});

      doc.save(`schedule-${data.id}-${month}.pdf`);
    }

    /* SHARE */
    function shareS(){
      const id=data.id;
      const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
      const url=`${location.origin}${base}my-schedules/?emp=${encodeURIComponent(id)}`;
      if(navigator.share){navigator.share({title:'My Schedule',text:`Schedule: ${data.name}`,url});}
      else{navigator.clipboard.writeText(url);alert(lang==='ar'?'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· âœ…':'Link copied âœ…');}
    }

    /* Init */
    applyLangUI();
    const p=new URLSearchParams(location.search).get('emp');
    if(p){document.getElementById('empId').value=p;loadSchedule(p);}
    else{const saved=localStorage.getItem('savedEmpId');if(saved){document.getElementById('empId').value=saved;loadSchedule(saved);}}
  </script>
</body>
</html>
