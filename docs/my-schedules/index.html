<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Schedule</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* =========================================================
       My Schedule â€” Responsive Redesign (Mobile + Windows)
       ========================================================= */
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --ink:#0b162a;
      --muted:#64748b;
      --border:#e6ebf2;
      --shadow:0 10px 30px rgba(11,22,42,.08);
      --shadow2:0 14px 44px rgba(11,22,42,.14);
      --r:18px;

      --navy:#0a1628;
      --blue:#1d4ed8;
      --sky:#3b82f6;
      --cyan:#06b6d4;
      --amber:#f59e0b;
      --orange:#f97316;
      --violet:#7c3aed;
      --green:#22c55e;
      --pink:#ec4899;
      --slate:#94a3b8;

      --container:1150px;
      --pad:clamp(14px, 3.4vw, 24px);
    }

    body{
      font-family:"Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:radial-gradient(1200px 600px at 15% -10%, rgba(29,78,216,.12), transparent 45%),
                 radial-gradient(900px 520px at 95% 0%, rgba(6,182,212,.10), transparent 45%),
                 var(--bg);
      color:var(--ink);
      min-height:100vh;
      font-size:14px;
    }
    body.ar{direction:rtl;}
    a{color:inherit}

    /* =================== Layout =================== */
    .shell{min-height:100vh; display:flex; flex-direction:column}
    .container{width:min(var(--container), 100%); margin:0 auto; padding:0 var(--pad)}
    .stack{display:flex; flex-direction:column; gap:16px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
    }

    /* =================== Topbar =================== */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(135deg, var(--navy), #153257);
      border-bottom:1px solid rgba(255,255,255,.08);
      box-shadow:0 2px 14px rgba(10,22,40,.18);
    }
    .topbar-inner{
      height:64px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      color:#fff;
      min-width:0;
    }
    .brand-badge{
      width:40px; height:40px; border-radius:14px;
      background:linear-gradient(135deg,var(--blue),var(--cyan));
      display:grid; place-items:center;
      box-shadow:0 10px 22px rgba(29,78,216,.28);
      flex:0 0 auto;
      font-size:18px;
    }
    .brand-text{min-width:0}
    .brand-title{
      font-size:15px; font-weight:900; letter-spacing:-.2px; line-height:1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand-sub{
      margin-top:2px;
      font-size:11px; font-weight:700; letter-spacing:.2px;
      color:rgba(255,255,255,.72);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .top-actions{display:flex; align-items:center; gap:8px; flex:0 0 auto}
    .btn{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:#fff;
      border-radius:12px;
      padding:9px 12px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
      transition:transform .15s, background .15s, border-color .15s, box-shadow .15s;
      font-family:inherit;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.18); transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{
      border:0;
      background:linear-gradient(135deg,var(--blue),var(--cyan));
      box-shadow:0 10px 20px rgba(29,78,216,.28);
    }
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.ghost{
      border:1px solid rgba(255,255,255,.18);
      background:transparent;
    }

    /* =================== Hero / Search =================== */
    .hero{
      padding:18px 0 12px;
    }
    .hero-grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      align-items:stretch;
    }
    @media(max-width: 900px){
      .hero-grid{grid-template-columns:1fr}
    }
    .hero-card{
      background:linear-gradient(135deg, rgba(10,22,40,.86), rgba(30,58,95,.86));
      border:1px solid rgba(255,255,255,.12);
      border-radius:var(--r);
      box-shadow:var(--shadow2);
      padding:18px;
      color:#fff;
      overflow:hidden;
      position:relative;
    }
    .hero-card::after{
      content:"";
      position:absolute; inset:-60px -60px auto auto;
      width:220px; height:220px;
      background:radial-gradient(circle at 30% 30%, rgba(6,182,212,.38), transparent 55%),
                 radial-gradient(circle at 60% 60%, rgba(29,78,216,.38), transparent 55%);
      transform:rotate(10deg);
      pointer-events:none;
    }
    .hero-head{display:flex; gap:14px; align-items:flex-start; position:relative; z-index:1}
    .hero-ico{
      width:46px; height:46px; border-radius:16px;
      background:rgba(255,255,255,.12);
      display:grid; place-items:center;
      font-size:20px;
      border:1px solid rgba(255,255,255,.14);
      flex:0 0 auto;
    }
    .hero-copy{min-width:0}
    .hero-title{
      font-size:18px; font-weight:900; letter-spacing:-.3px;
      line-height:1.2;
    }
    .hero-desc{
      margin-top:6px;
      color:rgba(255,255,255,.78);
      font-size:12px;
      font-weight:600;
      line-height:1.55;
      max-width:62ch;
    }

    .search{
      margin-top:14px;
      display:flex; gap:10px;
      align-items:stretch;
      position:relative; z-index:1;
    }
    .input{
      flex:1;
      border-radius:14px;
      border:1.5px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.10);
      color:#fff;
      padding:12px 14px;
      font-size:14px;
      font-weight:700;
      font-family:inherit;
      outline:none;
      transition:box-shadow .15s, border-color .15s, background .15s;
      direction:ltr;
    }
    body.ar .input{direction:ltr;} /* employee ID is numbers */
    .input::placeholder{color:rgba(255,255,255,.42); font-weight:600}
    .input:focus{
      border-color:rgba(59,130,246,.75);
      background:rgba(255,255,255,.14);
      box-shadow:0 0 0 4px rgba(59,130,246,.20);
    }

    .hint-card{
      padding:16px 16px 18px;
    }
    .hint-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:12px;
    }
    .hint-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.9px;
      font-weight:900;
      color:var(--muted);
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border);
      background:#f8fafc;
      color:var(--muted);
      border-radius:999px;
      padding:6px 10px;
      font-size:11px; font-weight:800;
      white-space:nowrap;
    }
    .tip{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:linear-gradient(135deg, #ffffff, #fbfdff);
    }
    .tip + .tip{margin-top:10px}
    .tip-ico{font-size:18px; width:26px; text-align:center; margin-top:1px}
    .tip-text{font-size:12px; color:var(--muted); line-height:1.6; font-weight:700}

    /* =================== Main =================== */
    main{padding:10px 0 26px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:16px;
      align-items:start;
    }
    @media(max-width: 980px){ .grid{grid-template-columns:1fr} }

    /* =================== Employee Header =================== */
    .emp{
      padding:16px;
      overflow:hidden;
    }
    .emp-row{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .emp-left{
      display:flex; align-items:center; gap:12px; min-width:0;
    }
    .avatar{
      width:54px; height:54px; border-radius:18px;
      background:linear-gradient(135deg,var(--blue),var(--cyan));
      display:grid; place-items:center;
      color:#fff; font-weight:900; font-size:20px;
      box-shadow:0 12px 26px rgba(29,78,216,.25);
      flex:0 0 auto;
    }
    .emp-name{
      font-size:18px; font-weight:900; letter-spacing:-.25px;
      line-height:1.15;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      max-width:min(560px, 72vw);
    }
    .emp-meta{
      margin-top:6px;
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border);
      background:#f8fafc;
      border-radius:12px;
      padding:6px 10px;
      font-size:11px;
      font-weight:800;
      color:var(--muted);
      white-space:nowrap;
    }
    .emp-actions{display:flex; align-items:center; gap:8px}
    .btn2{
      border:1px solid var(--border);
      background:#fff;
      color:var(--ink);
      border-radius:12px;
      padding:9px 12px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      transition:transform .15s, box-shadow .15s, border-color .15s;
      font-family:inherit;
      white-space:nowrap;
    }
    .btn2:hover{transform:translateY(-1px); box-shadow:0 12px 18px rgba(11,22,42,.08); border-color:#d9e2ef}
    .btn2:active{transform:translateY(0)}
    .btn2.primary{
      border:0;
      color:#fff;
      background:linear-gradient(135deg,var(--blue),var(--cyan));
    }

    /* Month control */
    .month{
      display:flex; align-items:center; gap:8px;
    }
    .m-btn{
      width:38px; height:38px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-size:16px;
      display:grid; place-items:center;
      transition:transform .15s, box-shadow .15s, border-color .15s;
      font-family:inherit;
    }
    .m-btn:hover{transform:translateY(-1px); box-shadow:0 12px 18px rgba(11,22,42,.08); border-color:#d9e2ef}
    .m-btn:disabled{opacity:.4; cursor:not-allowed; transform:none; box-shadow:none}
    .m-sel{
      height:38px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      padding:8px 12px;
      font-size:12px;
      font-weight:900;
      color:var(--ink);
      cursor:pointer;
      font-family:inherit;
      min-width:170px;
      appearance:none;
      -webkit-appearance:none;
      outline:none;
      text-align:center;
    }

    /* =================== Calendar =================== */
    .cal{overflow:hidden}
    .cal-head{
      display:grid; grid-template-columns:repeat(7,1fr);
      background:linear-gradient(135deg, var(--navy), #123055);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .cal-head div{
      padding:10px 6px;
      text-align:center;
      font-size:11px;
      font-weight:900;
      letter-spacing:.5px;
      color:rgba(255,255,255,.78);
    }

    .cal-body{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      background:var(--border);
      gap:1px;
    }
    .day{
      background:#fff;
      min-height:96px;
      padding:8px 6px;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:space-between;
      position:relative;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .day:hover{transform:translateY(-1px); box-shadow:0 10px 18px rgba(11,22,42,.06); z-index:1}
    .day.empty{background:#fbfcfe; box-shadow:none; transform:none}
    .day .top{display:flex; align-items:center; justify-content:space-between; width:100%}
    .dnum{
      font-weight:1000; font-size:13px; color:var(--ink); letter-spacing:-.2px;
    }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      font-weight:1000;
      font-size:11px;
      border-radius:10px;
      padding:5px 10px;
      border:1px solid transparent;
      letter-spacing:.25px;
      white-space:nowrap;
    }
    .ico{font-size:18px; line-height:1}
    .today::after{
      content:"";
      position:absolute; inset:6px;
      border:2px solid rgba(29,78,216,.85);
      border-radius:14px;
      pointer-events:none;
    }

    /* shift themes */
    .s-morning   {background:#fffbf0}
    .s-afternoon {background:#fff8f5}
    .s-night     {background:#faf5ff}
    .s-off       {background:#f8fafc}
    .s-leave     {background:#f0fdf4}
    .s-training  {background:#f0f9ff}
    .s-standby   {background:#fdf2f8}
    .s-other     {background:#fbfcfe}

    .s-morning   .tag{color:#b45309;background:#fef3c7;border-color:#fde68a}
    .s-afternoon .tag{color:#c2410c;background:#ffedd5;border-color:#fed7aa}
    .s-night     .tag{color:#5b21b6;background:#ede9fe;border-color:#ddd6fe}
    .s-off       .tag{color:#475569;background:#e2e8f0;border-color:#cbd5e1}
    .s-leave     .tag{color:#15803d;background:#dcfce7;border-color:#bbf7d0}
    .s-training  .tag{color:#1d4ed8;background:#dbeafe;border-color:#bfdbfe}
    .s-standby   .tag{color:#be185d;background:#fce7f3;border-color:#fbcfe8}
    .s-other     .tag{color:#6b7280;background:#f3f4f6;border-color:#e5e7eb}

    /* Responsive calendar */
    @media(max-width: 520px){
      .day{min-height:78px; padding:7px 6px}
      .ico{font-size:16px}
      .tag{font-size:10px; padding:4px 8px}
      .m-sel{min-width:150px}
    }

    /* =================== Sidebar =================== */
    .side{position:sticky; top:84px}
    @media(max-width: 980px){ .side{position:static} }

    .panel-head{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(135deg,#ffffff,#fbfdff);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panel-title{
      font-size:11px;
      font-weight:1000;
      letter-spacing:.9px;
      text-transform:uppercase;
      color:var(--muted);
    }

    /* Stats */
    .stats{padding:12px 12px 14px}
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
    }
    .stat{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 12px;
      background:linear-gradient(135deg,#fff,#fbfdff);
      display:flex; align-items:center; gap:10px;
      min-height:64px;
    }
    .dot{
      width:40px; height:40px;
      border-radius:16px;
      display:grid; place-items:center;
      font-size:18px;
      flex:0 0 auto;
    }
    .sv{font-size:20px; font-weight:1000; color:var(--ink); line-height:1}
    .sl{margin-top:2px; font-size:11px; font-weight:900; color:var(--muted)}
    .stat.full{grid-column:1/-1}

    /* Actions */
    .actions{padding:12px}
    .action-grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
    }
    .a{
      border:1px solid var(--border);
      background:#fff;
      border-radius:16px;
      padding:12px 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
      font-family:inherit;
      transition:transform .15s, box-shadow .15s, border-color .15s;
      text-align:left;
    }
    body.ar .a{text-align:right}
    .a:hover{transform:translateY(-1px); box-shadow:0 12px 18px rgba(11,22,42,.08); border-color:#d9e2ef}
    .a .ai{font-size:20px; width:26px; text-align:center}
    .a .al{font-size:12px; font-weight:1000; color:var(--ink)}
    .a.full{
      grid-column:1/-1;
      border:0;
      color:#fff;
      background:linear-gradient(135deg,var(--blue),var(--cyan));
      box-shadow:0 12px 22px rgba(29,78,216,.22);
      justify-content:center;
      text-align:center;
    }
    .a.full .al{color:#fff}

    /* Legend */
    .legend{padding:14px 16px 16px}
    .legend-grid{display:flex; flex-wrap:wrap; gap:8px}
    .leg{
      display:inline-flex; align-items:center; gap:7px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:7px 10px;
      font-size:11px;
      font-weight:900;
      color:var(--muted);
      white-space:nowrap;
    }
    .l-dot{width:10px; height:10px; border-radius:4px}

    /* =================== Empty / Loading =================== */
    .state{
      padding:46px 16px;
      text-align:center;
    }
    .state-ico{font-size:44px; opacity:.9}
    .state h3{margin-top:10px; font-size:18px; font-weight:1000; letter-spacing:-.2px}
    .state p{margin-top:6px; font-size:12px; font-weight:700; color:var(--muted); line-height:1.6; max-width:52ch; margin-left:auto; margin-right:auto}
    .spin{
      width:38px;height:38px;border:3px solid var(--border);
      border-top-color:var(--blue);border-radius:50%;
      animation:spin 1s linear infinite;margin:0 auto 12px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* =================== Save popup =================== */
    .toast{
      position:fixed;
      inset:auto var(--pad) 18px var(--pad);
      display:flex;
      justify-content:center;
      z-index:9999;
      pointer-events:none;
    }
    .toast > .toast-card{
      pointer-events:auto;
      width:min(520px, 100%);
      background:linear-gradient(135deg, var(--navy), #153257);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow:0 18px 56px rgba(10,22,40,.35);
      padding:14px 14px 12px;
      animation:up .28s cubic-bezier(.22,1,.36,1);
    }
    @keyframes up{from{opacity:0; transform:translateY(14px)} to{opacity:1; transform:translateY(0)}}
    .toast-row{display:flex; align-items:flex-start; gap:12px}
    .toast-ico{
      width:40px;height:40px;border-radius:16px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      flex:0 0 auto;
      font-size:18px;
    }
    .toast p{font-size:12.5px; font-weight:700; line-height:1.55; color:rgba(255,255,255,.86)}
    .toast strong{color:#fff}
    .toast-actions{display:flex; gap:10px; margin-top:10px}
    .tbtn{
      flex:1;
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-family:inherit;
      font-weight:1000;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.10);
      color:#fff;
      transition:transform .12s, background .12s;
    }
    .tbtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.16)}
    .tbtn.primary{border:0; background:linear-gradient(135deg,var(--blue),var(--cyan))}
    .tbtn.primary:hover{filter:brightness(1.06)}

    /* =================== Print =================== */
    @media print{
      .topbar,.hero,.actions,.top-actions,.toast{display:none!important}
      body{background:#fff}
      .card{box-shadow:none}
      .side{display:none}
      main{padding:0}
    }
  </style>
</head>

<body>
<div class="shell">

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <div class="brand-badge">ğŸ“…</div>
        <div class="brand-text">
          <div class="brand-title" id="ttl">My Schedule</div>
          <div class="brand-sub" id="sub">Enter your Employee ID</div>
        </div>
      </div>

      <div class="top-actions">
        <button class="btn ghost" type="button" onclick="toggleLang()" id="langBtn">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
        <button class="btn" type="button" onclick="goBack()" id="backBtn">â† Back</button>
      </div>
    </div>
  </header>

  <!-- HERO / SEARCH -->
  <section class="hero">
    <div class="container hero-grid">
      <div class="hero-card">
        <div class="hero-head">
          <div class="hero-ico">ğŸ”</div>
          <div class="hero-copy">
            <div class="hero-title" id="heroTitle">Find your monthly roster</div>
            <div class="hero-desc" id="heroDesc">
              Enter your Employee ID, then download your schedule as PDF / Image, or add it to your calendar (ICS).
            </div>
          </div>
        </div>

        <form class="search" id="searchForm">
          <input class="input" id="empId" inputmode="numeric" autocomplete="off"
                 placeholder="e.g. 12345" pattern="[0-9]+" required />
          <button class="btn primary" type="submit" id="sbtn">ğŸ“… View</button>
        </form>
      </div>

      <div class="card hint-card">
        <div class="hint-top">
          <div class="hint-title" id="tipsTitle">Tips</div>
          <span class="pill" id="pill">âœ¨ Mobile-ready</span>
        </div>
        <div class="tip">
          <div class="tip-ico">ğŸ’¾</div>
          <div class="tip-text" id="tip1">Save your Employee ID once â€” it will load automatically next time.</div>
        </div>
        <div class="tip">
          <div class="tip-ico">ğŸ–¼ï¸</div>
          <div class="tip-text" id="tip2">Image export produces a clean card with header, calendar, legend, and stats.</div>
        </div>
        <div class="tip">
          <div class="tip-ico">âŒ¨ï¸</div>
          <div class="tip-text" id="tip3">Works best on phone and Windows browsers (Edge/Chrome).</div>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <main>
    <div class="container">
      <div id="area" class="stack">
        <div class="card state">
          <div class="state-ico">ğŸ“†</div>
          <h3 id="e1">Search your schedule</h3>
          <p id="e2">Enter your Employee ID above to view your monthly roster.</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast mount -->
  <div class="toast" id="toastMount" style="display:none"></div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* =========================
   Data + i18n
   ========================= */
let data=null, month=null, months=[], lang='en';

const COLORS={
  Morning:       {strip:'#f59e0b', icon:'â˜€ï¸', dot:'#f59e0b', bg:'#fffbf0'},
  Afternoon:     {strip:'#f97316', icon:'ğŸŒ¤ï¸', dot:'#f97316', bg:'#fff8f5'},
  Night:         {strip:'#7c3aed', icon:'ğŸŒ™', dot:'#7c3aed', bg:'#faf5ff'},
  'Off Day':     {strip:'#94a3b8', icon:'ğŸ–ï¸', dot:'#94a3b8', bg:'#f8fafc'},
  'Annual Leave':{strip:'#22c55e', icon:'âœˆï¸', dot:'#22c55e', bg:'#f0fdf4'},
  'Sick Leave':  {strip:'#22c55e', icon:'ğŸ¤’', dot:'#22c55e', bg:'#f0fdf4'},
  Training:      {strip:'#3b82f6', icon:'ğŸ“š', dot:'#3b82f6', bg:'#f0f9ff'},
  Standby:       {strip:'#ec4899', icon:'ğŸ§', dot:'#ec4899', bg:'#fdf2f8'},
  Other:         {strip:'#9ca3af', icon:'â“', dot:'#9ca3af', bg:'#fbfcfe'}
};

const STAT_META=[
  {k:'work',     icon:'ğŸ’¼', bg:'#eff6ff', label_en:'Work Days', label_ar:'Ø£ÙŠØ§Ù… Ø¹Ù…Ù„'},
  {k:'off',      icon:'ğŸ›Œ', bg:'#f8fafc', label_en:'Days Off',  label_ar:'Ø¥Ø¬Ø§Ø²Ø§Øª'},
  {k:'morning',  icon:'â˜€ï¸', bg:'#fffbf0', label_en:'Morning',   label_ar:'ØµØ¨Ø§Ø­ÙŠ'},
  {k:'afternoon',icon:'ğŸŒ¤ï¸', bg:'#fff8f5', label_en:'Afternoon', label_ar:'Ù…Ø³Ø§Ø¦ÙŠ'},
  {k:'night',    icon:'ğŸŒ™', bg:'#faf5ff', label_en:'Night',     label_ar:'Ù„ÙŠÙ„ÙŠ'},
  {k:'standby',  icon:'ğŸ§', bg:'#fdf2f8', label_en:'Standby',   label_ar:'Ø§Ø­ØªÙŠØ§Ø·'},
  {k:'leaves',   icon:'âœˆï¸', bg:'#f0fdf4', label_en:'Leaves',    label_ar:'Ø¥Ø¬Ø§Ø²Ø§Øª Ø³Ù†ÙˆÙŠØ©/Ù…Ø±Ø¶ÙŠØ©'}
];

const T={
  en:{
    title:'My Schedule',
    sub:'Enter your Employee ID',
    heroTitle:'Find your monthly roster',
    heroDesc:'Enter your Employee ID, then download your schedule as PDF / Image, or add it to your calendar (ICS).',
    tipsTitle:'Tips',
    pill:'âœ¨ Mobile-ready',
    tip1:'Save your Employee ID once â€” it will load automatically next time.',
    tip2:'Image export produces a clean card with header, calendar, legend, and stats.',
    tip3:'Works best on phone and Windows browsers (Edge/Chrome).',
    back:'â† Back',
    langBtn:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
    ph:'e.g. 12345',
    sbtn:'ğŸ“… View',
    e1:'Search your schedule',
    e2:'Enter your Employee ID above to view your monthly roster.',
    loading:'Loadingâ€¦',
    notFound:'Employee not found',
    notFoundSub:'ID not in the system. Please check and try again.',
    statsTitle:'Statistics',
    actionsTitle:'Actions',
    legendTitle:'Legend',
    pdf:'Download PDF',
    img:'Download Image',
    share:'Share Link',
    print:'Print',
    ics:'Export ICS',
    days:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
    months:['January','February','March','April','May','June','July','August','September','October','November','December'],
    legend:{Morning:'Morning',Afternoon:'Afternoon',Night:'Night','Off Day':'Day Off','Annual Leave':'Annual Leave','Sick Leave':'Sick Leave',Training:'Training',Standby:'Standby',Other:'Other'},
    saveTitle:'Save your ID?',
    saveSub:'Save it to open your schedule faster next time.',
    saveYes:'âœ… Yes, save',
    saveNo:'Not now',
    changeId:'Change My ID',
    setAsMyId:'Set as My ID',
    dept:'Department',
    id:'ID'
  },
  ar:{
    title:'Ø¬Ø¯ÙˆÙ„ÙŠ',
    sub:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ',
    heroTitle:'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª',
    heroDesc:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø«Ù… Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ PDF/ØµÙˆØ±Ø© Ø£Ùˆ Ø£Ø¶ÙÙ‡ Ù„Ù„ØªÙ‚ÙˆÙŠÙ… (ICS).',
    tipsTitle:'Ù†ØµØ§Ø¦Ø­',
    pill:'âœ¨ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¬ÙˆØ§Ù„',
    tip1:'Ø§Ø­ÙØ¸ Ø±Ù‚Ù…Ùƒ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© â€” ÙˆØ³ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.',
    tip2:'Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© ÙŠÙ†ØªØ¬ Ø¨Ø·Ø§Ù‚Ø© Ù…Ø±ØªØ¨Ø© (Ø±Ø£Ø³ + ØªÙ‚ÙˆÙŠÙ… + Ø¯Ù„ÙŠÙ„ + Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª).',
    tip3:'ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ù…ØªØ§Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆÙˆÙŠÙ†Ø¯ÙˆØ² (Edge/Chrome).',
    back:'Ø±Ø¬ÙˆØ¹ â†',
    langBtn:'English',
    ph:'Ù…Ø«Ø§Ù„: 12345',
    sbtn:'ğŸ“… Ø¹Ø±Ø¶',
    e1:'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¬Ø¯ÙˆÙ„Ùƒ',
    e2:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¹Ø±Ø¶ Ù…Ù†Ø§ÙˆØ¨Ø§ØªÙƒ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©.',
    loading:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦',
    notFound:'Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù',
    notFoundSub:'Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ØªØ­Ù‚Ù‚ ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.',
    statsTitle:'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',
    actionsTitle:'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª',
    legendTitle:'Ø§Ù„Ø¯Ù„ÙŠÙ„',
    pdf:'ØªØ­Ù…ÙŠÙ„ PDF',
    img:'ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©',
    share:'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ø§Ø¨Ø·',
    print:'Ø·Ø¨Ø§Ø¹Ø©',
    ics:'ØªØµØ¯ÙŠØ± ICS',
    days:['Ø§Ù„Ø£Ø­','Ø§Ù„Ø§Ø«','Ø§Ù„Ø«Ù„','Ø§Ù„Ø£Ø±','Ø§Ù„Ø®Ù…','Ø§Ù„Ø¬Ù…','Ø§Ù„Ø³Ø¨'],
    months:['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'],
    legend:{Morning:'ØµØ¨Ø§Ø­ÙŠ',Afternoon:'Ù…Ø³Ø§Ø¦ÙŠ',Night:'Ù„ÙŠÙ„ÙŠ','Off Day':'Ø¥Ø¬Ø§Ø²Ø©','Annual Leave':'Ø³Ù†ÙˆÙŠØ©','Sick Leave':'Ù…Ø±Ø¶ÙŠØ©',Training:'ØªØ¯Ø±ÙŠØ¨',Standby:'Ø§Ø­ØªÙŠØ§Ø·ÙŠ',Other:'Ø£Ø®Ø±Ù‰'},
    saveTitle:'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù…ØŸ',
    saveSub:'Ø§Ø­ÙØ¸Ù‡ Ù„ÙØªØ­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.',
    saveYes:'âœ… Ù†Ø¹Ù…ØŒ Ø§Ø­ÙØ¸',
    saveNo:'Ù„ÙŠØ³ Ø§Ù„Ø¢Ù†',
    changeId:'ØªØºÙŠÙŠØ± Ø±Ù‚Ù…ÙŠ',
    setAsMyId:'Ø§Ø­ÙØ¸ ÙƒØ±Ù‚Ù…ÙŠ',
    dept:'Ø§Ù„Ù‚Ø³Ù…',
    id:'Ø§Ù„Ø±Ù‚Ù…'
  }
};

function t(k){ return T[lang][k]; }
function esc(s){ return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function applyLangUI(){
  document.documentElement.lang = lang;
  document.documentElement.dir  = lang==='ar' ? 'rtl' : 'ltr';
  document.body.classList.toggle('ar', lang==='ar');

  // top
  document.getElementById('ttl').textContent = t('title');
  document.getElementById('sub').textContent = t('sub');
  document.getElementById('langBtn').textContent = t('langBtn');
  document.getElementById('backBtn').textContent = t('back');

  // hero
  document.getElementById('heroTitle').textContent = t('heroTitle');
  document.getElementById('heroDesc').textContent  = t('heroDesc');
  document.getElementById('tipsTitle').textContent = t('tipsTitle');
  document.getElementById('pill').textContent      = t('pill');
  document.getElementById('tip1').textContent      = t('tip1');
  document.getElementById('tip2').textContent      = t('tip2');
  document.getElementById('tip3').textContent      = t('tip3');

  // form
  document.getElementById('empId').placeholder = t('ph');
  document.getElementById('sbtn').textContent  = t('sbtn');

  // empty state
  const e1=document.getElementById('e1'), e2=document.getElementById('e2');
  if(e1) e1.textContent = t('e1');
  if(e2) e2.textContent = t('e2');

  if(data) renderSchedule();
}
function toggleLang(){ lang = (lang==='en'?'ar':'en'); applyLangUI(); }

/* =========================
   Navigation
   ========================= */
function goBack(){
  const base = location.pathname.includes('/roster-site/') ? '/roster-site/' : '/';
  if(document.referrer && document.referrer.includes(location.host)) history.back();
  else location.href = base;
}

/* =========================
   Load schedule
   ========================= */
document.getElementById('searchForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('empId').value.trim();
  if(id) await loadSchedule(id);
});

async function loadSchedule(id){
  document.getElementById('area').innerHTML = `
    <div class="card state">
      <div class="spin"></div>
      <h3>${t('loading')}</h3>
      <p>${lang==='ar'?'Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø§Øªâ€¦':'Please wait a momentâ€¦'}</p>
    </div>`;

  try{
    const res = await fetch(`../schedules/${id}.json`);
    if(!res.ok) throw new Error('not found');
    data = await res.json();

    months = Object.keys(data.schedules || {}).sort();
    if(!months.length) throw new Error('empty schedules');

    const savedId = localStorage.getItem('savedEmpId');
    if(!savedId) showSaveToast(id, data.name);

    const now = new Date();
    const cur = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
    month = months.includes(cur) ? cur : months[months.length-1];

    renderSchedule();
  }catch(err){
    document.getElementById('area').innerHTML = `
      <div class="card state">
        <div class="state-ico">âŒ</div>
        <h3>${t('notFound')}</h3>
        <p>${t('notFoundSub')}</p>
      </div>`;
  }
}

/* =========================
   Save ID toast (redesigned)
   ========================= */
function showSaveToast(id, name){
  const mount = document.getElementById('toastMount');
  const first = (name ? name.split(' ')[0] : id);
  mount.style.display='flex';
  mount.innerHTML = `
    <div class="toast-card" id="saveToast">
      <div class="toast-row">
        <div class="toast-ico">ğŸ’¾</div>
        <div>
          <p><strong>${t('saveTitle')}</strong><br>
          ${lang==='ar' ? 'Ù‡Ù„ Ø£Ù†Øª ' : 'Are you '}<strong>${esc(first)}</strong>? ${t('saveSub')}</p>
        </div>
      </div>
      <div class="toast-actions">
        <button class="tbtn primary" onclick="confirmSave('${id}')">${t('saveYes')}</button>
        <button class="tbtn" onclick="dismissToast()">${t('saveNo')}</button>
      </div>
    </div>`;
  setTimeout(()=>dismissToast(), 10000);
}
function confirmSave(id){ localStorage.setItem('savedEmpId', id); dismissToast(); renderSchedule(); }
function dismissToast(){ const mount=document.getElementById('toastMount'); mount.innerHTML=''; mount.style.display='none'; }

function changeMyId(){
  const msg = lang==='ar' ? 'Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ØŸ' : 'Change your saved Employee ID?';
  if(confirm(msg)){ localStorage.removeItem('savedEmpId'); renderSchedule(); }
}
function setAsMyId(){
  if(data && data.id){ localStorage.setItem('savedEmpId', data.id); renderSchedule(); }
}

/* =========================
   Render schedule UI
   ========================= */
function renderSchedule(){
  const sched = data.schedules[month] || [];
  const [yr, mo] = month.split('-').map(Number);
  const ci = months.indexOf(month);
  const hasPrev = ci>0, hasNext = ci<months.length-1;

  const firstDow = new Date(yr, mo-1, 1).getDay();
  const dim = new Date(yr, mo, 0).getDate();

  const stats = calcStats(sched);
  const savedId = localStorage.getItem('savedEmpId');
  const isMyId = savedId === data.id;

  // cells
  let cells='', dc=1;
  const now = new Date();
  for(let w=0; w<6; w++){
    for(let d=0; d<7; d++){
      if((w===0 && d<firstDow) || dc>dim){
        cells += `<div class="day empty"></div>`;
      }else{
        const dd = sched.find(s => s.day===dc);
        const sc = dd ? shiftClass(dd.shift_group) : '';
        const icon = dd ? (COLORS[dd.shift_group]?.icon || '') : '';
        const code = (dd && dd.shift_code) ? `<span class="tag">${esc(dd.shift_code)}</span>` : '';
        const isToday = (now.getFullYear()===yr && (now.getMonth()+1)===mo && now.getDate()===dc);
        cells += `
          <div class="day ${sc} ${isToday?'today':''}">
            <div class="top">
              <div class="dnum">${dc}</div>
              <div class="ico" aria-hidden="true">${icon || ''}</div>
            </div>
            <div>${code}</div>
          </div>`;
        dc++;
      }
    }
    if(dc>dim) break;
  }

  // day headers
  const dayHdr = T[lang].days.map(d=>`<div>${d}</div>`).join('');

  // month options
  const monthOpts = months.map(m=>{
    const p=m.split('-').map(Number);
    const label = `${T[lang].months[p[1]-1]} ${p[0]}`;
    return `<option value="${m}" ${m===month?'selected':''}>${label}</option>`;
  }).join('');

  // legend (only used shift types)
  const used = [...new Set(sched.map(s=>s.shift_group))];
  const legHTML = used.map(g=>{
    const c=COLORS[g]; if(!c) return '';
    return `<span class="leg"><span class="l-dot" style="background:${c.dot}"></span>${T[lang].legend[g] || g}</span>`;
  }).join('');

  // stats cards
  const statsHTML = STAT_META.map(m=>{
    const label = (lang==='ar' ? m.label_ar : m.label_en);
    const full = (m.k==='work') ? ' full' : '';
    return `
      <div class="stat${full}">
        <div class="dot" style="background:${m.bg}">${m.icon}</div>
        <div>
          <div class="sv">${stats[m.k]}</div>
          <div class="sl">${label}</div>
        </div>
      </div>`;
  }).join('');

  // change / set button
  const changeBtn = isMyId
    ? `<button class="btn2" type="button" onclick="changeMyId()">âœï¸ ${t('changeId')}</button>`
    : (!savedId ? '' : `<button class="btn2" type="button" onclick="setAsMyId()">ğŸ“Œ ${t('setAsMyId')}</button>`);

  // initials
  const initials = (data.name || '?').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();

  document.getElementById('area').innerHTML = `
    <section class="card emp">
      <div class="emp-row">
        <div class="emp-left">
          <div class="avatar">${esc(initials)}</div>
          <div style="min-width:0">
            <div class="emp-name">${esc(data.name)}</div>
            <div class="emp-meta">
              <span class="badge">ğŸ“‹ ${t('dept')}: ${esc(data.department)}</span>
              <span class="badge">ğŸ†” ${t('id')}: ${esc(data.id)}</span>
              ${changeBtn}
            </div>
          </div>
        </div>

        <div class="month">
          <button class="m-btn" type="button" onclick="chMonth(-1)" ${!hasPrev?'disabled':''} aria-label="Prev month">â€¹</button>
          <select class="m-sel" onchange="jumpMonth(this.value)" aria-label="Month select">${monthOpts}</select>
          <button class="m-btn" type="button" onclick="chMonth(1)" ${!hasNext?'disabled':''} aria-label="Next month">â€º</button>
        </div>
      </div>
    </section>

    <section class="grid">
      <div class="stack">
        <div class="card cal">
          <div class="cal-head">${dayHdr}</div>
          <div class="cal-body">${cells}</div>
        </div>

        <div class="card legend">
          <div class="panel-title" style="margin-bottom:10px">${t('legendTitle')}</div>
          <div class="legend-grid">${legHTML || `<span class="leg"><span class="l-dot" style="background:#cbd5e1"></span>${lang==='ar'?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª':'No data'}</span>`}</div>
        </div>
      </div>

      <aside class="side stack">
        <div class="card">
          <div class="panel-head">
            <div class="panel-title">${t('statsTitle')}</div>
            <span class="pill">ğŸ“Š</span>
          </div>
          <div class="stats">
            <div class="stats-grid">${statsHTML}</div>
          </div>
        </div>

        <div class="card">
          <div class="panel-head">
            <div class="panel-title">${t('actionsTitle')}</div>
            <span class="pill">âš¡</span>
          </div>
          <div class="actions">
            <div class="action-grid">
              <button class="a full" type="button" onclick="dlPDF()"><span class="ai">ğŸ“¥</span><span class="al">${t('pdf')}</span></button>
              <button class="a" type="button" onclick="dlIMG()"><span class="ai">ğŸ–¼ï¸</span><span class="al">${t('img')}</span></button>
              <button class="a" type="button" onclick="dlICS()"><span class="ai">ğŸ“†</span><span class="al">${t('ics')}</span></button>
              <button class="a" type="button" onclick="shareS()"><span class="ai">ğŸ”—</span><span class="al">${t('share')}</span></button>
              <button class="a" type="button" onclick="window.print()"><span class="ai">ğŸ–¨ï¸</span><span class="al">${t('print')}</span></button>
            </div>
          </div>
        </div>
      </aside>
    </section>
  `;
}

function chMonth(dir){
  const ci=months.indexOf(month), ni=ci+dir;
  if(ni>=0 && ni<months.length){ month=months[ni]; renderSchedule(); }
}
function jumpMonth(val){
  if(months.includes(val)){ month=val; renderSchedule(); }
}

/* =========================
   Stats & helpers
   ========================= */
function calcStats(s){
  const r={work:0,off:0,morning:0,afternoon:0,night:0,standby:0,leaves:0};
  s.forEach(d=>{
    if(d.shift_group==='Morning') r.morning++;
    else if(d.shift_group==='Afternoon') r.afternoon++;
    else if(d.shift_group==='Night') r.night++;
    else if(d.shift_group==='Off Day') r.off++;
    else if(d.shift_group==='Standby') r.standby++;
    else if(d.shift_group==='Annual Leave' || d.shift_group==='Sick Leave') r.leaves++;
  });
  r.work = r.morning + r.afternoon + r.night;
  return r;
}
function shiftClass(g){
  return {
    Morning:'s-morning',Afternoon:'s-afternoon',Night:'s-night',
    'Off Day':'s-off','Annual Leave':'s-leave','Sick Leave':'s-leave',
    Training:'s-training',Standby:'s-standby',Other:'s-other'
  }[g] || 's-other';
}

/* =========================
   IMAGE DOWNLOAD (redesigned output)
   - Uses current language for titles/legend labels
   - Cleaner proportions for mobile + Windows
   ========================= */
async function dlIMG(){
  if(!window.html2canvas){ alert('Image library loading, please try again.'); return; }
  const calEl=document.querySelector('.cal');
  if(!calEl){ alert('No calendar to capture.'); return; }

  const sched = data.schedules[month] || [];
  const [yr, mo] = month.split('-').map(Number);
  const mName = `${T[lang].months[mo-1]} ${yr}`;
  const stats = calcStats(sched);
  const used = [...new Set(sched.map(s=>s.shift_group))];

  // Decide render width (nice on Windows + still fine on phones)
  const W = Math.max(Math.min(calEl.offsetWidth, 980), 720);

  const wrap = document.createElement('div');
  wrap.dir = (lang==='ar'?'rtl':'ltr');
  wrap.style.cssText = `
    position:fixed; left:-9999px; top:0;
    width:${W}px;
    background:#f6f8fc;
    font-family:"Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    border-radius:22px;
    overflow:hidden;
    border:1px solid #e6ebf2;
  `;

  // Header
  const initials=(data.name||'?').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
  const hdr = document.createElement('div');
  hdr.style.cssText = `
    background:linear-gradient(135deg,#0a1628,#153257);
    padding:18px 20px;
    display:flex; align-items:center; justify-content:space-between;
    gap:14px;
  `;
  hdr.innerHTML = `
    <div style="display:flex; align-items:center; gap:12px; min-width:0">
      <div style="width:48px;height:48px;border-radius:16px;background:linear-gradient(135deg,#1d4ed8,#06b6d4);display:grid;place-items:center;color:#fff;font-weight:900;font-size:18px;flex:0 0 auto">${esc(initials)}</div>
      <div style="min-width:0">
        <div style="color:#fff;font-size:20px;font-weight:900;letter-spacing:-.25px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:${Math.max(280, W-320)}px">${esc(data.name)}</div>
        <div style="color:rgba(255,255,255,.72);font-size:11px;font-weight:700;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
          ğŸ“‹ ${esc(data.department)} Â· ğŸ†” ${esc(data.id)}
        </div>
      </div>
    </div>
    <div style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:#fff;border-radius:14px;padding:10px 14px;font-size:13px;font-weight:900;white-space:nowrap">
      ${esc(mName)}
    </div>
  `;
  wrap.appendChild(hdr);

  // Calendar clone
  const calWrap = document.createElement('div');
  calWrap.style.cssText = `padding:16px 16px 10px;background:#fff;`;
  const calClone = calEl.cloneNode(true);

  // Tune clone for image output
  calClone.style.cssText = `border-radius:18px; overflow:hidden; border:1px solid #e6ebf2; box-shadow:none;`;
  // make cells consistent
  calClone.querySelectorAll('.day').forEach(d=>{
    d.style.minHeight = '94px';
    d.style.boxShadow = 'none';
    d.style.transform = 'none';
  });
  calWrap.appendChild(calClone);
  wrap.appendChild(calWrap);

  // Legend (localized)
  const leg = document.createElement('div');
  leg.style.cssText = `padding:0 16px 14px; background:#fff; display:flex; flex-wrap:wrap; gap:8px;`;
  used.forEach(g=>{
    const c=COLORS[g]; if(!c) return;
    const item=document.createElement('span');
    item.style.cssText='display:inline-flex;align-items:center;gap:7px;border:1px solid #e6ebf2;background:#fff;border-radius:999px;padding:7px 10px;font-size:11px;font-weight:900;color:#64748b;white-space:nowrap';
    item.innerHTML=`<span style="width:10px;height:10px;border-radius:4px;background:${c.dot};display:inline-block"></span>${esc(T[lang].legend[g] || g)}`;
    leg.appendChild(item);
  });
  wrap.appendChild(leg);

  // Stats row
  const stWrap=document.createElement('div');
  stWrap.style.cssText='background:#f6f8fc;padding:14px 16px 18px;border-top:1px solid #eef2f7;';
  const stTitle=document.createElement('div');
  stTitle.style.cssText='font-size:10px;font-weight:1000;color:#94a3b8;text-transform:uppercase;letter-spacing:.9px;margin-bottom:10px';
  stTitle.textContent = t('statsTitle');
  stWrap.appendChild(stTitle);

  const stRow=document.createElement('div');
  stRow.style.cssText='display:flex;gap:10px;flex-wrap:wrap;';

  const statCards = [
    {k:'work',     c:'#1d4ed8'},
    {k:'off',      c:'#64748b'},
    {k:'morning',  c:'#b45309'},
    {k:'afternoon',c:'#c2410c'},
    {k:'night',    c:'#5b21b6'},
    {k:'standby',  c:'#be185d'},
    {k:'leaves',   c:'#15803d'}
  ];

  statCards.forEach(meta=>{
    const m = STAT_META.find(x=>x.k===meta.k);
    const label = (lang==='ar' ? m.label_ar : m.label_en);
    const box=document.createElement('div');
    box.style.cssText=`flex:1;min-width:140px;background:#fff;border:1px solid #e6ebf2;border-radius:16px;padding:12px 10px;text-align:center;border-top:4px solid ${meta.c};`;
    box.innerHTML=`<div style="font-size:22px;font-weight:1000;color:${meta.c};line-height:1">${stats[meta.k]}</div>
                   <div style="font-size:10px;font-weight:900;color:#94a3b8;margin-top:6px">${esc(label)}</div>`;
    stRow.appendChild(box);
  });
  stWrap.appendChild(stRow);
  wrap.appendChild(stWrap);

  document.body.appendChild(wrap);
  try{
    const canvas = await html2canvas(wrap, {scale:3, useCORS:true, backgroundColor:'#f6f8fc', logging:false});
    const a=document.createElement('a');
    a.download = `schedule-${data.id}-${month}-${lang}.png`;
    a.href = canvas.toDataURL('image/png');
    a.click();
  }catch(e){
    alert('Image capture failed: ' + e.message);
  }finally{
    document.body.removeChild(wrap);
  }
}

/* =========================
   ICS (same logic)
   ========================= */
function dlICS(){
  const sched=data.schedules[month] || [];
  const [yr,mo]=month.split('-').map(Number);
  const pad=n=>String(n).padStart(2,'0');
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//MySchedule//EN','CALSCALE:GREGORIAN'];
  sched.forEach(d=>{
    const dt=`${yr}${pad(mo)}${pad(d.day)}`;
    const dtNext=new Date(yr,mo-1,d.day+1);
    const dtE=`${dtNext.getFullYear()}${pad(dtNext.getMonth()+1)}${pad(dtNext.getDate())}`;
    const sum=d.shift_code||d.shift_group;
    lines.push('BEGIN:VEVENT',`DTSTART;VALUE=DATE:${dt}`,`DTEND;VALUE=DATE:${dtE}`,`SUMMARY:${sum}`,`UID:${dt}-${data.id}-${d.day}@myschedule`,'END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  const blob=new Blob([lines.join('\r\n')],{type:'text/calendar'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`schedule-${data.id}-${month}.ics`; a.click();
  URL.revokeObjectURL(a.href);
}

/* =========================
   PDF (kept from previous build â€” robust A4 output)
   ========================= */
function dlPDF(){
  if(!window.jspdf){ alert('PDF library loading, please try again.'); return; }
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});

  const W=210,H=297,ML=7,MR=7;
  const sched=data.schedules[month] || [];
  const [yr,mo]=month.split('-').map(Number);
  const mName=T.en.months[mo-1];
  const stats=calcStats(sched);

  const SC={Morning:{fg:[200,90,0],bg:[255,243,224]},Afternoon:{fg:[180,45,5],bg:[255,235,218]},Night:{fg:[20,55,190],bg:[224,230,255]},
            'Off Day':{fg:[85,95,115],bg:[238,240,245]},'Annual Leave':{fg:[10,125,60],bg:[218,248,230]},'Sick Leave':{fg:[10,125,60],bg:[218,248,230]},
            Training:{fg:[10,85,190],bg:[218,238,255]},Standby:{fg:[148,10,110],bg:[250,218,242]},Other:{fg:[90,100,115],bg:[240,241,246]}};
  const FALLBACK={'Off Day':'OFF','Annual Leave':'LV','Sick Leave':'SL',Training:'TR',Standby:'ST',Other:'â€”'};
  const LNAMES={Morning:'Morning',Afternoon:'Afternoon',Night:'Night','Off Day':'Day Off','Annual Leave':'Leave','Sick Leave':'Sick',Training:'Training',Standby:'Standby',Other:'Other'};
  const NAVY=[10,22,40],WHITE=[255,255,255],RULE=[195,202,215],EMPTY=[244,245,249],DIM=[105,115,132];

  const HDR_H=30,CAL_HDR=9,STATS_H=42,FOOT_H=10,GAP1=3,GAP2=4;
  const CAL_TOP=HDR_H+GAP1,STATS_TOP=H-FOOT_H-GAP2-STATS_H,CAL_BOT=STATS_TOP-GAP2,CAL_BODY=CAL_BOT-CAL_TOP-CAL_HDR;

  const firstDow=new Date(yr,mo-1,1).getDay(),dim=new Date(yr,mo,0).getDate();

  // rows
  let nRows=0;{
    let d2=1;
    for(let w=0;w<6;w++){
      let any=false;
      for(let d=0;d<7;d++){
        if(!((w===0&&d<firstDow)||d2>dim)){ any=true; d2++; }
      }
      if(any) nRows++;
      if(d2>dim) break;
    }
  }
  const CH=Math.floor(CAL_BODY/nRows), CW=(W-ML-MR)/7;

  // header
  doc.setFillColor(...NAVY); doc.rect(0,0,W,HDR_H,'F');
  doc.setTextColor(...WHITE); doc.setFontSize(17); doc.setFont(undefined,'bold'); doc.text(String(data.name),ML,13);
  doc.setFontSize(8.5); doc.setFont(undefined,'normal'); doc.setTextColor(165,188,235);
  doc.text(`${data.department}   Â·   ID: ${data.id}`,ML,21);

  doc.setFillColor(...WHITE);
  doc.roundedRect(W-MR-55,9,55,14,3,3,'F');
  doc.setTextColor(...NAVY); doc.setFontSize(10.5); doc.setFont(undefined,'bold');
  doc.text(`${mName}  ${yr}`,W-MR-27.5,18,{align:'center'});

  // day header
  doc.setFillColor(...NAVY); doc.rect(ML,CAL_TOP,W-ML-MR,CAL_HDR,'F');
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach((d,i)=>{
    doc.setTextColor(...WHITE); doc.setFontSize(8.5); doc.setFont(undefined,'bold');
    doc.text(d,ML+i*CW+CW/2,CAL_TOP+6.3,{align:'center'});
  });

  // cells
  let dc=1,row=0; doc.setLineWidth(0.22);
  for(let w=0;w<6;w++){
    for(let d=0;d<7;d++){
      const cx=ML+d*CW, cy=CAL_TOP+CAL_HDR+row*CH;
      const isEmpty=(w===0&&d<firstDow)||dc>dim;
      if(isEmpty){
        doc.setFillColor(...EMPTY); doc.setDrawColor(...RULE); doc.rect(cx,cy,CW,CH,'FD');
        continue;
      }
      const dd=sched.find(s=>s.day===dc), sh=dd?(SC[dd.shift_group]||SC.Other):null;
      doc.setFillColor(...(sh?sh.bg:WHITE)); doc.setDrawColor(...RULE); doc.rect(cx,cy,CW,CH,'FD');

      // ghost day number
      const numStr=String(dc);
      let ghostR,ghostG,ghostB;
      if(sh){
        ghostR=Math.round(sh.bg[0]*0.55+sh.fg[0]*0.45);
        ghostG=Math.round(sh.bg[1]*0.55+sh.fg[1]*0.45);
        ghostB=Math.round(sh.bg[2]*0.55+sh.fg[2]*0.45);
      }else{
        ghostR=210; ghostG=215; ghostB=225;
      }
      const ghostSize=Math.round(CH*0.72);
      doc.setTextColor(ghostR,ghostG,ghostB);
      doc.setFontSize(ghostSize>38?38:ghostSize<22?22:ghostSize);
      doc.setFont(undefined,'bold');
      doc.text(numStr,cx+2.5,cy+ghostSize*0.72,{align:'left'});

      if(dd){
        const code=dd.shift_code||(FALLBACK[dd.shift_group]||'');
        if(code){
          const fs=CH>=36?20:CH>=28?18:15;
          doc.setTextColor(...sh.fg);
          doc.setFontSize(fs);
          doc.setFont(undefined,'bold');
          doc.text(code,cx+CW/2,cy+CH*0.67,{align:'center'});
        }
      }
      dc++;
    }
    if(dc>dim) break;
    row++;
  }

  // stats footer
  doc.setDrawColor(...RULE); doc.setLineWidth(0.3); doc.line(ML,STATS_TOP,W-MR,STATS_TOP);
  doc.setTextColor(...NAVY); doc.setFontSize(8); doc.setFont(undefined,'bold'); doc.text('STATISTICS',ML,STATS_TOP+5);

  const SL=[
    {l:'Work Days',v:stats.work,c:NAVY},{l:'Day Off',v:stats.off,c:[85,95,115]},
    {l:'Morning',v:stats.morning,c:[200,90,0]},{l:'Afternoon',v:stats.afternoon,c:[180,45,5]},
    {l:'Night',v:stats.night,c:[20,55,190]},{l:'Standby',v:stats.standby,c:[148,10,110]},
    {l:'Leaves',v:stats.leaves,c:[10,125,60]}
  ];
  const nSt=SL.length, SGAP=2, sW=(W-ML-MR-(nSt-1)*SGAP)/nSt, CARD_Y=STATS_TOP+7, CARD_H=22;

  SL.forEach(({l,v,c},i)=>{
    const sx=ML+i*(sW+SGAP);
    doc.setFillColor(247,248,253);
    doc.setDrawColor(...RULE);
    doc.setLineWidth(0.2);
    doc.roundedRect(sx,CARD_Y,sW,CARD_H,2,2,'FD');
    doc.setFillColor(...c);
    doc.roundedRect(sx,CARD_Y,sW,3,1,1,'F');
    doc.setTextColor(...c);
    doc.setFontSize(18);
    doc.setFont(undefined,'bold');
    doc.text(String(v),sx+sW/2,CARD_Y+15,{align:'center'});
    doc.setTextColor(...DIM);
    doc.setFontSize(5.8);
    doc.setFont(undefined,'bold');
    doc.text(l,sx+sW/2,CARD_Y+20.5,{align:'center'});
  });

  const LY=CARD_Y+CARD_H+3;
  const used=[...new Set(sched.map(s=>s.shift_group))];
  const lStep=(W-ML-MR)/Math.max(used.length,1);

  used.forEach((g,i)=>{
    const sh2=SC[g]||SC.Other;
    const lx=ML+i*lStep;
    doc.setFillColor(...sh2.bg);
    doc.setDrawColor(...sh2.fg);
    doc.setLineWidth(0.5);
    doc.roundedRect(lx,LY,lStep-2,6,1.5,1.5,'FD');
    doc.setTextColor(...sh2.fg);
    doc.setFontSize(6.5);
    doc.setFont(undefined,'bold');
    doc.text(LNAMES[g]||g,lx+(lStep-2)/2,LY+4.1,{align:'center'});
  });

  // footer
  doc.setDrawColor(...RULE); doc.setLineWidth(0.25); doc.line(ML,H-6,W-MR,H-6);
  doc.setTextColor(...DIM); doc.setFontSize(7); doc.setFont(undefined,'normal');
  doc.text('My Schedule',ML,H-2.5);
  doc.text(`${mName} ${yr}  Â·  ${data.id}`,W-MR,H-2.5,{align:'right'});

  doc.save(`schedule-${data.id}-${month}.pdf`);
}

/* =========================
   SHARE
   ========================= */
function shareS(){
  const id=data.id;
  const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
  const url=`${location.origin}${base}my-schedules/?emp=${encodeURIComponent(id)}`;
  if(navigator.share){
    navigator.share({title:'My Schedule',text:`Schedule: ${data.name}`,url});
  }else{
    navigator.clipboard.writeText(url);
    alert(lang==='ar' ? 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· âœ…' : 'Link copied âœ…');
  }
}

/* =========================
   Init: auto-load saved / query
   ========================= */
applyLangUI();
const p=new URLSearchParams(location.search).get('emp');
if(p){
  document.getElementById('empId').value=p;
  loadSchedule(p);
}else{
  const saved=localStorage.getItem('savedEmpId');
  if(saved){
    document.getElementById('empId').value=saved;
    loadSchedule(saved);
  }
}
</script>
</body>
</html>
